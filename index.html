<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sales Store Map Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /***********************************************
     * HEADER
     ***********************************************/
    header {
      padding: 10px 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }

    .required-text {
      color: #dc2626;
      font-weight: 700;
      font-size: 11px;
      margin-left: 4px;
    }

    /***********************************************
     * BUTTONS
     ***********************************************/
    .primary-btn, .secondary-btn {
      border-radius: 12px;
      border: none;
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 6px;
      width: 100%;
      font-weight: 700;
    }

    .primary-btn {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
      transition: all .18s ease-out;
    }
    .primary-btn:hover {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(30, 64, 175, 0.45);
    }
    .primary-btn:disabled {
      background: #9db4e0 !important;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /***********************************************
     * MAIN LAYOUT
     ***********************************************/
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 320px;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    .store-panel,
    .dashboard-panel {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
    }

    #map { width: 100%; height: 100%; }

    /***********************************************
     * HISTORY TIMELINE
     ***********************************************/
    .timeline-item {
      position: relative;
      padding-left: 18px;
      margin-bottom: 12px;
    }
    .timeline-dot {
      width: 9px;
      height: 9px;
      background: #2563eb;
      border-radius: 999px;
      position: absolute;
      left: 0;
      top: 4px;
    }
    .timeline-date {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .timeline-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 12px;
    }
    .timeline-manager {
      font-size: 11px;
      color: #374151;
      font-weight: 700;
    }
    .timeline-memo {
      margin-top: 3px;
      font-size: 12px;
      color: #111827;
      white-space: pre-wrap;
    }

    /***********************************************
     * STORE LIST UI
     ***********************************************/
    .store-item {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 6px;
      cursor: pointer;
    }
    .store-item:hover {
      background: #f9fafb;
    }
    .store-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .store-name {
      font-size: 13px;
      font-weight: 700;
    }
    .store-meta-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
      color: #6b7280;
    }
    .store-meta-address {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .status-badge {
      background: #eef2ff;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px;
      color: #3730a3;
      font-weight: 600;
    }

  </style>
</head>

<body>

<header>
  <h1>ğŸ“ Sales Store Map</h1>

  <div class="header-controls" style="flex:1; display:flex; gap:8px;">
    <select id="statusFilterSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <select id="regionSelect" class="select-input">
      <option value="ALL">ì „ì²´ ì§€ì—­</option>
    </select>

    <input id="searchInput" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
  </div>
</header>

<div class="layout">
<!-- â–¼â–¼â–¼ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ -->
<style>
  .store-panel {
    background:#fff;
    border-right:1px solid #e5e7eb;
    overflow-y:auto;
  }

  .store-item {
    padding:10px;
    border-bottom:1px solid #f3f4f6;
    cursor:pointer;
    transition:0.15s;
  }
  .store-item:hover {
    background:#f9fafb;
  }

  .store-header {
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    font-weight:700;
    margin-bottom:4px;
  }

  .fav-icon {
    cursor:pointer;
    font-size:16px;
  }

  .store-meta-line {
    display:flex;
    gap:6px;
    font-size:12px;
    color:#6b7280;
    margin-bottom:3px;
  }

  .status-badge {
    padding:2px 6px;
    background:#eef2ff;
    border-radius:6px;
    font-size:11px;
    color:#4f46e5;
  }

  .store-meta-address {
    font-size:12px;
    color:#374151;
  }
</style>

<!-- â–¼â–¼â–¼ ë§ˆì»¤ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ -->
<style>
  .marker-dot {
    border:2px solid #fff;
    border-radius:50%;
  }

  .marker-selected {
    box-shadow:0 0 0 4px rgba(37,99,235,0.25);
  }
</style>

<!-- â–¼â–¼â–¼ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ â–¼â–¼â–¼ -->
<style>
.stat-card {
  background:#ffffff;
  padding:10px;
  border-radius:10px;
  border:1px solid #e5e7eb;
}
.stat-label {
  font-size:11px;
  color:#6b7280;
  margin-bottom:3px;
}
.stat-value {
  font-size:18px;
  font-weight:700;
}
.stat-sub {
  font-size:11px;
  color:#6b7280;
}
</style>

<!-- â–¼â–¼â–¼ ë§¤ì¥ ìƒì„¸ì •ë³´ â–¼â–¼â–¼ -->
<style>
.detail-title {
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
  margin-top:12px;
}
.info-item {
  font-size:12px;
  margin-bottom:4px;
}
.info-item span {
  display:inline-block;
  width:55px;
  font-weight:600;
  color:#374151;
}
</style>

<!-- â–¼â–¼â–¼ íˆìŠ¤í† ë¦¬ â–¼â–¼â–¼ -->
<style>
.history-section {
  margin-top:10px;
}
.history-header{
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
}
.history-empty {
  font-size:12px;
  color:#9ca3af;
  padding:6px;
}
.history-list {
  font-size:12px;
}
</style>

<script>
/*************************************************
 * ğŸ”‘ Apps Script WebApp URL
 *************************************************/
const BASE_URL = 
  "https://script.google.com/macros/s/AKfycbyTEpSlrv6vFRU4jwICu5ZM9z_xRBskTl5hxyjNZs1Wp1jXd1EzMEejnWGS0hHMKzWK/exec";

/*************************************************
 * ì „ì—­ ë³€ìˆ˜
 *************************************************/
let rawRows = [];
let rawByName = {};
let filteredRows = [];
let markersByName = {};
let markerCluster;
let selectedStoreName = null;

let map;
let chartInstance;

/*************************************************
 * DOM Ready
 *************************************************/
document.addEventListener("DOMContentLoaded", () => {
  initMap();
  initEvents();
  loadData();
});

/*************************************************
 * 1) ì§€ë„ ì •ìƒ ì´ˆê¸°í™”
 *************************************************/
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: true
  });

  // ì•ˆì „í•œ OSM íƒ€ì¼
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 35
  });
  map.addLayer(markerCluster);
}

/*************************************************
 * 2) ì´ë²¤íŠ¸ ë“±ë¡
 *************************************************/
function initEvents() {
  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("categorySelect").addEventListener("change", applyFilters);
  document.getElementById("statusFilterSelect").addEventListener("change", applyFilters);
  document.getElementById("regionSelect").addEventListener("change", applyFilters);
  document.getElementById("sortSelect").addEventListener("change", applyFilters);

  document.getElementById("statusSaveBtn").addEventListener("click", saveStatus);
  document.getElementById("memoSaveBtn").addEventListener("click", saveMemo);

  // ë‹´ë‹¹ì ì„ íƒ â†’ í•„ìˆ˜ê°’ + ìë™ ê¸°ë¡
  const managerSelect = document.getElementById("managerInput");
  managerSelect.addEventListener("change", () => {
    const manager = managerSelect.value;
    const hasManager = manager !== "";

    document.getElementById("statusSaveBtn").disabled = !hasManager;
    document.getElementById("memoSaveBtn").disabled = !hasManager;

    if (selectedStoreName && hasManager) {
      addManagerHistory(manager);
    }
  });
}

/*************************************************
 * 3) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
 *************************************************/
async function loadData() {
  try {
    const res = await fetch(`${BASE_URL}?action=places`);
    const json = await res.json();

    rawRows = json
      .filter(r => r.lat && r.lng)
      .map(r => ({
        ...r,
        lat: Number(r.lat),
        lng: Number(r.lng),
        favorite: r.favorite === true || r.favorite === "TRUE"
      }));

    rawByName = {};
    rawRows.forEach(r => rawByName[r.name] = r);

    buildFilters(rawRows);
    applyFilters();
  } catch (e) {
    alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!");
    console.error(e);
  }
}

/*************************************************
 * 4) í•„í„° UI êµ¬ì„±
 *************************************************/
function buildFilters(rows) {
  const catSet = new Set();
  const statusSet = new Set();
  const regionSet = new Set();

  rows.forEach(r => {
    if (r.category) catSet.add(r.category.split(">")[0].trim());
    if (r.Status) statusSet.add(r.Status);
    if (r.sigungu) regionSet.add(r.sigungu);
  });

  fillSelect("categorySelect", "ì „ì²´ ì¹´í…Œê³ ë¦¬", [...catSet]);
  fillSelect("statusFilterSelect", "ì „ì²´ ìƒíƒœ", [...statusSet]);
  fillSelect("regionSelect", "ì „ì²´ ì§€ì—­", [...regionSet]);
}

function fillSelect(id, label, arr) {
  const el = document.getElementById(id);
  el.innerHTML = `<option value="ALL">${label}</option>`;
  arr.sort().forEach(v => el.insertAdjacentHTML("beforeend", `<option value="${v}">${v}</option>`));
}

/*************************************************
 * 5) í•„í„° ì ìš©
 *************************************************/
function applyFilters() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusFilterSelect").value;
  const region = document.getElementById("regionSelect").value;
  const sortMode = document.getElementById("sortSelect").value;

  filteredRows = rawRows.filter(r => {
    const text = `${r.name} ${r.roadAddress} ${r.keyword}`.toLowerCase();
    const major = (r.category || "").split(">")[0].trim();

    return (!q || text.includes(q)) &&
      (cat === "ALL" || major === cat) &&
      (st === "ALL" || r.Status === st) &&
      (region === "ALL" || r.sigungu === region);
  });

  filteredRows = sortStores(filteredRows, sortMode);

  renderAll();
}

/*************************************************
 * 6) ì •ë ¬
 *************************************************/
function sortStores(list, mode) {
  return [...list].sort((a, b) => {
    if (mode === "name") return (a.name || "").localeCompare(b.name || "", "ko");
    if (mode === "blog") return Number(b.blog_count || 0) - Number(a.blog_count || 0);

    // Default: ì¦ê²¨ì°¾ê¸° â†’ ìƒíƒœ â†’ ì´ë¦„
    if (a.favorite !== b.favorite) return a.favorite ? -1 : 1;
    if (a.Status !== b.Status) return (a.Status || "").localeCompare(b.Status || "", "ko");
    return (a.name || "").localeCompare(b.name || "", "ko");
  });
}

/*************************************************
 * 7) ì „ì²´ ë Œë”ë§
 *************************************************/
function renderAll() {
  renderMarkers();
  renderStoreList();
  renderStats();
}
</script>

  <script>
/*************************************************
 * 8) ë§ˆì»¤ ì•„ì´ì½˜
 *************************************************/
function createMarkerIcon(status, favorite = false, selected = false) {
  const STATUS_COLOR = {
    "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
    "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
    "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
    "ê±°ì ˆ": "#e74c3c"
  };

  const color = STATUS_COLOR[status] || "#7f8c8d";
  const size = selected ? 22 : 16;
  const borderColor = favorite ? "#fbbf24" : "#ffffff";

  return L.divIcon({
    className: "custom-marker",
    html: `
      <div class="marker-dot"
           style="
              background:${color};
              border:2px solid ${borderColor};
              width:${size}px;
              height:${size}px;
              border-radius:50%;
           ">
      </div>`,
    iconSize: [size + 4, size + 4],
    iconAnchor: [(size + 4) / 2, (size + 4) / 2]
  });
}

/*************************************************
 * 9) ë§ˆì»¤ ë Œë”ë§
 *************************************************/
function renderMarkers() {
  markerCluster.clearLayers();
  markersByName = {};

  filteredRows.forEach(store => {
    const marker = L.marker([store.lat, store.lng], {
      icon: createMarkerIcon(store.Status, store.favorite, store.name === selectedStoreName)
    });

    marker.bindTooltip(store.name, { direction: "top", offset: [0, -8] });
    marker.on("click", () => focusOnStore(store));

    markerCluster.addLayer(marker);
    markersByName[store.name] = marker;
  });

  if (filteredRows.length > 0) {
    const group = L.featureGroup(markerCluster.getLayers());
    map.fitBounds(group.getBounds().pad(0.15));
  }
}

/*************************************************
 * 10) ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ UI
 *************************************************/
function renderStoreList() {
  const listEl = document.getElementById("storeList");
  listEl.innerHTML = "";

  filteredRows.slice(0, 500).forEach(store => {
    const li = document.createElement("li");
    li.className = "store-item";

    const major = (store.category || "").split(">")[0] || "-";

    li.innerHTML = `
      <div class="store-header">
        <span class="fav-icon">${store.favorite ? "â­" : "â˜†"}</span>
        <div class="store-name">${store.name}</div>
      </div>
      <div class="store-meta-line">
        <span class="status-badge">${store.Status || "ìƒíƒœ ì—†ìŒ"}</span>
        <span class="meta-text">${store.sigungu || ""} Â· ${major}</span>
      </div>
      <div class="store-meta-address">${store.roadAddress || ""}</div>
    `;

    li.addEventListener("click", () => focusOnStore(store));

    li.querySelector(".fav-icon").addEventListener("click", e => {
      e.stopPropagation();
      toggleFavorite(store);
    });

    listEl.appendChild(li);
  });
}

/*************************************************
 * 11) ë§¤ì¥ í´ë¦­ ì‹œ ìƒì„¸ì •ë³´ í‘œì‹œ
 *************************************************/
function focusOnStore(store) {
  selectedStoreName = store.name;

  map.setView([store.lat, store.lng], 17);

  Object.keys(markersByName).forEach(name => {
    const row = rawByName[name];
    markersByName[name].setIcon(
      createMarkerIcon(row.Status, row.favorite, name === selectedStoreName)
    );
  });

  showStoreDetail(store);
  setStatusDropdown(store);
  loadHistory(store.name);
}

/*************************************************
 * 12) ìƒì„¸ì •ë³´ í‘œì‹œ
 *************************************************/
function showStoreDetail(r) {
  const box = document.getElementById("storeDetailBody");
  const major = (r.category || "").split(">")[0];

  let url = r.URL || r.url;
  if (url && !url.startsWith("http")) url = "https://" + url;

  box.innerHTML = `
    <div class="detail-name">${r.name}</div>
    <div class="info-item"><span>ğŸ  ì£¼ì†Œ</span>${r.roadAddress || "-"}</div>
    <div class="info-item"><span>ğŸ“ ì§€ì—­</span>${r.sigungu || "-"}</div>
    <div class="info-item"><span>ğŸ½ ì—…ì¢…</span>${major}</div>
    <div class="info-item"><span>â­ ìƒíƒœ</span>${r.Status || "-"}</div>
    <div class="info-item"><span>ğŸ”— ë§í¬</span>${url ? `<a href="${url}" target="_blank">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤</a>` : "-"}</div>
  `;
}

/*************************************************
 * 13) ìƒíƒœ ì„ íƒ ìë™ ë°˜ì˜
 *************************************************/
function setStatusDropdown(store) {
  document.getElementById("statusChangeSelect").value = store?.Status || "";
}

/*************************************************
 * 14) ìƒíƒœ ë³€ê²½ â†’ íˆìŠ¤í† ë¦¬ ìë™ ê¸°ë¡
 *************************************************/
function saveStatus() {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const manager = document.getElementById("managerInput").value;
  if (!manager) return alert("ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");

  const newStatus = document.getElementById("statusChangeSelect").value;
  if (!newStatus) return alert("ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”.");

  const memoText = `ìƒíƒœë¥¼ '${newStatus}'ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`;
  const now = new Date().toLocaleString("ko-KR");

  // UI ì¦‰ì‹œ ë°˜ì˜
  insertHistoryUI(now, manager, memoText);

  // GAS â€” ìƒíƒœ ì—…ë°ì´íŠ¸
  fetch(`${BASE_URL}?action=updateStatus&name=${encodeURIComponent(selectedStoreName)}&status=${encodeURIComponent(newStatus)}`);

  // GAS â€” íˆìŠ¤í† ë¦¬ ê¸°ë¡
  fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(memoText)}&manager=${encodeURIComponent(manager)}`);

  rawByName[selectedStoreName].Status = newStatus;
  applyFilters();
}

/*************************************************
 * 15) íˆìŠ¤í† ë¦¬ ë¡œë“œ
 *************************************************/
function loadHistory(name) {
  const listEl = document.getElementById("historyList");
  listEl.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  fetch(`${BASE_URL}?action=history&name=${encodeURIComponent(name)}`)
    .then(res => res.json())
    .then(items => {
      if (!items.length) {
        listEl.innerHTML = "íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      listEl.innerHTML = items
        .map(it => {
          return `
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-date">${it.date}</div>
              <div class="timeline-card">
                <div class="timeline-manager">${it.manager}</div>
                <div class="timeline-memo">${it.memo}</div>
              </div>
            </div>
          `;
        })
        .join("");
    });
}

/*************************************************
 * 16) ë©”ëª¨ ì €ì¥
 *************************************************/
function saveMemo() {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
  const manager = document.getElementById("managerInput").value;
  if (!manager) return alert("ë‹´ë‹¹ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const memo = document.getElementById("memoInput").value.trim();
  if (!memo) return alert("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  const now = new Date().toLocaleString("ko-KR");

  insertHistoryUI(now, manager, memo);

  fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(memo)}&manager=${encodeURIComponent(manager)}`);

  document.getElementById("memoInput").value = "";
}

/*************************************************
 * 17) ì¦ê²¨ì°¾ê¸°
 *************************************************/
function toggleFavorite(store) {
  store.favorite = !store.favorite;
  rawByName[store.name].favorite = store.favorite;
  applyFilters();

  fetch(`${BASE_URL}?action=favorite&name=${encodeURIComponent(store.name)}&fav=${store.favorite ? "TRUE" : "FALSE"}`);
}

/*************************************************
 * 18) ë‹´ë‹¹ì ìë™ íˆìŠ¤í† ë¦¬ ê¸°ë¡
 *************************************************/
function addManagerHistory(manager) {
  const memoText = `ë‹´ë‹¹ìë¥¼ ${manager}ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`;
  const now = new Date().toLocaleString("ko-KR");

  insertHistoryUI(now, manager, memoText);

  fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(memoText)}&manager=${encodeURIComponent(manager)}`);
}

/*************************************************
 * ğŸ”¥ ê³µí†µ íˆìŠ¤í† ë¦¬ UI ì‚½ì… í•¨ìˆ˜
 *************************************************/
function insertHistoryUI(date, manager, memo) {
  const listEl = document.getElementById("historyList");

  listEl.insertAdjacentHTML(
    "afterbegin",
    `
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-date">${date}</div>
        <div class="timeline-card">
          <div class="timeline-manager">${manager}</div>
          <div class="timeline-memo">${memo}</div>
        </div>
      </div>
    `
  );
}
</script>
