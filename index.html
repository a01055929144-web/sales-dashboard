<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Sales Store Map Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet & MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: #f3f4f6;
    color: #111827;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 10px 16px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  header h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    white-space: nowrap;
  }
  .header-controls {
    display: flex;
    gap: 8px;
    flex: 1;
    align-items: center;
    position: relative;
  }
  .search-input,
  .select-input {
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    padding: 6px 12px;
    font-size: 13px;
    outline: none;
    background: #f9fafb;
  }
  .search-input { flex: 1; }

  .layout {
    flex: 1;
    display: grid;
    grid-template-columns: 280px minmax(0, 1fr) 260px;
    height: calc(100vh - 52px);
    overflow: hidden;
  }

  .store-panel {
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    padding: 12px;
    overflow-y: auto;
  }
  .store-list { list-style: none; margin: 0; padding: 0; }
  .store-item {
    padding: 8px 6px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid transparent;
  }
  .store-item:hover {
    background: #f3f4ff;
    border-color: #e0e7ff;
  }

  #map { width: 100%; height: 100%; }

  .dashboard-panel {
    background: #ffffff;
    border-left: 1px solid #e5e7eb;
    padding: 12px;
    overflow-y: auto;
  }

  .autocomplete {
    position: absolute;
    background: white;
    border: 1px solid #e5e7eb;
    width: 260px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 50;
    border-radius: 8px;
    display: none;
  }
  .autocomplete-item {
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
  }
  .autocomplete-item:hover { background: #f3f4f6; }

  .marker-dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
    animation: pop 0.3s ease-out;
  }
  @keyframes pop {
    0% { transform: scale(0.2); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .store-detail {
    margin-top: 15px;
    padding: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    font-size: 13px;
  }
  .store-detail h3 { margin: 0 0 8px; font-size: 15px; }
</style>
</head>
<body>

<header>
  <h1>ğŸ“ Sales Store Map Dashboard</h1>
  <div class="header-controls">

    <select id="statusSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="ë§¤ì¥ëª… / ì§€ì—­ / ë„ë¡œëª…ì£¼ì†Œ / í‚¤ì›Œë“œ ê²€ìƒ‰"
    />

    <div id="autocomplete" class="autocomplete"></div>
  </div>
</header>

<div class="layout">
  <aside class="store-panel">
    <h2>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ <span class="store-count" id="storeCountLabel"></span></h2>
    <ul id="storeList" class="store-list"></ul>
  </aside>

  <main><div id="map"></div></main>

  <aside class="dashboard-panel">
    <div class="dashboard-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
    <canvas id="statusChart" style="width:100%; height:180px;"></canvas>

    <div id="storeDetail" class="store-detail"></div>
  </aside>
</div>

<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* â­ WebApp URL */
const API_URL =
  "https://script.google.com/macros/s/AKfycbz3V3zX-zdYbwajKaZjktsClGesOFEoTHqDsHHFrWdr6BdbYmgDPaXiNbYH5gNNtTVv/exec?action=places";

let rawRows = [];
let filteredRows = [];
let map, markerCluster, chartInstance;

/* ìƒíƒœ ìƒ‰ìƒ */
const STATUS_COLOR = {
  "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
  "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
  "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
  "ê±°ì ˆ": "#e74c3c"
};

/* ì´ˆê¸° ë¡œë“œ */
window.addEventListener("load", async () => {
  initMap();
  initEvents();
  loadFilters();
  await loadData();
});

/* ì§€ë„ */
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: true
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 40
  });
  map.addLayer(markerCluster);
}

function initEvents() {
  document.getElementById("searchInput").addEventListener("input", () => {
    applyFilters();
    saveFilters();
    showAutocomplete();
  });
  document.getElementById("categorySelect").addEventListener("change", () => {
    applyFilters(); saveFilters();
  });
  document.getElementById("statusSelect").addEventListener("change", () => {
    applyFilters(); saveFilters();
  });
}

/* ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadData() {
  const res = await fetch(API_URL);
  const json = await res.json();

  rawRows = json.filter(r => r.lat && r.lng);

  buildFilters(rawRows);  // â­ ëˆ„ë½ëë˜ í•¨ìˆ˜
  applyFilters();
}

/* ğŸ”§ í•„í„° ëª©ë¡ ìƒì„± â€” â˜… í•µì‹¬! */
function buildFilters(rows) {
  const statusSet = new Set();
  const categorySet = new Set();

  rows.forEach(r => {
    if (r.Status) statusSet.add(r.Status);
    if (r.category) categorySet.add(r.category.split(">")[0].trim());
  });

  const statusSelect = document.getElementById("statusSelect");
  const categorySelect = document.getElementById("categorySelect");

  [...statusSet].sort().forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    statusSelect.appendChild(opt);
  });

  [...categorySet].sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    categorySelect.appendChild(opt);
  });
}

/* ìë™ì™„ì„± */
function showAutocomplete() {
  const ac = document.getElementById("autocomplete");
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  if (!q) { ac.style.display = "none"; return; }

  const matched = rawRows.filter(r =>
    (r.name || "").toLowerCase().includes(q) ||
    (r.roadAddress || "").toLowerCase().includes(q) ||
    (r.keyword || "").toLowerCase().includes(q)
  ).slice(0, 10);

  ac.innerHTML = matched.map(r =>
    `<div class="autocomplete-item">${r.name}</div>`
  ).join("");

  ac.style.display = matched.length ? "block" : "none";

  document.querySelectorAll(".autocomplete-item").forEach((el, i) => {
    el.addEventListener("click", () => {
      document.getElementById("searchInput").value = matched[i].name;
      ac.style.display = "none";
      map.setView([matched[i].lat, matched[i].lng], 17);
      showStoreDetail(matched[i]);
      applyFilters();
    });
  });
}

/* í•„í„° ì ìš© */
function applyFilters() {
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusSelect").value;

  filteredRows = rawRows.filter(r => {
    const text = `${r.name} ${r.sigungu} ${r.roadAddress} ${r.keyword}`.toLowerCase();
    const matchSearch = !q || text.includes(q);

    const major = (r.category || "").split(">")[0].trim();
    const matchCat = cat === "ALL" || major === cat;
    const matchStatus = st === "ALL" || r.Status === st;

    return matchSearch && matchCat && matchStatus;
  });

  renderAll();
}

/* ì „ì²´ ë Œë”ë§ */
function renderAll() {
  renderMarkers();
  renderStoreList();
  renderStats();
}

/* ë§ˆì»¤ */
function createMarkerIcon(status) {
  return L.divIcon({
    className: "custom-marker",
    html: `<div class="marker-dot" style="background:${STATUS_COLOR[status] || "#7f8c8d"}"></div>`,
    iconSize: [18, 18], iconAnchor: [9, 9]
  });
}

function renderMarkers() {
  markerCluster.clearLayers();
  filteredRows.forEach(r => {
    const marker = L.marker([r.lat, r.lng], {
      icon: createMarkerIcon(r.Status)
    });
    markerCluster.addLayer(marker);
  });
}

/* ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ */
function renderStoreList() {
  const list = document.getElementById("storeList");
  list.innerHTML = "";
  document.getElementById("storeCountLabel").textContent =
    `${filteredRows.length}ê°œ`;

  filteredRows.slice(0, 300).forEach(r => {
    const li = document.createElement("li");
    li.className = "store-item";

    li.innerHTML = `
      <div class="store-name">${r.name}</div>
      <div class="store-meta">${r.sigungu} Â· ${(r.category || "").split(">")[0]} Â· ${r.Status}</div>
      <div class="store-meta">${r.roadAddress}</div>
    `;

    li.addEventListener("click", () => {
      map.setView([r.lat, r.lng], 17);
      showStoreDetail(r);
    });

    list.appendChild(li);
  });
}

/* ìƒì„¸ ì •ë³´ */
function showStoreDetail(r) {
  const box = document.getElementById("storeDetail");
  box.innerHTML = `
    <h3>${r.name}</h3>
    <div><strong>ì£¼ì†Œ:</strong> ${r.roadAddress}</div>
    <div><strong>ìƒíƒœ:</strong> ${r.Status}</div>
    <div><strong>ì¹´í…Œê³ ë¦¬:</strong> ${(r.category || "").split(">")[0]}</div>
    <div><strong>ë¸”ë¡œê·¸ ìˆ˜:</strong> ${r.blog_count}</div>
    <div><strong>í‚¤ì›Œë“œ:</strong> ${r.keyword}</div>
    ${r.URL ? `<div><a href="${r.URL}" target="_blank">ë§¤ì¥ ë§í¬</a></div>` : ""}
  `;
}

/* ì°¨íŠ¸ */
function renderStats() {
  const stats = { deal: 0, meetingDone: 0, request: 0, noAnswer: 0, reject: 0 };

  filteredRows.forEach(r => {
    if (r.Status === "ê±°ë˜ ì„±ì‚¬") stats.deal++;
    else if (r.Status === "ë¯¸íŒ… ì™„ë£Œ") stats.meetingDone++;
    else if (r.Status === "ë¯¸íŒ… ìš”ì²­") stats.request++;
    else if (r.Status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") stats.noAnswer++;
    else if (r.Status === "ê±°ì ˆ") stats.reject++;
  });

  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById("statusChart");

  chartInstance = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["ê±°ë˜ ì„±ì‚¬", "ë¯¸íŒ… ì™„ë£Œ", "ë¯¸íŒ… ìš”ì²­", "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ", "ê±°ì ˆ"],
      datasets: [{
        data: [
          stats.deal, stats.meetingDone, stats.request,
          stats.noAnswer, stats.reject
        ],
        backgroundColor: ["#2ecc71","#3498db","#f1c40f","#95a5a6","#e74c3c"]
      }]
    },
    options: {
      cutout: "60%", responsive: true,
      plugins: { legend: { position: "bottom" } }
    }
  });
}

/* ì €ì¥ */
function saveFilters() {
  localStorage.setItem("filterStatus", document.getElementById("statusSelect").value);
  localStorage.setItem("filterCategory", document.getElementById("categorySelect").value);
  localStorage.setItem("filterSearch", document.getElementById("searchInput").value);
}

/* ë¶ˆëŸ¬ì˜¤ê¸° */
function loadFilters() {
  const st = localStorage.getItem("filterStatus");
  const cat = localStorage.getItem("filterCategory");
  const q = localStorage.getItem("filterSearch");

  if (st) document.getElementById("statusSelect").value = st;
  if (cat) document.getElementById("categorySelect").value = cat;
  if (q) document.getElementById("searchInput").value = q;
}

</script>
</body>
</html>
