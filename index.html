<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Sales Store Map Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet & MarkerCluster -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
      system-ui, sans-serif;
    background: #f3f4f6;
    color: #111827;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ìƒë‹¨ ë°” */
  header {
    padding: 10px 16px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  header h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    white-space: nowrap;
  }
  .header-controls {
    display: flex;
    gap: 8px;
    flex: 1;
    align-items: center;
  }
  .search-input,
  .select-input {
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    padding: 6px 12px;
    font-size: 13px;
    outline: none;
    background: #f9fafb;
  }
  .search-input {
    flex: 1;
  }
  .select-input {
    min-width: 140px;
  }

  .dashboard-toggle {
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    padding: 6px 10px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
  .layout {
    flex: 1;
    display: grid;
    grid-template-columns: 280px minmax(0, 1fr) 260px;
    height: calc(100vh - 52px);
    overflow: hidden;
  }

  /* ì™¼ìª½ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ */
  .store-panel {
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    padding: 12px;
    overflow-y: auto;
  }
  .store-panel h2 {
    font-size: 14px;
    margin: 0 0 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .store-count {
    font-size: 11px;
    color: #6b7280;
  }
  .store-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .store-item {
    padding: 8px 6px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid transparent;
    margin-bottom: 4px;
  }
  .store-item:hover {
    background: #f3f4ff;
    border-color: #e0e7ff;
  }
  .store-name {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 2px;
  }
  .store-meta {
    font-size: 11px;
    color: #6b7280;
  }
  .store-url {
    font-size: 11px;
    color: #2563eb;
    text-decoration: none;
  }

  /* ì§€ë„ */
  #map {
    width: 100%;
    height: 100%;
  }

  /* ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ */
  .dashboard-panel {
    background: #ffffff;
    border-left: 1px solid #e5e7eb;
    padding: 12px;
    overflow-y: auto;
    transition: transform 0.2s ease;
  }
  .dashboard-panel.hidden {
    transform: translateX(100%);
  }
  .dashboard-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 8px;
  }
  .stat-card {
    padding: 8px 10px;
    border-radius: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
  }
  .stat-label {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 4px;
  }
  .stat-value {
    font-size: 15px;
    font-weight: 700;
  }

  .legend {
    margin-top: 8px;
    border-top: 1px solid #e5e7eb;
    padding-top: 8px;
  }
  .legend-title {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    margin-bottom: 2px;
  }
  .legend-color {
    width: 10px;
    height: 10px;
    border-radius: 999px;
  }

  /* ì»¤ìŠ¤í…€ ë§ˆì»¤ */
  .custom-marker {
    border-radius: 999px;
    background: transparent;
  }
  .marker-dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
  }

  /* ìŠ¤í¬ë¡¤ë°” ì•½í•˜ê²Œ */
  .store-panel::-webkit-scrollbar,
  .dashboard-panel::-webkit-scrollbar {
    width: 6px;
  }
  .store-panel::-webkit-scrollbar-thumb,
  .dashboard-panel::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 999px;
  }

  @media (max-width: 1024px) {
    .layout {
      grid-template-columns: 0 minmax(0, 1fr) 0;
    }
    .store-panel {
      display: none;
    }
    .dashboard-panel {
      position: absolute;
      right: 0;
      top: 52px;
      bottom: 0;
      width: 260px;
      z-index: 20;
      box-shadow: -4px 0 12px rgba(0,0,0,0.08);
    }
  }
</style>
</head>
<body>
<header>
  <h1>ğŸ“ Sales Store Map Dashboard</h1>
  <div class="header-controls">
    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="ë§¤ì¥ëª… / ì§€ì—­ / ë„ë¡œëª…ì£¼ì†Œ / í‚¤ì›Œë“œ ê²€ìƒ‰"
    />
    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>
    <select id="statusSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>
  </div>
  <button id="dashboardToggle" class="dashboard-toggle">
    ğŸ“Š ëŒ€ì‹œë³´ë“œ ì ‘ê¸°
  </button>
</header>

<div class="layout">
  <!-- ì™¼ìª½: ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
  <aside class="store-panel">
    <h2>
      â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸
      <span class="store-count" id="storeCountLabel"></span>
    </h2>
    <ul id="storeList" class="store-list"></ul>
  </aside>

  <!-- ê°€ìš´ë°: ì§€ë„ -->
  <main>
    <div id="map"></div>
  </main>

  <!-- ì˜¤ë¥¸ìª½: ëŒ€ì‹œë³´ë“œ -->
  <aside id="dashboardPanel" class="dashboard-panel">
    <div class="dashboard-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">ì´ ë§¤ì¥ ìˆ˜ (í•„í„° ê¸°ì¤€)</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ê±°ë˜ ì„±ì‚¬</div>
        <div class="stat-value" id="statDeal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¯¸íŒ… ì™„ë£Œ</div>
        <div class="stat-value" id="statMeetingDone">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¯¸íŒ… ìš”ì²­</div>
        <div class="stat-value" id="statRequest">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¶€ì¬ì¤‘ / ë¯¸ì‘ë‹µ</div>
        <div class="stat-value" id="statNoAnswer">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ê±°ì ˆ</div>
        <div class="stat-value" id="statReject">0</div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-title">ë§ˆì»¤ ìƒ‰ìƒ (Status)</div>
      <div class="legend-item">
        <span class="legend-color" style="background:#2ecc71"></span>ê±°ë˜ ì„±ì‚¬
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background:#3498db"></span>ë¯¸íŒ… ì™„ë£Œ
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background:#f1c40f"></span>ë¯¸íŒ… ìš”ì²­
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background:#95a5a6"></span>ë¶€ì¬ì¤‘ / ë¯¸ì‘ë‹µ
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background:#e74c3c"></span>ê±°ì ˆ
      </div>
    </div>
  </aside>
</div>

<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// â­ Apps Script WebApp URL
const API_URL =
  "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

let rawRows = [];
let filteredRows = [];
let map, markerCluster;

// ìƒíƒœë³„ ìƒ‰ìƒ
const STATUS_COLOR = {
  "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
  "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
  "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
  "ê±°ì ˆ": "#e74c3c"
};

// ì´ˆê¸°í™”
window.addEventListener("load", async () => {
  initMap();
  initEvents();
  await loadData();
});

// ì§€ë„ ìƒì„±
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: true
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 40
  });
  map.addLayer(markerCluster);
}

// ì´ë²¤íŠ¸
function initEvents() {
  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("categorySelect").addEventListener("change", applyFilters);
  document.getElementById("statusSelect").addEventListener("change", applyFilters);

  const toggleBtn = document.getElementById("dashboardToggle");
  const dashboardPanel = document.getElementById("dashboardPanel");
  toggleBtn.addEventListener("click", () => {
    dashboardPanel.classList.toggle("hidden");
    toggleBtn.textContent = dashboardPanel.classList.contains("hidden")
      ? "ğŸ“Š ëŒ€ì‹œë³´ë“œ ì—´ê¸°"
      : "ğŸ“Š ëŒ€ì‹œë³´ë“œ ì ‘ê¸°";
  });
}

// ë°ì´í„° ë¡œë“œ
async function loadData() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();

    console.log("ğŸ“Œ ì›ë³¸ ë°ì´í„°", json.slice(0, 3));

    rawRows = json.filter(r => r.lat && r.lng); // ìœ„ì¹˜ ìˆëŠ” ê²ƒë§Œ
    console.log("ğŸ“Œ ê³ ìœ  Status ê°’:", Array.from(new Set(rawRows.map(r => r.Status))));

    buildFilters(rawRows);
    filteredRows = rawRows;
    renderAll();

  } catch (e) {
    console.error("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", e);
    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

// í•„í„° ì˜µì…˜ êµ¬ì„±
function buildFilters(rows) {
  const categorySelect = document.getElementById("categorySelect");
  const statusSelect = document.getElementById("statusSelect");

  const categorySet = new Set();
  const statusSet = new Set();

  rows.forEach(r => {
    if (r.category) {
      const major = r.category.split(">")[0].trim();
      categorySet.add(major);
    }
    if (r.Status) {
      statusSet.add(r.Status);
    }
  });

  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  categorySelect.innerHTML = '<option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>';
  Array.from(categorySet).sort().forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });

  // ìƒíƒœ ì˜µì…˜
  statusSelect.innerHTML = '<option value="ALL">ì „ì²´ ìƒíƒœ</option>';
  Array.from(statusSet).forEach(st => {
    const opt = document.createElement("option");
    opt.value = st;
    opt.textContent = st;
    statusSelect.appendChild(opt);
  });
}

// í•„í„° ì ìš©
function applyFilters() {
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusSelect").value;

  filteredRows = rawRows.filter(r => {
    // ê²€ìƒ‰
    const text =
      (r.name || "") +
      " " +
      (r.sigungu || "") +
      " " +
      (r.roadAddress || "") +
      " " +
      (r.keyword || "");
    const matchSearch = !q || text.toLowerCase().includes(q);

    // ì¹´í…Œê³ ë¦¬(ëŒ€ë¶„ë¥˜)
    let major = "ê¸°íƒ€";
    if (r.category) {
      major = r.category.split(">")[0].trim();
    }
    const matchCat = cat === "ALL" || major === cat;

    // ìƒíƒœ
    const matchStatus = st === "ALL" || (r.Status || "") === st;

    return matchSearch && matchCat && matchStatus;
  });

  renderAll();
}

// ë Œë”ë§ ì „ì²´
function renderAll() {
  renderMarkers(filteredRows);
  renderStoreList(filteredRows);
  renderStats(filteredRows);
}

// ë§ˆì»¤ ì•„ì´ì½˜
function createMarkerIcon(status) {
  const color = STATUS_COLOR[status] || "#7f8c8d";
  return L.divIcon({
    className: "custom-marker",
    html: `<div class="marker-dot" style="background:${color}"></div>`,
    iconSize: [18, 18],
    iconAnchor: [9, 9]
  });
}

// ë§ˆì»¤ ë Œë”ë§
function renderMarkers(rows) {
  markerCluster.clearLayers();

  rows.forEach(r => {
    const lat = Number(r.lat);
    const lng = Number(r.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const marker = L.marker([lat, lng], {
      icon: createMarkerIcon(r.Status)
    });

    const html = `
      <div style="font-size:12px;">
        <div style="font-weight:600;margin-bottom:4px;">${r.name || "ë§¤ì¥"}</div>
        <div>${r.roadAddress || ""}</div>
        ${r.Status ? `<div style="margin-top:4px;">ìƒíƒœ: ${r.Status}</div>` : ""}
        ${r.URL ? `<div style="margin-top:4px;"><a href="${r.URL}" target="_blank">ë°”ë¡œê°€ê¸°</a></div>` : ""}
      </div>
    `;
    marker.bindPopup(html);
    markerCluster.addLayer(marker);
  });

  if (rows.length > 0) {
    const group = L.featureGroup(markerCluster.getLayers());
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

// ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderStoreList(rows) {
  const listEl = document.getElementById("storeList");
  const countLabel = document.getElementById("storeCountLabel");
  listEl.innerHTML = "";

  countLabel.textContent = `${rows.length.toLocaleString()}ê°œ ë§¤ì¥`;

  rows.slice(0, 300).forEach(r => {
    const li = document.createElement("li");
    li.className = "store-item";

    li.innerHTML = `
      <div class="store-name">${r.name || "ë§¤ì¥ëª… ì—†ìŒ"}</div>
      <div class="store-meta">
        ${(r.sigungu || "")} Â· ${(r.category || "").split(">")[0] || ""}
        ${r.Status ? " Â· " + r.Status : ""}
      </div>
      <div class="store-meta">${r.roadAddress || ""}</div>
      ${r.URL ? `<a class="store-url" href="${r.URL}" target="_blank">ë°”ë¡œê°€ê¸°</a>` : ""}
    `;

    li.addEventListener("click", () => {
      if (r.lat && r.lng) {
        map.setView([Number(r.lat), Number(r.lng)], 16);
      }
    });

    listEl.appendChild(li);
  });
}

// ëŒ€ì‹œë³´ë“œ í†µê³„ ë Œë”ë§
function renderStats(rows) {
  const stats = {
    total: rows.length,
    deal: 0,          // ê±°ë˜ ì„±ì‚¬
    meetingDone: 0,   // ë¯¸íŒ… ì™„ë£Œ
    request: 0,       // ë¯¸íŒ… ìš”ì²­
    noAnswer: 0,      // ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ
    reject: 0         // ê±°ì ˆ
  };

  rows.forEach(r => {
    switch (r.Status) {
      case "ê±°ë˜ ì„±ì‚¬":
        stats.deal++;
        break;
      case "ë¯¸íŒ… ì™„ë£Œ":
        stats.meetingDone++;
        break;
      case "ë¯¸íŒ… ìš”ì²­":
        stats.request++;
        break;
      case "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ":
        stats.noAnswer++;
        break;
      case "ê±°ì ˆ":
        stats.reject++;
        break;
    }
  });

  document.getElementById("statTotal").textContent = stats.total.toLocaleString();
  document.getElementById("statDeal").textContent = stats.deal.toLocaleString();
  document.getElementById("statMeetingDone").textContent = stats.meetingDone.toLocaleString();
  document.getElementById("statRequest").textContent = stats.request.toLocaleString();
  document.getElementById("statNoAnswer").textContent = stats.noAnswer.toLocaleString();
  document.getElementById("statReject").textContent = stats.reject.toLocaleString();
}
</script>
</body>
</html>
