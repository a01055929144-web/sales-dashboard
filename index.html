<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Store Map Dashboard</title>

  <!-- Leaflet ê¸°ë³¸ CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #fafafa;
    }

    h2 {
      margin: 16px 20px 8px;
    }

    /* ìƒë‹¨ ê²€ìƒ‰/í•„í„° ë°” */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 0 20px 12px;
      box-sizing: border-box;
    }

    #controls input,
    #controls select {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #controls input {
      flex: 1 1 220px;
    }

    #controls select {
      flex: 0 0 160px;
    }

    #map {
      width: 100%;
      height: 65vh;
    }

    #store-list {
      padding: 16px 20px 40px;
      font-size: 14px;
      line-height: 1.6;
    }

    .store-item {
      margin-bottom: 4px;
      cursor: pointer;
    }

    .store-item:hover {
      text-decoration: underline;
    }

    .badge {
      display: inline-block;
      padding: 1px 6px;
      font-size: 11px;
      border-radius: 999px;
      background: #eee;
      margin-left: 4px;
    }

    .badge-status {
      background: #ffd5d5;
    }

    .badge-category {
      background: #d5e7ff;
    }
  </style>
</head>

<body>
  <h2>ğŸ“Œ Sales Store Map Dashboard</h2>

  <!-- ğŸ” ê²€ìƒ‰ & í•„í„° ì˜ì—­ -->
  <div id="controls">
    <input
      type="text"
      id="searchInput"
      placeholder="ë§¤ì¥ëª… / í‚¤ì›Œë“œ / ì§€ì—­ ê²€ìƒ‰"
    />
    <select id="categoryFilter">
      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>
    <select id="statusFilter">
      <option value="">ì „ì²´ ìƒíƒœ</option>
    </select>
  </div>

  <div id="map"></div>
  <div id="store-list"><b>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</b><br /><br /></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // â­ Apps Script API URL (ë‘ì˜ë‹˜ ê²ƒ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    const API_URL =
      "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

    // ì „ì—­ ë³€ìˆ˜
    let map;
    let allRows = [];
    let markersLayer; // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹

    // -----------------------------------------------------
    // 1) ì§€ë„ ì´ˆê¸°í™”
    // -----------------------------------------------------
    map = L.map("map").setView([37.5665, 126.978], 11); // ì„œìš¸ ì¤‘ì‹¬

    // ë¬´ë£Œ OSM íƒ€ì¼
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
    markersLayer = L.markerClusterGroup();
    map.addLayer(markersLayer);

    // -----------------------------------------------------
    // 2) ë°ì´í„° ë¡œë“œ
    // -----------------------------------------------------
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const rows = await res.json();

        console.log("ğŸ“Œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:", rows);

        // ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  ì›ë³¸ ì €ì¥
        allRows = rows.map((r, idx) => ({
          ...r,
          _id: idx, // ë‚´ë¶€ìš© ID
        }));

        buildFilters(allRows);
        applyFilters(); // ì´ˆê¸° ë Œë”ë§
      } catch (err) {
        console.error("API ì˜¤ë¥˜:", err);
        alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!");
      }
    }

    // -----------------------------------------------------
    // 3) í•„í„° ì˜µì…˜(ì¹´í…Œê³ ë¦¬/ìƒíƒœ) êµ¬ì„±
    // -----------------------------------------------------
    function buildFilters(rows) {
      const categorySet = new Set();
      const statusSet = new Set();

      rows.forEach((r) => {
        const category =
          r.category ||
          r.keyword ||
          r.keywordorAddress ||
          r.keywordOrAddress ||
          r.sigungu ||
          "";
        const status = r.Status || r.status || "";

        if (category) categorySet.add(category);
        if (status) statusSet.add(status);
      });

      const categoryFilter = document.getElementById("categoryFilter");
      const statusFilter = document.getElementById("statusFilter");

      // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì±„ìš°ê¸°
      [...categorySet]
        .sort()
        .forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          categoryFilter.appendChild(opt);
        });

      // ìƒíƒœ ì˜µì…˜ ì±„ìš°ê¸°
      [...statusSet]
        .sort()
        .forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          statusFilter.appendChild(opt);
        });

      // í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);
      categoryFilter.addEventListener("change", applyFilters);
      statusFilter.addEventListener("change", applyFilters);
    }

    // -----------------------------------------------------
    // 4) ê²€ìƒ‰ + í•„í„° ì ìš© í›„ ë¦¬ìŠ¤íŠ¸/ë§ˆì»¤ ë Œë”ë§
    // -----------------------------------------------------
    function applyFilters() {
      const searchText = document
        .getElementById("searchInput")
        .value.toLowerCase()
        .trim();
      const categoryValue = document.getElementById("categoryFilter").value;
      const statusValue = document.getElementById("statusFilter").value;

      const filtered = allRows.filter((r) => {
        const name = (r.name || "").toLowerCase();
        const sigungu = (r.sigungu || "").toLowerCase();
        const vendor = (r.Vender || r.vendor || "").toLowerCase();
        const category =
          (
            r.category ||
            r.keyword ||
            r.keywordorAddress ||
            r.keywordOrAddress ||
            r.sigungu ||
            ""
          ).toLowerCase();
        const status = (r.Status || r.status || "").toLowerCase();

        // ê²€ìƒ‰ì–´ í•„í„°
        if (searchText) {
          const combined = `${name} ${sigungu} ${category} ${vendor}`;
          if (!combined.includes(searchText)) return false;
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„°
        if (categoryValue) {
          const catRaw =
            r.category ||
            r.keyword ||
            r.keywordorAddress ||
            r.keywordOrAddress ||
            r.sigungu ||
            "";
          if (catRaw !== categoryValue) return false;
        }

        // ìƒíƒœ í•„í„°
        if (statusValue) {
          const statusRaw = r.Status || r.status || "";
          if (statusRaw !== statusValue) return false;
        }

        return true;
      });

      renderList(filtered);
      renderMarkers(filtered);
    }

    // -----------------------------------------------------
    // 5) ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // -----------------------------------------------------
    function renderList(rows) {
      const box = document.getElementById("store-list");
      box.innerHTML =
        "<b>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</b><br><span style='font-size:12px;color:#888;'>(" +
        rows.length +
        "ê°œ ë§¤ì¥)</span><br><br>";

      rows.forEach((r) => {
        const name = r.name || "ë§¤ì¥ëª… ì—†ìŒ";
        const category =
          r.category || r.keyword || r.keywordorAddress || r.keywordOrAddress;
        const status = r.Status || r.status;

        const div = document.createElement("div");
        div.className = "store-item";
        div.textContent = "ğŸ“ " + name;
        div.dataset.id = r._id;

        if (category) {
          const spanCat = document.createElement("span");
          spanCat.className = "badge badge-category";
          spanCat.textContent = category;
          div.appendChild(spanCat);
        }
        if (status) {
          const spanStatus = document.createElement("span");
          spanStatus.className = "badge badge-status";
          spanStatus.textContent = status;
          div.appendChild(spanStatus);
        }

        div.addEventListener("click", () => {
          const marker = r._marker;
          if (marker) {
            map.setView(marker.getLatLng(), 16);
            marker.openPopup();
          }
        });

        box.appendChild(div);
      });
    }

    // -----------------------------------------------------
    // 6) ì§€ë„ ë§ˆì»¤(í´ëŸ¬ìŠ¤í„°) ë Œë”ë§
    // -----------------------------------------------------
    function renderMarkers(rows) {
      markersLayer.clearLayers();

      rows.forEach((r) => {
        const lat = Number(r.lat);
        const lng = Number(r.lng);

        if (isNaN(lat) || isNaN(lng)) {
          console.warn("â— ìœ„ê²½ë„ ì—†ìŒ â†’ ìŠ¤í‚µ:", r);
          return;
        }

        const name = r.name || "ë§¤ì¥";
        const category =
          r.category || r.keyword || r.keywordorAddress || r.keywordOrAddress;
        const status = r.Status || r.status;
        const sigungu = r.sigungu || "";

        const marker = L.marker([lat, lng]);
        const popupHtml = `
          <div style="font-size:13px;">
            <b>${name}</b><br/>
            ${sigungu ? sigungu + "<br/>" : ""}
            ${category ? "ì¹´í…Œê³ ë¦¬: " + category + "<br/>" : ""}
            ${status ? "ìƒíƒœ: " + status + "<br/>" : ""}
          </div>
        `;
        marker.bindPopup(popupHtml);

        // ë‚˜ì¤‘ì— ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ ì‚¬ìš©
        r._marker = marker;

        markersLayer.addLayer(marker);
      });
    }

    // ìµœì´ˆ ì‹¤í–‰
    loadData();
  </script>
</body>
</html>
