<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sales Store Map Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 10px 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }

    .required-text {
      color: #dc2626;
      font-weight: 700;
      font-size: 11px;
      margin-left: 4px;
    }

    .primary-btn, .secondary-btn {
      border-radius: 12px;
      border: none;
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 6px;
      width: 100%;
      font-weight: 700;
    }

    .primary-btn {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
      transition: all .18s ease-out;
    }
    .primary-btn:hover {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(30, 64, 175, 0.45);
    }
    .primary-btn:disabled {
      background: #9db4e0 !important;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* ë ˆì´ì•„ì›ƒ */
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 320px;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    .store-panel,
    .dashboard-panel {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
    }

    #map { width: 100%; height: 100%; }

    /* History Timeline */
    .timeline-item {
      position: relative;
      padding-left: 18px;
      margin-bottom: 12px;
    }
    .timeline-dot {
      width: 9px;
      height: 9px;
      background: #2563eb;
      border-radius: 999px;
      position: absolute;
      left: 0;
      top: 4px;
    }
    .timeline-date {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .timeline-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 12px;
    }
    .timeline-manager {
      font-size: 11px;
      color: #374151;
      font-weight: 700;
    }
    .timeline-memo {
      margin-top: 3px;
      font-size: 12px;
      color: #111827;
      white-space: pre-wrap;
    }

  </style>
</head>
<body>

<header>
  
  <h1>ğŸ“ Sales Store Map</h1>

  <div class="header-controls" style="flex:1; display:flex; gap:8px;">
    <select id="statusFilterSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <select id="regionSelect" class="select-input">
      <option value="ALL">ì „ì²´ ì§€ì—­</option>
    </select>

    <input id="searchInput" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" />
  </div>
</header>
  <div class="layout">   <!-- â­ ë°˜ë“œì‹œ ì¶”ê°€ -->

<aside class="store-panel">
    <!-- ì¢Œì¸¡ íŒ¨ë„: ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
  <aside class="store-panel" id="storePanel">
    <h2 style="font-size:14px; margin-bottom:6px;">â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</h2>
    <div id="storeCountLabel" style="font-size:11px; color:#6b7280; margin-bottom:10px;"></div>

    <select id="sortSelect" class="select-input" style="width:100%; margin-bottom:10px;">
      <option value="default">ì¦ê²¨ì°¾ê¸° â–· ìƒíƒœ â–· ì´ë¦„</option>
      <option value="name">ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)</option>
      <option value="blog">ë¸”ë¡œê·¸ ë§ì€ìˆœ</option>
    </select>

    <ul id="storeList" style="padding:0; margin:0; list-style:none;"></ul>
  </aside>

  <!-- ê°€ìš´ë° ì§€ë„ -->
  <main>
    <div id="map"></div>
  </main>

  <!-- ìš°ì¸¡ íŒ¨ë„: ìƒì„¸ì •ë³´ + ëŒ€ì‹œë³´ë“œ -->
  <aside class="dashboard-panel" id="dashboardPanel">
    <h2 style="font-size:14px; font-weight:700; margin-bottom:8px;">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>

    <!-- ë„ë„› ì°¨íŠ¸ -->
    <div style="padding:10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:10px;">
      <canvas id="statusChart"></canvas>
      <div id="chartStats" style="font-size:11px; margin-top:6px; line-height:1.4;"></div>
    </div>

    <!-- ìˆ«ì ì¹´ë“œ -->
    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:10px;">
      <div class="stat-card">
        <div class="stat-label">ì´ ë§¤ì¥ ìˆ˜</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">ê±°ë˜ ì„±ì‚¬</div>
        <div class="stat-value" id="statDeal">0</div>
        <div class="stat-sub" id="statDealPct"></div>
      </div>

      <div class="stat-card">
        <div class="stat-label">ë¯¸íŒ… ì™„ë£Œ</div>
        <div class="stat-value" id="statMeetingDone">0</div>
        <div class="stat-sub" id="statMeetingDonePct"></div>
      </div>

      <div class="stat-card">
        <div class="stat-label">ë¯¸íŒ… ìš”ì²­</div>
        <div class="stat-value" id="statRequest">0</div>
        <div class="stat-sub" id="statRequestPct"></div>
      </div>

      <div class="stat-card">
        <div class="stat-label">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
        <div class="stat-value" id="statNoAnswer">0</div>
        <div class="stat-sub" id="statNoAnswerPct"></div>
      </div>

      <div class="stat-card">
        <div class="stat-label">ê±°ì ˆ</div>
        <div class="stat-value" id="statReject">0</div>
        <div class="stat-sub" id="statRejectPct"></div>
      </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ -->
    <div style="border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb; padding:10px; margin-bottom:10px;">
      <div class="detail-title">ğŸª ë§¤ì¥ ìƒì„¸ì •ë³´</div>
      <div id="storeDetailBody" class="detail-body">ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <!-- ë‹´ë‹¹ì ì„ íƒ -->
    <div class="detail-title">
      ë‹´ë‹¹ì <span class="required-text">*í•„ìˆ˜*</span>
    </div>

    <select id="managerInput" class="select-input full-width" style="margin-bottom:10px;">
      <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
      <option value="Zero">Zero</option>
      <option value="Grandal">Grandal</option>
      <option value="Jose">Jose</option>
      <option value="Aimee">Aimee</option>
      <option value="Merry">Merry</option>
    </select>

    <!-- ìƒíƒœ ë³€ê²½ -->
    <div style="border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; background:#fafafa;">
      <div class="status-change-header">ìƒíƒœ ë³€ê²½</div>

      <select id="statusChangeSelect" class="select-input full-width">
        <option value="">ìƒíƒœ ì„ íƒ</option>
        <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
        <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
        <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
        <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
        <option value="ê±°ì ˆ">ê±°ì ˆ</option>
      </select>

      <button id="statusSaveBtn" class="primary-btn" disabled>ìƒíƒœ ë³€ê²½ ì €ì¥</button>
    </div>

    <!-- íˆìŠ¤í† ë¦¬ -->
    <div class="history-section">
      <div class="history-header">ğŸ•’ íˆìŠ¤í† ë¦¬</div>

      <div id="historyList" class="history-list" style="
        border:1px solid #e5e7eb;
        border-radius:8px;
        background:#f9fafb;
        padding:6px;
        max-height:160px;
        overflow-y:auto;
      ">
        ë§¤ì¥ì„ ì„ íƒí•˜ë©´ íˆìŠ¤í† ë¦¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <textarea id="memoInput" placeholder="ë©”ëª¨ ì…ë ¥" style="
        border:1px solid #d1d5db;
        border-radius:8px;
        padding:8px;
        width:100%;
        min-height:48px;
        margin-top:6px;
        font-size:12px;"></textarea>

      <button id="memoSaveBtn" class="primary-btn" disabled>ë©”ëª¨ ì €ì¥</button>
    </div>
  </aside>
</div>
<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/*************************************************
 * ğŸ”‘ Apps Script WebApp URL
 *************************************************/
const BASE_URL = 
  "https://script.google.com/macros/s/AKfycbyTEpSlrv6vFRU4jwICu5ZM9z_xRBskTl5hxyjNZs1Wp1jXd1EzMEejnWGS0hHMKzWK/exec";

/*************************************************
 * ì „ì—­ ë³€ìˆ˜
 *************************************************/
let rawRows = [];
let rawByName = {};
let filteredRows = [];
let markersByName = {};
let markerCluster;
let selectedStoreName = null;

let map;
let chartInstance;

const STATUS_COLOR = {
  "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
  "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
  "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
  "ê±°ì ˆ": "#e74c3c"
};

const STATUS_ORDER = {
  "ê±°ë˜ ì„±ì‚¬": 0,
  "ë¯¸íŒ… ì™„ë£Œ": 1,
  "ë¯¸íŒ… ìš”ì²­": 2,
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": 3,
  "ê±°ì ˆ": 4
};

/*************************************************
 * â­ DOM ë¡œë“œ í›„ ì‹œì‘
 *************************************************/
document.addEventListener("DOMContentLoaded", () => {
  initMap();
  initEvents();
  loadData();
});

/*************************************************
 * 1) ì§€ë„ ì´ˆê¸°í™”
 *************************************************/
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: true
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 40
  });
  map.addLayer(markerCluster);
}

/*************************************************
 * 2) ì´ë²¤íŠ¸ ë“±ë¡
 *************************************************/
function initEvents() {
  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("categorySelect").addEventListener("change", applyFilters);
  document.getElementById("statusFilterSelect").addEventListener("change", applyFilters);
  document.getElementById("regionSelect").addEventListener("change", applyFilters);
  document.getElementById("sortSelect").addEventListener("change", applyFilters);

  document.getElementById("statusSaveBtn").addEventListener("click", saveStatus);
  document.getElementById("memoSaveBtn").addEventListener("click", saveMemo);

  /* ë‹´ë‹¹ì ë³€ê²½ ì‹œ ìë™ ì €ì¥ + ë²„íŠ¼ í™œì„±í™” */
  const managerSelect = document.getElementById("managerInput");
  managerSelect.addEventListener("change", () => {
    const manager = managerSelect.value.trim();
    const enable = manager !== "";

    document.getElementById("statusSaveBtn").disabled = !enable;
    document.getElementById("memoSaveBtn").disabled = !enable;

    if (!selectedStoreName || !manager) return;

    const memoText = `ë‹´ë‹¹ìë¥¼ ${manager}ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`;
    const now = new Date().toLocaleString("ko-KR");

    // í™”ë©´ íƒ€ì„ë¼ì¸ ë°˜ì˜
    const listEl = document.getElementById("historyList");
    listEl.insertAdjacentHTML("afterbegin", `
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-date">${now}</div>
        <div class="timeline-card">
          <div class="timeline-manager">${manager}</div>
          <div class="timeline-memo">${memoText}</div>
        </div>
      </div>`);

    // GAS ë°˜ì˜
    fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(memoText)}&manager=${encodeURIComponent(manager)}`);
  });
}

/*************************************************
 * 3) ë°ì´í„° ë¡œë“œ
 *************************************************/
async function loadData() {
  try {
    const res = await fetch(`${BASE_URL}?action=places`);
    const json = await res.json();

    rawRows = json
      .filter(r => r.lat && r.lng)
      .map(r => ({
        ...r,
        lat: Number(r.lat),
        lng: Number(r.lng),
        favorite: r.favorite === true || r.favorite === "TRUE"
      }));

    rawByName = {};
    rawRows.forEach(r => { if (r.name) rawByName[r.name] = r; });

    buildFilters(rawRows);
    applyFilters();
  } catch (e) {
    alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜ ë°œìƒ");
    console.error(e);
  }
}

/*************************************************
 * 4) í•„í„° êµ¬ì„±
 *************************************************/
function buildFilters(rows) {
  const categorySelect = document.getElementById("categorySelect");
  const statusFilterSelect = document.getElementById("statusFilterSelect");
  const regionSelect = document.getElementById("regionSelect");

  const catSet = new Set();
  const statusSet = new Set();
  const regionSet = new Set();

  rows.forEach(r => {
    if (r.category) catSet.add(r.category.split(">")[0].trim());
    if (r.Status) statusSet.add(r.Status);
    if (r.sigungu) regionSet.add(r.sigungu.trim());
  });

  categorySelect.innerHTML = `<option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>`;
  [...catSet].sort().forEach(cat =>
    categorySelect.insertAdjacentHTML("beforeend", `<option value="${cat}">${cat}</option>`)
  );

  statusFilterSelect.innerHTML = `<option value="ALL">ì „ì²´ ìƒíƒœ</option>`;
  [...statusSet]
    .sort((a, b) => (STATUS_ORDER[a] ?? 99) - (STATUS_ORDER[b] ?? 99))
    .forEach(st =>
      statusFilterSelect.insertAdjacentHTML("beforeend", `<option value="${st}">${st}</option>`)
    );

  regionSelect.innerHTML = `<option value="ALL">ì „ì²´ ì§€ì—­</option>`;
  [...regionSet].sort().forEach(reg =>
    regionSelect.insertAdjacentHTML("beforeend", `<option value="${reg}">${reg}</option>`)
  );
}

/*************************************************
 * 5) í•„í„° ì ìš©
 *************************************************/
function applyFilters() {
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusFilterSelect").value;
  const region = document.getElementById("regionSelect").value;
  const sortMode = document.getElementById("sortSelect").value;

  filteredRows = rawRows.filter(r => {
    const text = `${r.name} ${r.sigungu} ${r.roadAddress} ${r.keyword}`.toLowerCase();

    const matchSearch = !q || text.includes(q);
    const major = (r.category || "").split(">")[0].trim();
    const matchCat = cat === "ALL" || major === cat;
    const matchStatus = st === "ALL" || (r.Status || "") === st;
    const matchRegion = region === "ALL" || (r.sigungu || "") === region;

    return matchSearch && matchCat && matchStatus && matchRegion;
  });

  filteredRows = sortStores(filteredRows, sortMode);

  renderAll();
}

/*************************************************
 * 6) ì •ë ¬
 *************************************************/
function sortStores(rows, mode) {
  const list = [...rows];

  list.sort((a, b) => {
    if (mode === "default") {
      if (a.favorite !== b.favorite) return a.favorite ? -1 : 1;

      const soA = STATUS_ORDER[a.Status] ?? 99;
      const soB = STATUS_ORDER[b.Status] ?? 99;
      if (soA !== soB) return soA - soB;

      return (a.name || "").localeCompare(b.name || "", "ko");
    }

    if (mode === "name") {
      return (a.name || "").localeCompare(b.name || "", "ko");
    }

    if (mode === "blog") {
      return Number(b.blog_count || 0) - Number(a.blog_count || 0);
    }

    return 0;
  });

  return list;
}

/*************************************************
 * 7) ì „ì²´ ë Œë”ë§
 *************************************************/
function renderAll() {
  renderMarkers();
  renderStoreList();
  renderStats();
}
</script>
<script>
/*************************************************
 * 8) ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
 *************************************************/
function createMarkerIcon(status, favorite = false, selected = false) {
  const color = STATUS_COLOR[status] || "#7f8c8d";
  const size = selected ? 22 : 16;
  const borderColor = favorite ? "#fbbf24" : "#ffffff";

  return L.divIcon({
    className: "custom-marker",
    html: `
      <div class="marker-dot ${selected ? "marker-selected" : ""}"
           style="background:${color}; border-color:${borderColor};
                  width:${size}px; height:${size}px;"></div>`,
    iconSize: [size + 4, size + 4],
    iconAnchor: [(size + 4) / 2, (size + 4) / 2]
  });
}

/*************************************************
 * 9) ë§ˆì»¤ ë Œë”ë§
 *************************************************/
function renderMarkers() {
  markerCluster.clearLayers();
  markersByName = {};

  filteredRows.forEach(r => {
    const marker = L.marker([r.lat, r.lng], {
      icon: createMarkerIcon(r.Status, r.favorite, r.name === selectedStoreName)
    });

    marker.bindTooltip(r.name || "", {
      permanent: false,
      direction: "top",
      offset: [0, -10]
    });

    marker.on("click", () => focusOnStore(r));

    markerCluster.addLayer(marker);
    markersByName[r.name] = marker;
  });

  if (filteredRows.length > 0) {
    const group = L.featureGroup(markerCluster.getLayers());
    map.fitBounds(group.getBounds().pad(0.1));
  }

  document.getElementById("storeCountLabel").textContent =
    `${filteredRows.length}ê°œ ë§¤ì¥`;
}

/*************************************************
 * 10) ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
 *************************************************/
function renderStoreList() {
  const listEl = document.getElementById("storeList");
  listEl.innerHTML = "";

  filteredRows.slice(0, 500).forEach(r => {
    const li = document.createElement("li");
    li.className = "store-item";

    const major = (r.category || "").split(">")[0];

    li.innerHTML = `
      <div class="store-header">
        <span class="fav-icon">${r.favorite ? "â­" : "â˜†"}</span>
        <div class="store-name">${r.name}</div>
      </div>
      <div class="store-meta-line">
        <span class="status-badge">${r.Status || "ìƒíƒœ ì—†ìŒ"}</span>
        <span class="meta-text">${r.sigungu || ""} Â· ${major}</span>
      </div>
      <div class="store-meta-address">${r.roadAddress || ""}</div>
    `;

    // ì„ íƒ
    li.addEventListener("click", () => focusOnStore(r));

    // ì¦ê²¨ì°¾ê¸°
    li.querySelector(".fav-icon").addEventListener("click", e => {
      e.stopPropagation();
      toggleFavorite(r);
    });

    listEl.appendChild(li);
  });
}

/*************************************************
 * 11) ë§¤ì¥ ì„ íƒ
 *************************************************/
function focusOnStore(store) {
  selectedStoreName = store.name;

  if (!isNaN(store.lat) && !isNaN(store.lng))
    map.setView([store.lat, store.lng], 17);

  Object.keys(markersByName).forEach(name => {
    const row = rawByName[name];
    const marker = markersByName[name];
    marker.setIcon(
      createMarkerIcon(row.Status, row.favorite, name === selectedStoreName)
    );
  });

  showStoreDetail(store);
  setStatusDropdown(store);
  loadHistory(store.name);
}

/*************************************************
 * 12) ë§¤ì¥ ìƒì„¸ì •ë³´
 *************************************************/
function showStoreDetail(r) {
  const box = document.getElementById("storeDetailBody");
  if (!r) {
    box.textContent = "ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
    return;
  }

  const majorCat = (r.category || "").split(">")[0] || "-";

  let safeUrl = r.URL || r.url || "";
  if (safeUrl && !/^https?:\/\//i.test(safeUrl))
    safeUrl = "https://" + safeUrl;

  const urlHtml = safeUrl
    ? `<a href="${safeUrl}" target="_blank" style="color:#2563eb;font-weight:600;">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—´ê¸°</a>`
    : "-";

  box.innerHTML = `
    <div style="font-size:15px;font-weight:700;margin-bottom:6px;">${r.name}</div>
    <div class="info-item"><span>ğŸ  ì£¼ì†Œ</span>${r.roadAddress || "-"}</div>
    <div class="info-item"><span>ğŸ“ ì§€ì—­</span>${r.sigungu || "-"}</div>
    <div class="info-item"><span>ğŸ½ ì—…ì¢…</span>${majorCat}</div>
    <div class="info-item"><span>â­ ìƒíƒœ</span>${r.Status || "-"}</div>
    <div class="info-item"><span>ğŸ“ í‚¤ì›Œë“œ</span>${r.keyword || "-"}</div>
    <div class="info-item"><span>ğŸ”— ë§í¬</span>${urlHtml}</div>
  `;
}

/*************************************************
 * 13) ìƒíƒœ ë“œë¡­ë‹¤ìš´ ê°’ ì„¸íŒ…
 *************************************************/
function setStatusDropdown(store) {
  document.getElementById("statusChangeSelect").value = store?.Status || "";
}

/*************************************************
 * 14) ìƒíƒœ ë³€ê²½ ì €ì¥ + íˆìŠ¤í† ë¦¬ ìë™ ê¸°ë¡
 *************************************************/
async function saveStatus() {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const manager = document.getElementById("managerInput").value.trim();
  if (!manager) return alert("ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

  const newStatus = document.getElementById("statusChangeSelect").value;
  if (!newStatus) return alert("ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

  const now = new Date().toLocaleString("ko-KR");
  const memoText = `ìƒíƒœë¥¼ '${newStatus}'ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`;

  // UI ì¦‰ì‹œ ë°˜ì˜
  document.getElementById("historyList").insertAdjacentHTML("afterbegin", `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-date">${now}</div>
      <div class="timeline-card">
        <div class="timeline-manager">${manager}</div>
        <div class="timeline-memo">${memoText}</div>
      </div>
    </div>
  `);

  // GAS â€” ìƒíƒœ ë³€ê²½
  fetch(`${BASE_URL}?action=updateStatus&name=${encodeURIComponent(selectedStoreName)}&status=${encodeURIComponent(newStatus)}`);

  // GAS â€” íˆìŠ¤í† ë¦¬ ê¸°ë¡
  fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(memoText)}&manager=${encodeURIComponent(manager)}`);

  // í™”ë©´ ì „ì²´ ê°±ì‹ 
  rawByName[selectedStoreName].Status = newStatus;
  applyFilters();
}

/*************************************************
 * 15) íˆìŠ¤í† ë¦¬ ë¡œë”©
 *************************************************/
function loadHistory(name) {
  const listEl = document.getElementById("historyList");
  listEl.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  fetch(`${BASE_URL}?action=history&name=${encodeURIComponent(name)}`)
    .then(res => res.json())
    .then(items => {
      if (!Array.isArray(items) || items.length === 0) {
        listEl.innerHTML = `<div class="history-empty">íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      listEl.innerHTML = items
        .map(it => `
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-date">${it.date}</div>
            <div class="timeline-card">
              <div class="timeline-manager">${it.manager || "-"}</div>
              <div class="timeline-memo">${it.memo}</div>
            </div>
          </div>
        `)
        .join("");
    })
    .catch(() => {
      listEl.innerHTML = `<div class="history-empty">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
    });
}

/*************************************************
 * 16) ë©”ëª¨ ì €ì¥
 *************************************************/
function saveMemo() {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const manager = document.getElementById("managerInput").value.trim();
  if (!manager) return alert("ë‹´ë‹¹ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const text = document.getElementById("memoInput").value.trim();
  if (!text) return alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  const now = new Date().toLocaleString("ko-KR");

  // UI ë°˜ì˜
  document.getElementById("historyList").insertAdjacentHTML("afterbegin", `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-date">${now}</div>
      <div class="timeline-card">
        <div class="timeline-manager">${manager}</div>
        <div class="timeline-memo">${text}</div>
      </div>
    </div>
  `);

  // GAS ì „ì†¡
  fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(text)}&manager=${encodeURIComponent(manager)}`);

  document.getElementById("memoInput").value = "";
}

/*************************************************
 * 17) ì¦ê²¨ì°¾ê¸°
 *************************************************/
function toggleFavorite(store) {
  store.favorite = !store.favorite;
  rawByName[store.name].favorite = store.favorite;
  applyFilters();

  fetch(`${BASE_URL}?action=favorite&name=${encodeURIComponent(store.name)}&fav=${store.favorite ? "TRUE" : "FALSE"}`);
}

/*************************************************
 * 18) í†µê³„/ì°¨íŠ¸
 *************************************************/
function renderStats() {
  const stats = {
    total: filteredRows.length,
    deal: 0, meetingDone: 0, request: 0, noAnswer: 0, reject: 0
  };

  filteredRows.forEach(r => {
    if (r.Status === "ê±°ë˜ ì„±ì‚¬") stats.deal++;
    else if (r.Status === "ë¯¸íŒ… ì™„ë£Œ") stats.meetingDone++;
    else if (r.Status === "ë¯¸íŒ… ìš”ì²­") stats.request++;
    else if (r.Status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") stats.noAnswer++;
    else if (r.Status === "ê±°ì ˆ") stats.reject++;
  });

  const total = stats.total || 1;
  const pct = v => ((v / total) * 100).toFixed(1);

  document.getElementById("statTotal").textContent = stats.total;
  document.getElementById("statDeal").textContent = stats.deal;
  document.getElementById("statMeetingDone").textContent = stats.meetingDone;
  document.getElementById("statRequest").textContent = stats.request;
  document.getElementById("statNoAnswer").textContent = stats.noAnswer;
  document.getElementById("statReject").textContent = stats.reject;

  document.getElementById("statDealPct").textContent = pct(stats.deal) + "%";
  document.getElementById("statMeetingDonePct").textContent = pct(stats.meetingDone) + "%";
  document.getElementById("statRequestPct").textContent = pct(stats.request) + "%";
  document.getElementById("statNoAnswerPct").textContent = pct(stats.noAnswer) + "%";
  document.getElementById("statRejectPct").textContent = pct(stats.reject) + "%";

  if (chartInstance) chartInstance.destroy();

  const ctx = document.getElementById("statusChart");
  chartInstance = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["ê±°ë˜ ì„±ì‚¬", "ë¯¸íŒ… ì™„ë£Œ", "ë¯¸íŒ… ìš”ì²­", "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ", "ê±°ì ˆ"],
      datasets: [{
        data: [
          stats.deal, stats.meetingDone, stats.request,
          stats.noAnswer, stats.reject
        ],
        backgroundColor: ["#2ecc71", "#3498db", "#f1c40f", "#95a5a6", "#e74c3c"]
      }]
    },
    options: { cutout: "65%", plugins: { legend: { position: "bottom" } } }
  });

  document.getElementById("chartStats").innerHTML = `
    <div><b>ê±°ë˜ ì„±ì‚¬:</b> ${stats.deal}ê°œ (${pct(stats.deal)}%)</div>
    <div><b>ë¯¸íŒ… ì™„ë£Œ:</b> ${stats.meetingDone}ê°œ (${pct(stats.meetingDone)}%)</div>
    <div><b>ë¯¸íŒ… ìš”ì²­:</b> ${stats.request}ê°œ (${pct(stats.request)}%)</div>
    <div><b>ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ:</b> ${stats.noAnswer}ê°œ (${pct(stats.noAnswer)}%)</div>
    <div><b>ê±°ì ˆ:</b> ${stats.reject}ê°œ (${pct(stats.reject)}%)</div>
  `;
}
</script>

</body>
</html>
