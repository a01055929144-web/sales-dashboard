<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sales Store Map Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /***********************************************
     * HEADER
     ***********************************************/
    header {
      padding: 10px 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }

    .header-controls {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .search-input,
    .select-input {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }
    .search-input { flex: 1; min-width: 120px; }
    .select-input { min-width: 120px; }

    .required-text {
      color: #dc2626;
      font-weight: 700;
      font-size: 11px;
      margin-left: 4px;
    }

    /***********************************************
     * BUTTONS
     ***********************************************/
    .primary-btn, .secondary-btn {
      border-radius: 12px;
      border: none;
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 6px;
      width: 100%;
      font-weight: 700;
    }

    .primary-btn {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
      transition: all .18s ease-out;
    }
    .primary-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #1e40af, #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(30, 64, 175, 0.45);
    }
    .primary-btn:disabled {
      background: #9db4e0 !important;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /***********************************************
     * MAIN LAYOUT
     ***********************************************/
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 320px;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    .store-panel,
    .dashboard-panel {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
      position: relative;
      z-index: 9999; /* ì§€ë„ë³´ë‹¤ ìœ„ */
    }

    .store-panel { border-right: 1px solid #e5e7eb; }
    .dashboard-panel { border-left: 1px solid #e5e7eb; }

    #map { width: 100%; height: 100%; }

    /***********************************************
     * STORE LIST
     ***********************************************/
    .store-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .store-list-header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
    }
    .store-count {
      font-size: 11px;
      color: #6b7280;
    }

    .store-sort-row {
      margin-bottom: 8px;
    }

    .store-item {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      margin-bottom: 6px;
      transition: 0.15s;
      background: #ffffff;
    }
    .store-item:hover {
      background: #f9fafb;
      border-color: #e5e7ff;
      box-shadow: 0 1px 3px rgba(15,23,42,0.12);
    }

    .store-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .store-name {
      font-size: 13px;
      font-weight: 700;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .fav-icon {
      cursor: pointer;
      font-size: 16px;
      flex-shrink: 0;
    }
    .store-meta-line {
      display: flex;
      gap: 6px;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 3px;
    }
    .store-meta-address {
      font-size: 11px;
      color: #374151;
    }

    .status-badge {
      padding: 2px 6px;
      background: #eef2ff;
      border-radius: 999px;
      font-size: 11px;
      color: #4f46e5;
      font-weight: 600;
    }

    /***********************************************
     * DASHBOARD
     ***********************************************/
    .dashboard-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .chart-wrapper {
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }
    .stat-card {
      background: #ffffff;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .stat-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 700;
    }
    .stat-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .detail-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
      padding: 10px;
      margin-bottom: 10px;
    }
    .detail-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .detail-name {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .info-item {
      font-size: 12px;
      margin-bottom: 4px;
    }
    .info-item span {
      display: inline-block;
      width: 55px;
      font-weight: 600;
      color: #374151;
    }

    .status-change-box {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      background: #fafafa;
    }
    .status-change-header {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    /***********************************************
     * HISTORY TIMELINE
     ***********************************************/
    .history-section {
      margin-top: 10px;
    }
    .history-header{
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .history-empty {
      font-size: 12px;
      color: #9ca3af;
      padding: 6px;
    }
    .history-list {
      font-size: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
      padding: 6px;
      max-height: 160px;
      overflow-y: auto;
      margin-bottom: 6px;
    }

    .timeline-item {
      position: relative;
      padding-left: 18px;
      margin-bottom: 10px;
    }
    .timeline-dot {
      width: 9px;
      height: 9px;
      background: #2563eb;
      border-radius: 999px;
      position: absolute;
      left: 0;
      top: 4px;
    }
    .timeline-date {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .timeline-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 12px;
    }
    .timeline-manager {
      font-size: 11px;
      color: #374151;
      font-weight: 700;
    }
    .timeline-memo {
      margin-top: 3px;
      font-size: 12px;
      color: #111827;
      white-space: pre-wrap;
    }

    textarea#memoInput {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px;
      width: 100%;
      min-height: 48px;
      font-size: 12px;
      resize: vertical;
    }

    /***********************************************
     * MARKER DOT
     ***********************************************/
    .marker-dot {
      border-radius: 999px;
      border: 2px solid #ffffff;
    }
/* â­ ë²”ë¡€ ìŠ¤íƒ€ì¼ */
.legend-box {
  background: rgba(255, 255, 255, 0.92);
  padding: 10px 14px;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.12);
  font-size: 12px;
  color: #111827;
  line-height: 1.5;
  width: 158px;
  backdrop-filter: blur(6px);
}

/* íƒ€ì´í‹€ */
.legend-title {
  font-weight: 700;
  font-size: 13px;
  margin-bottom: 6px;
}

/* ë²”ë¡€ ì•„ì´í…œ í•œ ì¤„ */
.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
}

/* ë§ˆì»¤ ì¸ë„¤ì¼(ì´ë¯¸ì§€/ë„í˜•) */
.legend-marker {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border:2px solid #fff;
  margin-right: 8px;
}

/* â­ ì‹ ê·œ ë§¤ì¥: ë³„ëª¨ì–‘ (ì› ëŒ€ì‹ ) */
.legend-star {
  font-size: 14px;
  margin-right: 8px;
  color: #8b5cf6; /* ë³´ë¼ìƒ‰ */
}

    .custom-marker {
  overflow: visible !important;
}

    /* ğŸ”¥ ì¶”ì²œ ìœ í†µì‚¬ ë±ƒì§€ */
.vender-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  margin-right: 6px;
}

.badge-important {
  background: #fee2e2;
  color: #b91c1c;
}

.badge-priority {
  background: #e0e7ff;
  color: #3730a3;
}

.hidden {
  display: none;
}

    

  </style>
<!-- âœ… ëª¨ë°”ì¼ ìµœì í™” ë¯¸ë””ì–´ ì¿¼ë¦¬ + ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ê³ ì • ìŠ¤í¬ë¡¤ -->
<style>
  
@media screen and (max-width: 768px) {

  /* ğŸ”¥ ëª¨ë°”ì¼ì—ì„œëŠ” body ë†’ì´ë¥¼ ê³ ì •í•˜ì§€ ì•ŠìŒ */
  body {
    height: auto !important;
  }

  /* ğŸ”¥ header í•„í„° ì¤„ë°”ê¿ˆ ê°€ëŠ¥í•˜ë„ë¡ */
  header {
    flex-wrap: wrap !important;
    padding-bottom: 10px;
    height: auto !important;
  }

  .header-controls {
    flex-wrap: wrap !important;
    width: 100%;
    gap: 8px;
  }

  /* ğŸ”¥ í•„í„°/ê²€ìƒ‰ input â†’ 2ì¤„ ìë™ ë°°ì¹˜ */
  .search-input,
  .select-input {
    flex: 1 1 calc(50% - 10px);
    min-width: 140px;
    font-size: 15px;
    padding: 10px;
  }

  /* ğŸ”¥ ì „ì²´ êµ¬ì¡° */
  .layout {
    display: block;
    height: auto !important;
    overflow-y: auto;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
  }

  /* ğŸ”¥ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ */
  .store-panel {
    max-height: 180px;
    overflow-y: auto;
    border-bottom: 1px solid #ddd;
    padding-bottom: 6px;
    margin-bottom: 0 !important;
  }

  /* ğŸ”¥ ì§€ë„ í¬ê¸° - ë¹ˆ ê³µê°„ ì œê±° + í•­ìƒ ê½‰ ì°¨ê²Œ */
  #map {
    width: 100%;
    height: 420px !important;     /* ëª¨ë°”ì¼ì—ì„œ ì±„ìš°ëŠ” ë†’ì´ */
    min-height: 350px !important;
    margin-top: 12px;
  }

  /* ğŸ”¥ ëŒ€ì‹œë³´ë“œ */
  .dashboard-panel {
    margin-top: 14px;
    padding: 12px;
    border: none;
    width: 100%;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
  }

  /* ğŸ”¥ ë²„íŠ¼ í¬ê¸° */
  .primary-btn, 
  .secondary-btn {
    width: 100%;
    font-size: 15px;
    padding: 12px;
  }
}




 /* â­ ì¹´ì¹´ì˜¤ë§µ/ë„¤ì´ë²„ ì§€ë„ ìŠ¤íƒ€ì¼ Floating ë²„íŠ¼ */
.floating-location-btn {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border: 1px solid #ddd;

  display: flex;
  justify-content: center;
  align-items: center;

  font-size: 26px;
  cursor: pointer;
  z-index: 9999;

  transition: 0.2s;
}

.floating-location-btn:active {
  transform: scale(0.92);
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.leaflet-control-locate {
  background: white;
  padding: 8px;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
  cursor: pointer;
  font-size: 20px;
  line-height: 20px;
  text-align: center;
  width: 42px;
  height: 42px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.leaflet-control-locate:hover {
  box-shadow: 0 3px 12px rgba(0,0,0,0.3);
}
#dashboardContent {
  transition: max-height 0.25s ease-out;
  overflow: hidden;
}

#dashboardFoldArea.dashboard-collapsed {
  max-height: 0 !important;
  opacity: 0;
}

#dashboardFoldArea.dashboard-expanded {
  max-height: 1200px;
  opacity: 1;
}
/* ğŸ”¥ ë“œë¡­ë‹¤ìš´/ì…ë ¥/ë²„íŠ¼ì´ ì§€ë„ ìœ„ì—ì„œ ì •ìƒ ë™ì‘í•˜ë„ë¡ ì´ë²¤íŠ¸ ìš°ì„ ê¶Œ ë¶€ì—¬ */
.dashboard-panel,
.store-panel {
  pointer-events: auto !important;
}

  /* ğŸ”¥ ë²”ë¡€ í† ê¸€ ë²„íŠ¼ */
#legendToggle {
  position: absolute;
  top: 14px;
  left: 14px;
  background: rgba(0,0,0,0.55);
  color: white;
  padding: 6px 12px;
  font-size: 13px;
  border-radius: 8px;
  z-index: 9999;
  cursor: pointer;
  backdrop-filter: blur(4px);
}

#legendPanel {
  position: absolute;
  top: 60px;
  left: 14px;
  width: 220px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  padding: 12px;
  z-index: 9999;
  display: none;
}


.legend-header {
  display:flex;
  justify-content: space-between;
  align-items:center;
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 8px;
}

#legendCloseBtn {
  border:none;
  background:#efefef;
  padding:3px 8px;
  border-radius:6px;
  cursor:pointer;
}

.legend-body .legend-item {
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom: 6px;
  font-size: 13px;
}

.legend-dot {
  width:12px;
  height:12px;
  border-radius:50%;
}

/* ğŸ”¥ ëª¨ë°”ì¼ ì „ìš© ìŠ¤íƒ€ì¼ */
@media (max-width: 768px) {

  #legendToggle {
    position: absolute;
    top: 14px;
    left: 14px;
    background: rgba(0,0,0,0.7);
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 12px;
  }

  #legendPanel {
    position: absolute;
    bottom: auto;
    left: 14px;
    right: auto;
    top: 60px;
    width: calc(100% - 28px);
    padding: 16px;
    border-radius: 16px;
    display: none;
  }
}
.leaflet-marker-icon.custom-marker {
  overflow: visible !important;
}

  
</style>
</head>

<body>

<header>
  <h1>ğŸ“ Sales Store Map</h1>

  <div class="header-controls">
  <select id="openMonthSelect" class="select-input">
  <option value="ALL">ì „ì²´ ì˜¤í”ˆì›”</option>
   </select>

    <select id="statusFilterSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <select id="regionSelect" class="select-input">
      <option value="ALL">ì „ì²´ ì§€ì—­</option>
    </select>

    <input id="searchInput" class="search-input" placeholder="ex) ë§¤ì¥ëª… / ì£¼ì†Œ / í‚¤ì›Œë“œ" />
  </div>  
</header>

<div class="layout">
  <!-- ì¢Œì¸¡ íŒ¨ë„: ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
  <aside class="store-panel" id="storePanel">
    <div class="store-list-header">
      <h2>ğŸ“Œ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ </h2>
      <span class="store-count" id="storeCountLabel">0ê°œ</span>
    </div>

    <div class="store-sort-row">
      <select id="sortSelect" class="select-input" style="width:100%;">
        <option value="default"> ìƒíƒœ â–· ì´ë¦„</option>
        <option value="name">ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)</option>
        <option value="blog">ë¸”ë¡œê·¸ ë§ì€ìˆœ</option>
      </select>
    </div>

    <ul id="storeList" class="store-list" style="list-style:none; padding:0; margin:0;"></ul>
  </aside>

  <!-- ê°€ìš´ë°: ì§€ë„ -->
<main>
  <div id="map">
<div id="legendToggle">ë²”ë¡€ â–¼</div>

<div id="legendPanel">
  <div class="legend-header">
    <button id="legendCloseBtn">ë‹«ê¸°</button>
  </div>

 <div class="legend-body">

  <div class="legend-item">
    <span class="legend-dot" style="background:#5DADE2"></span> ì»¨í…
  </div>

  <div class="legend-item">
    <span class="legend-dot" style="background:#f1c40f"></span> ë¯¸íŒ… ìš”ì²­
  </div>

  <div class="legend-item">
    <span class="legend-dot" style="background:#3498db"></span> ë¯¸íŒ… ì™„ë£Œ
  </div>

  <div class="legend-item">
    <span class="legend-dot" style="background:#2ecc71"></span> ê±°ë˜ ì„±ì‚¬
  </div>

  <div class="legend-item">
    <span class="legend-dot" style="background:#95a5a6"></span> ë¶€ì¬ì¤‘Â·ë¯¸ì‘ë‹µ
  </div>

  <div class="legend-item">
    <span class="legend-dot" style="background:#e74c3c"></span> ê±°ì ˆ
  </div>

  <div class="legend-item">
    <span class="legend-star">â˜…</span> ì‹ ê·œ ì˜¤í”ˆ ë§¤ì¥
  </div>

</div>

</div>

</main>


  <!-- ìš°ì¸¡ íŒ¨ë„: ìƒì„¸ì •ë³´ + ëŒ€ì‹œë³´ë“œ -->
  <aside class="dashboard-panel" id="dashboardPanel">
<div class="dashboard-title" style="display:flex; justify-content:space-between; align-items:center;">
  ğŸ“Š ëŒ€ì‹œë³´ë“œ
  <span id="dashboardToggleBtn" style="cursor:pointer; font-size:16px;">â–¼</span>
</div>

<div id="dashboardContent">
  <!-- ì ‘í˜ START -->
  <div id="dashboardFoldArea">
  <!-- ë„ë„› ì°¨íŠ¸ -->
  <div class="chart-wrapper">
      <canvas id="statusChart"></canvas>
      <div id="chartStats" style="font-size:11px; margin-top:6px; line-height:1.4;"></div>
    </div>

    <!-- ìˆ«ì ì¹´ë“œ -->
  <div class="stat-grid">

  <div class="stat-card">
    <div class="stat-label">ì´ ë§¤ì¥ ìˆ˜</div>
    <div class="stat-value" id="statTotal">0</div>
  </div>

  <div class="stat-card">
    <div class="stat-label">ì»¨í…</div>
    <div class="stat-value" id="statContact">0</div>
    <div class="stat-sub" id="statContactPct"></div>
  </div>

  <div class="stat-card">
    <div class="stat-label">ë¯¸íŒ… ìš”ì²­</div>
    <div class="stat-value" id="statRequest">0</div>
    <div class="stat-sub" id="statRequestPct"></div>
  </div>

  <div class="stat-card">
    <div class="stat-label">ë¯¸íŒ… ì™„ë£Œ</div>
    <div class="stat-value" id="statMeetingDone">0</div>
    <div class="stat-sub" id="statMeetingDonePct"></div>
  </div>

  <div class="stat-card">
    <div class="stat-label">ê±°ë˜ ì„±ì‚¬</div>
    <div class="stat-value" id="statDeal">0</div>
    <div class="stat-sub" id="statDealPct"></div>
  </div>

  <div class="stat-card">
    <div class="stat-label">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
    <div class="stat-value" id="statNoAnswer">0</div>
    <div class="stat-sub" id="statNoAnswerPct"></div>
  </div>

  <div class="stat-card">
    <div class="stat-label">ê±°ì ˆ</div>
    <div class="stat-value" id="statReject">0</div>
    <div class="stat-sub" id="statRejectPct"></div>
  </div>

</div>

  </div> <!-- dashboardFoldArea --> 
</div> <!-- dashboardContent -->

    <!-- ìƒì„¸ ì •ë³´ -->
    <div class="detail-card">
      <div class="detail-title">ğŸª ë§¤ì¥ ìƒì„¸ì •ë³´</div>
      <div id="storeDetailBody" class="detail-body">
        ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>

<!-- ğŸ“¦ ì¶”ì²œ ìœ í†µì‚¬ -->
<div class="detail-card" id="venderSection" style="display:none;">
  <div class="detail-title">â­ ì¶”ì²œ ìœ í†µì‚¬</div>

  <div id="venderCard" style="
    background:#ffffff;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:10px;
    margin-bottom:8px;
  ">
    <!-- JSë¡œ ì±„ì›Œì§ˆ ì˜ì—­ -->
  </div>
</div>

    
    
    <!-- ë‹´ë‹¹ ìœ í˜• ì„ íƒ (CALL / SALES) -->
  <div style="margin-bottom:10px;">
    <label style="font-size:13px; font-weight:700;"> êµ¬ë¶„ <span style="color:#dc2626;">*í•„ìˆ˜*</span></label>
  
      <div id="managerTypeButtons" style="display:flex; gap:8px; margin-top:6px;">
    <button type="button" id="btnCall" class="type-btn inactive">Call</button>
    <button type="button" id="btnSales" class="type-btn inactive">Sales</button>
    </div>
  </div>
    
    <!-- ë‹´ë‹¹ì ì„ íƒ -->
    <div class="detail-title">
    <label style="font-size:13px; font-weight:700;"> ë‹´ë‹¹ì <span style="color:#dc2626;">*í•„ìˆ˜*</span></label>
    </div>
 <select id="managerInput" class="select-input" style="width:100%; margin-bottom:10px;">
      <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
      <option value="Zero">Zero</option>
      <option value="Grandal">Grandal</option>
      <option value="Jose">Jose</option>
      <option value="Aimee">Aimee</option>
      <option value="Merry">Merry</option>
    </select>

<style>
.type-btn {
  flex:1;
  padding:10px 0;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:13px;
  font-weight:700;
  background:#f9fafb;
  cursor:pointer;
}
.type-btn.active {
  background:#2563eb;
  color:white;
  border-color:#1d4ed8;
  box-shadow:0 2px 8px rgba(37, 99, 235, 0.35);
}
.type-btn.inactive {
  background:#f3f4f6;
  color:#374151;
}
</style>


   

    <!-- ìƒíƒœ ë³€ê²½ -->
    <div class="status-change-box">
      <div class="status-change-header">ìƒíƒœ ë³€ê²½</div>

      <select id="statusChangeSelect" class="select-input" style="width:100%;">
        <option value="">ìƒíƒœ ì„ íƒ</option>
        <option value="ì»¨í…">ì»¨í…</option>
        <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
        <option value="ê±°ì ˆ">ê±°ì ˆ</option>
        <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
        <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
        <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
        
      </select>

      <button id="statusSaveBtn" class="primary-btn" disabled>ìƒíƒœ ë³€ê²½ ì €ì¥</button>
    </div>

    <!-- íˆìŠ¤í† ë¦¬ + ë©”ëª¨ -->
    <div class="history-section">
      <div class="history-header">ğŸ•’ íˆìŠ¤í† ë¦¬</div>

      <div id="historyList" class="history-list">
        ë§¤ì¥ì„ ì„ íƒí•˜ë©´ íˆìŠ¤í† ë¦¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.
      </div>

      <textarea id="memoInput" placeholder="ë©”ëª¨ ì…ë ¥ (ì €ì¥ ì‹œ ì¼ì‹œ ìë™ ê¸°ë¡)"></textarea>
      <button id="memoSaveBtn" class="primary-btn" disabled>ë©”ëª¨ ì €ì¥</button>
    </div>
  </aside>
</div>

<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/*************************************************
 * ğŸ”‘ Apps Script WebApp URL
 *************************************************/
let managerType = "call";

const BASE_URL =
  "https://script.google.com/macros/s/AKfycbxYbvXSt2girOsHJQJtGiDPw4U7zCGNvDUoY9ID9cHWAy4OZtwXHp8XfXnXSeTxqbPk/exec";

/*************************************************
 * ì „ì—­ ë³€ìˆ˜
 *************************************************/
let rawRows = [];
let rawByName = {};
let filteredRows = [];
let markersByName = {};
let markerCluster;
let selectedStoreName = null;

let map;
let chartInstance;

let liveWatchId = null;   // â˜… ì—¬ê¸°ì— ì¶”ê°€
let liveMarker = null;    // â˜… ì—¬ê¸°ì— ì¶”ê°€
  
let venderRegionRows = [];   // ì›ë³¸ ë°°ì—´
let venderRegionMap = {};    // STEP 6ì—ì„œ ì“¸ Map

let venderMasterRows = [];
let venderMasterMap = {};

/*************************************************
 * DOM Ready
 *************************************************/
document.addEventListener("DOMContentLoaded", async () => {
  initMap();
  initEvents();
  setTypeButtonUI();

  // ğŸ”¥ ë²”ë¡€ ì´ë²¤íŠ¸
  const legendToggle = document.getElementById("legendToggle");
  const legendPanel = document.getElementById("legendPanel");
  const legendCloseBtn = document.getElementById("legendCloseBtn");

  if (legendToggle && legendPanel && legendCloseBtn) {
    legendToggle.addEventListener("click", () => {
      legendPanel.style.display = "block";
    });

    legendCloseBtn.addEventListener("click", () => {
      legendPanel.style.display = "none";
    });
  }

  // ğŸ”¥ ëŒ€ì‹œë³´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸°
  const toggleBtn = document.getElementById("dashboardToggleBtn");
  const content = document.getElementById("dashboardFoldArea");

  if (toggleBtn && content) {
    content.classList.add("dashboard-expanded");

    toggleBtn.addEventListener("click", () => {
      const collapsed = content.classList.contains("dashboard-collapsed");

      if (collapsed) {
        content.classList.remove("dashboard-collapsed");
        content.classList.add("dashboard-expanded");
        toggleBtn.textContent = "â–¼";
      } else {
        content.classList.remove("dashboard-expanded");
        content.classList.add("dashboard-collapsed");
        toggleBtn.textContent = "â–²";
      }
    });
  }

  // âœ… ë°ì´í„° ë¡œë”© ìˆœì„œ (ì´ê²Œ í•µì‹¬)
await loadData();          // ë§¤ì¥
await loadVenderRegion();  // ì§€ì—­
await loadVenderMaster();  // ğŸ”¥ ì´ê±° í•„ìˆ˜

addMyLiveLocation();

});

  
/*************************************************
 * 1) ì§€ë„ ì´ˆê¸°í™”
 *************************************************/
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: false
  });

  // í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ìƒë‹¨)
  L.control.zoom({ position: "topright" }).addTo(map);

  // íƒ€ì¼ ë ˆì´ì–´
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹
  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 35
  });
  map.addLayer(markerCluster);

  // ğŸ”¥ ë‚´ ìœ„ì¹˜ ë²„íŠ¼ ì¶”ê°€ (ì—¬ê¸° ë‚´ë¶€ë¡œ ë“¤ì–´ì™€ì•¼ í•¨)
  const locateControl = L.control({ position: "bottomright" });

 locateControl.onAdd = function () {
  const btn = L.DomUtil.create('div', 'leaflet-control-locate');
  btn.innerHTML = 'ğŸ“';

btn.onclick = () => {
  if (liveWatchId === null) {
    // 1) ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì‹œì‘
    startLiveTracking();

    // 2) í´ë¦­ ìˆœê°„ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
    moveToMyLocation();

    // 3) ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
    btn.classList.add("active");
  } else {
    // ì‹¤ì‹œê°„ ì¶”ì  ì¢…ë£Œ
    stopLiveTracking();
    btn.classList.remove("active");
  }
};


  return btn;
};


  locateControl.addTo(map);
}

  function startLiveTracking() {
  if (!navigator.geolocation) {
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  if (liveWatchId !== null) {
    console.log("ì´ë¯¸ ì‹¤ì‹œê°„ ì¶”ì  ì‹¤í–‰ ì¤‘");
    return;
  }

  liveWatchId = navigator.geolocation.watchPosition(
    (pos) => {
      const { latitude, longitude, accuracy } = pos.coords;

      const zoomLevel =
        accuracy < 30 ? 17 :
        accuracy < 80 ? 15 : 13;

      if (!liveMarker) {
        liveMarker = L.circleMarker([latitude, longitude], {
          radius: 9,
          fillColor: "#3b82f6",
          color: "#ffffff",
          weight: 2,
          fillOpacity: 0.9
        }).addTo(map);

        liveMarker.bindTooltip("ğŸ“ ì‹¤ì‹œê°„ ë‚´ ìœ„ì¹˜", { permanent: false });

        map.setView([latitude, longitude], zoomLevel);
      } else {
        liveMarker.setLatLng([latitude, longitude]);
      }
    },
    (err) => {
      console.error(err);
      alert("GPS ì‹ í˜¸ê°€ ì•½í•©ë‹ˆë‹¤.");
    },
    {
      enableHighAccuracy: true,
      maximumAge: 2000,
      timeout: 15000
    }
  );
}

function stopLiveTracking() {
  if (liveWatchId !== null) {
    navigator.geolocation.clearWatch(liveWatchId);
    liveWatchId = null;

    if (liveMarker) {
      map.removeLayer(liveMarker);
      liveMarker = null;
    }
    console.log("ğŸ›‘ ì‹¤ì‹œê°„ ì¶”ì  ì¢…ë£Œ");
  }
}


  
function addMyLiveLocation() {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const { latitude, longitude, accuracy } = pos.coords;

      console.log("ğŸ“ GPS Accuracy:", accuracy, "meters");

      const zoomLevel =
        accuracy < 30 ? 17 :
        accuracy < 80 ? 15 : 13;

      // ğŸŸ¦ liveMarker ì¬ì‚¬ìš© (ì¤‘ë³µ ìƒì„± ë°©ì§€)
      if (!liveMarker) {
        liveMarker = L.circleMarker([latitude, longitude], {
          radius: 8,
          fillColor: "#3b82f6",
          color: "#ffffff",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.85
        }).addTo(map);

        liveMarker.bindTooltip(`ğŸ“ë‚´ ìœ„ì¹˜ (Â±${Math.round(accuracy)}m)`);

      } else {
        liveMarker.setLatLng([latitude, longitude]);
      }

      map.setView([latitude, longitude], zoomLevel);

      if (accuracy > 100) {
        console.warn("GPS ì‹ í˜¸ ì•½í•¨");
      }
    },
    (err) => {
      console.warn("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", err);
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );
}

      // "ë‚´ ìœ„ì¹˜" ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ì§€ë„ë§Œ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
function moveToMyLocation() {
  if (!navigator.geolocation) {
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const { latitude, longitude, accuracy } = pos.coords;

      const zoomLevel =
        accuracy < 30 ? 17 :
        accuracy < 80 ? 15 : 13;

      map.setView([latitude, longitude], zoomLevel);
    },
    (err) => {
      console.error("ìœ„ì¹˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
      alert("í˜„ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );
}


  

/*************************************************
 * 2) ì´ë²¤íŠ¸ ë“±ë¡
 *************************************************/
function initEvents() {
  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("categorySelect").addEventListener("change", applyFilters);
  document.getElementById("statusFilterSelect").addEventListener("change", applyFilters);
  document.getElementById("regionSelect").addEventListener("change", applyFilters);
  document.getElementById("sortSelect").addEventListener("change", applyFilters);
  document.getElementById("openMonthSelect").addEventListener("change", applyFilters);
  document.getElementById("statusSaveBtn").addEventListener("click", saveStatus);
  document.getElementById("memoSaveBtn").addEventListener("click", saveMemo);

  // ë‹´ë‹¹ì ì„ íƒ â†’ í•„ìˆ˜ê°’ + ìë™ ê¸°ë¡
  const managerSelect = document.getElementById("managerInput");
  managerSelect.addEventListener("change", () => {
    const manager = managerSelect.value;
    const hasManager = manager !== "";

    document.getElementById("statusSaveBtn").disabled = !hasManager;
    document.getElementById("memoSaveBtn").disabled = !hasManager;

    if (selectedStoreName && hasManager) {
      addManagerHistory(manager);
    }
  });
}

// CALL ë²„íŠ¼
document.getElementById("btnCall").addEventListener("click", () => {
  managerType = "call";
  setTypeButtonUI();
  applyManagerByType();   // â† ğŸ”¥ NEW

});

// SALES ë²„íŠ¼
document.getElementById("btnSales").addEventListener("click", () => {
  managerType = "sales";
  setTypeButtonUI();
  applyManagerByType();   // â† ğŸ”¥ NEW

});

// ë²„íŠ¼ UI ì ìš©
function setTypeButtonUI() {
  const btnCall = document.getElementById("btnCall");
  const btnSales = document.getElementById("btnSales");

  btnCall.classList.toggle("active", managerType === "call");
  btnSales.classList.toggle("active", managerType === "sales");

  btnCall.classList.toggle("inactive", managerType !== "call");
  btnSales.classList.toggle("inactive", managerType !== "sales");
}


/*************************************************
 * 3) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
 *************************************************/
async function loadData() {
  try {
    const res = await fetch(`${BASE_URL}?action=places`);
    const json = await res.json();

    rawRows = json
      .filter(r => r.lat && r.lng)
      .map(r => ({
        ...r,
        lat: Number(r.lat),
        lng: Number(r.lng),
      }));

    rawByName = {};
    rawRows.forEach(r => {
      if (r.name) rawByName[r.name] = r;
    });

    buildFilters(rawRows);
    applyFilters();

    return true;   // ğŸ”¥ ì¶”ê°€: then() ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡
  } catch (e) {
    alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!");
    console.error(e);
    return false;
  }
}

/*************************************************
 * ğŸ“¦ vender_region â†’ JS Map ë³€í™˜
 * key: sigungu|category
 *************************************************/
function buildVenderRegionMap() {
  venderRegionMap = {};

  venderRegionRows.forEach(r => {
    const sigungu  = normalizeSigungu(r.sigungu);
    const category = normalizeCategory(r.category);
    const vender   = r.vender || r.vender_name;

    if (!sigungu || !category || !vender) return;

    const key = `${sigungu}|${category}`;

    if (!venderRegionMap[key]) {
      venderRegionMap[key] = [];
    }

    venderRegionMap[key].push(r);
  });

  console.log("âœ… venderRegionMap:", venderRegionMap);
}


/*************************************************
 * ğŸ“¦ ì¶”ì²œ ìœ í†µì‚¬ ì°¾ê¸°
 *************************************************/
function findRecommendedVenders(store, limit = 3) {
  if (!store) return [];

  const sigungu = normalizeSigungu(store.sigungu);
  const storeCategory = normalizeCategory(store.category);

  // ì¤‘ìš”ë„ ë­í¬ (ì •ë ¬ìš©)
  const importanceRank = {
    "ë§¤ìš°í•„ìš”": 3,
    "í™•ì¥í•„ìš”": 2,
    "": 1
  };

  const regionVenders = venderRegionRows.filter(r =>
    normalizeSigungu(r.sigungu) === sigungu &&
    r.status === "active"
  );

  const matched = regionVenders
    .map(r => {
      const v = venderMasterMap[r.vender];
      if (!v) return null;

      // ğŸ”¥ ìœ í†µì‚¬ ë‹¤ì¤‘ ì—…ì¢… í—ˆìš©
      const categories = (v.category || "")
        .split(/[,/]/)
        .map(c => c.trim());

      const isMatch =
        categories.includes(storeCategory) ||
        categories.includes("ê³ ê¹ƒì§‘") ||
        categories.includes("í•œì‹");

      if (!isMatch) return null;

      return {
        ...v,
        importance: (r.importance || "").trim(),
        priority: Number(r.priority || 0),
        matchedCategory: categories.join(", ")
      };
    })
    .filter(Boolean)
    .sort((a, b) => {
      const ia = importanceRank[a.importance || ""] || 0;
      const ib = importanceRank[b.importance || ""] || 0;

      if (ia !== ib) return ib - ia;
      return (b.priority || 0) - (a.priority || 0);
    });

  return matched.slice(0, limit);
}





  
  /*************************************************
 * ğŸ“¦ ìœ í†µì‚¬ ì§€ì—­ ë§¤í•‘ ë¡œë“œ
 *************************************************/
async function loadVenderRegion() {
  try {
    const res = await fetch(`${BASE_URL}?action=vender_region`);
    const rows = await res.json();

    venderRegionRows = rows || [];
    buildVenderRegionMap(); // STEP 6

    console.log("âœ… vender_region loaded", venderRegionMap);
  } catch (e) {
    console.error("âŒ vender_region ë¡œë”© ì‹¤íŒ¨", e);
  }
}

/*************************************************
 * ğŸ“¦ vender (ìœ í†µì‚¬ ë§ˆìŠ¤í„°) ë¡œë“œ
 *************************************************/
async function loadVenderMaster() {
  const res = await fetch(`${BASE_URL}?action=vender`);
  const rows = await res.json();

  venderMasterMap = {};
  rows.forEach(v => {
    if (v.vender) {
      venderMasterMap[v.vender] = v;
    }
  });

  console.log("âœ… venderMasterMap", venderMasterMap);
}

  
  /*************************************************
 * ğŸ”§ ë¬¸ìì—´ ì •ê·œí™” ìœ í‹¸ (ì¤‘ìš”)
 *************************************************/
function normalizeSigungu(v) {
  return (v || "")
    .replace("ì„œìš¸íŠ¹ë³„ì‹œ", "")
    .replace("ì„œìš¸", "")
    .trim();
}

function normalizeCategory(v) {
  return (v || "").split(/[>/]/)[0].trim();
}


/*************************************************
 * 4) í•„í„° UI êµ¬ì„±
 *************************************************/
function buildFilters(rows) {
  const catSet = new Set();
  const statusSet = new Set();
  const regionSet = new Set();
  const openMonthSet = new Set();

  rows.forEach(r => {
    if (r.category) catSet.add(r.category.split(">")[0].trim());
    if (r.Status) statusSet.add(r.Status);
    if (r.sigungu) regionSet.add(r.sigungu);
    if (r.open_month && r.open_month.trim()) openMonthSet.add(r.open_month);
  });

  fillSelect("categorySelect", "ì „ì²´ ì¹´í…Œê³ ë¦¬", [...catSet]);
  fillSelect("statusFilterSelect", "ì „ì²´ ìƒíƒœ", [...statusSet]);
  fillSelect("regionSelect", "ì „ì²´ ì§€ì—­", [...regionSet]);

  // ğŸ”¥ ì—¬ê¸° ë¶€ë¶„ë§Œ ìƒˆë¡œ ì¶”ê°€ (ì‹ ê·œ ìš”ì²­ ê¸°ëŠ¥)
  const openMonthSelect = document.getElementById("openMonthSelect");
  openMonthSelect.innerHTML = `
    <option value="ALL">ì „ì²´ ë§¤ì¥</option>
    <option value="ALL_NEW">ì „ì²´ ì‹ ê·œ ë§¤ì¥</option>
    
  `;

  [...openMonthSet].sort().forEach(v => {
    openMonthSelect.insertAdjacentHTML("beforeend",
      `<option value="${v}">${v}</option>`
    );
  });
}




function fillSelect(id, label, arr) {
  const el = document.getElementById(id);
  el.innerHTML = `<option value="ALL">${label}</option>`;
  arr.sort().forEach(v =>
    el.insertAdjacentHTML("beforeend", `<option value="${v}">${v}</option>`)
  );
}

/*************************************************
 * 5) í•„í„° ì ìš©
 *************************************************/
function applyFilters() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusFilterSelect").value;
  const region = document.getElementById("regionSelect").value;
  const sortMode = document.getElementById("sortSelect").value;
  const openMonth = document.getElementById("openMonthSelect").value;

  filteredRows = rawRows.filter(r => {
    const text = `${r.name} ${r.sigungu} ${r.roadAddress} ${r.keyword}`.toLowerCase();
    const major = (r.category || "").split(">")[0].trim();

    const matchSearch = !q || text.includes(q);
    const matchCat = cat === "ALL" || major === cat;
    const matchStatus = st === "ALL" || (r.Status || "") === st;
    const matchRegion = region === "ALL" || (r.sigungu || "") === region;
    const matchOpenMonth =
  (openMonth === "ALL") ||
  (openMonth === "ALL_NEW" && (r.open_month && r.open_month !== "")) ||
  (openMonth !== "ALL_NEW" && String(r.open_month || "") === openMonth);

    return (
      matchSearch &&
      matchCat &&
      matchStatus &&
      matchRegion &&
      matchOpenMonth
    );
  });

  filteredRows = sortStores(filteredRows, sortMode);
  renderAll();
}



/*************************************************
 * 6) ì •ë ¬
 *************************************************/
function sortStores(list, mode) {
  const copy = [...list];

  if (mode === "name") {
    return copy.sort((a, b) =>
      (a.name || "").localeCompare(b.name || "", "ko")
    );
  }

  if (mode === "blog") {
    return copy.sort((a, b) => {
      const ba = Number(b.blog_count || 0);
      const aa = Number(a.blog_count || 0);
      if (ba !== aa) return ba - aa;
      return (a.name || "").localeCompare(b.name || "", "ko");
    });
  }

  // default: ì¦ê²¨ì°¾ê¸° â†’ ìƒíƒœ â†’ ì´ë¦„
  return copy.sort((a, b) => {
    if (a.favorite !== b.favorite) return a.favorite ? -1 : 1;
    const sa = a.Status || "";
    const sb = b.Status || "";
    if (sa !== sb) return sa.localeCompare(sb, "ko");
    return (a.name || "").localeCompare(b.name || "", "ko");
  });
}

/*************************************************
 * 7) ì „ì²´ ë Œë”ë§
 *************************************************/
function renderAll() {
  renderMarkers();
  renderStoreList();
  renderStats();
}

/*************************************************
 * 8) ë§ˆì»¤ ì•„ì´ì½˜
 *************************************************/
function createMarkerIcon(store, favorite = false, selected = false) {
  const size = selected ? 26 : 18;
const borderColor = "#ffffff";

  // â­ ì‹ ê·œ ë§¤ì¥(ì˜¤í”ˆì›” ì¡´ì¬) â†’ ë³„ ëª¨ì–‘
  if (store.open_month && store.open_month.trim() !== "") {
    return L.divIcon({
      className: "custom-marker",
      html: `
        <div style="
          width:${size}px;
          height:${size}px;
          color:#8b5cf6;
          font-size:${size}px;
          text-shadow: -1px -1px 0 white, 
                        1px -1px 0 white, 
                       -1px  1px 0 white, 
                        1px  1px 0 white;
          display:flex;
          justify-content:center;
          align-items:center;
        ">
          â˜…
        </div>
      `,
      iconSize: [size, size],
      iconAnchor: [size / 2, size / 2]
    });
  }

  // ê¸°ì¡´ ìƒíƒœ ìƒ‰ìƒ ë¡œì§
  const STATUS_COLOR = {
    "ì»¨í…": "#5DADE2",
    "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
    "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
    "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
    "ê±°ì ˆ": "#e74c3c"
  };

  const color = STATUS_COLOR[store.Status] || "#7f8c8d";

  return L.divIcon({
    className: "custom-marker",
    html: `
      <div class="marker-dot"
           style="
              background:${color};
              border-color:${borderColor};
              width:${size}px;
              height:${size}px;
              border-radius:999px;
              border:2px solid ${borderColor};
           ">
      </div>`,
    iconSize: [size + 4, size + 4],
    iconAnchor: [(size + 4) / 2, (size + 4) / 2]
  });
}



/*************************************************
 * 9) ë§ˆì»¤ ë Œë”ë§
 *************************************************/
function renderMarkers() {
  markerCluster.clearLayers();
  markersByName = {};

  filteredRows.forEach(store => {
    const marker = L.marker([store.lat, store.lng], {
    icon: createMarkerIcon(store, store.favorite, store.name === selectedStoreName)
    });

    marker.bindTooltip(store.name || "", {
      permanent: false,
      direction: "top",
      offset: [0, -8]
    });

    marker.on("click", () => focusOnStore(store));

    markerCluster.addLayer(marker);
    markersByName[store.name] = marker;
  });

  document.getElementById("storeCountLabel").textContent =
    `${filteredRows.length.toLocaleString()}ê°œ ë§¤ì¥`;

  if (filteredRows.length > 0) {
    const group = L.featureGroup(markerCluster.getLayers());
    map.fitBounds(group.getBounds().pad(0.15));
  }
}

/*************************************************
 * 10) ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
 *************************************************/
function renderStoreList() {
  const listEl = document.getElementById("storeList");
  listEl.innerHTML = "";

  filteredRows.slice(0, 500).forEach(store => {
    const isNew = store.open_month && store.open_month !== "";  // â† ì—¬ê¸°!

    const li = document.createElement("li");
    li.className = "store-item";

    const major = (store.category || "").split(">")[0] || "-";

    li.innerHTML = `
      <div class="store-header">
        <div class="store-name">${store.name || "ë§¤ì¥ëª… ì—†ìŒ"}</div>
      </div>
      <div class="store-meta-line">
        <span class="status-badge">${store.Status || "ìƒíƒœ ì—†ìŒ"}</span>
        <span class="meta-text">${store.sigungu || ""} Â· ${major}</span>
      </div>
      <div class="store-meta-address">${store.roadAddress || ""}</div>
    `;

    li.addEventListener("click", () => focusOnStore(store));


    listEl.appendChild(li);
  });
}

/*************************************************
 * 11) ë§¤ì¥ ì„ íƒ
 *************************************************/
function focusOnStore(store) {
  selectedStoreName = store.name;

  document.getElementById("historyList").innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  
  if (!isNaN(store.lat) && !isNaN(store.lng)) {
    map.setView([store.lat, store.lng], 17);
  }

  Object.keys(markersByName).forEach(name => {
   const row = rawByName[name];
   markersByName[name].setIcon(
    createMarkerIcon(row, row.favorite, name === selectedStoreName)
  );
});


showStoreDetail(store);
renderRecommendedVender(store);
setStatusDropdown(store);
applyManagerByType();   // ë‹´ë‹¹ì ì…‹ì—… ë¨¼ì €
loadHistory(store.name);   // íˆìŠ¤í† ë¦¬ ìµœì¢… í˜¸ì¶œ (ë®ì–´ì“°ê¸° ë°©ì§€)

}
/*************************************************
 * ğŸ”¥ ë‹´ë‹¹ì ìë™ ë³€ê²½ í•¨ìˆ˜
 *************************************************/
function applyManagerByType() {
  if (!selectedStoreName) return;

  const row = rawByName[selectedStoreName];
  const mgrSelect = document.getElementById("managerInput");

  // ê¸°ë³¸ê°’ ì´ˆê¸°í™”
  mgrSelect.value = "";

  if (managerType === "call" && row["Manager(Call)"]) {
    mgrSelect.value = row["Manager(Call)"];
  }
  if (managerType === "sales" && row["Manager(Sales)"]) {
    mgrSelect.value = row["Manager(Sales)"];
  }
  mgrSelect.dispatchEvent(new Event("change"));
}
/*************************************************
 * 12) ìƒì„¸ì •ë³´ í‘œì‹œ
 *************************************************/
function showStoreDetail(r) {
  const box = document.getElementById("storeDetailBody");
  if (!r) {
    box.textContent = "ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
    return;
  }

  const major = (r.category || "").split(">")[0] || "-";

  let url = r.URL || r.url || "";
  if (url && !/^https?:\/\//i.test(url)) url = "https://" + url;

  const urlHtml = url
    ? `<a href="${url}" target="_blank" style="color:#2563eb;font-weight:600;">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—´ê¸°</a>`
    : "-";

  box.innerHTML = `
    <div class="detail-name">${r.name || ""}</div>
    <div class="info-item"><span>ğŸ  ì£¼ì†Œ</span>${r.roadAddress || "-"}</div>
    <div class="info-item"><span>ğŸ“ ì§€ì—­</span>${r.sigungu || "-"}</div>
    <div class="info-item"><span>ğŸ½ ì—…ì¢…</span>${major}</div>
    <div class="info-item"><span>â­ ìƒíƒœ</span>${r.Status || "-"}</div>
    <div class="info-item"><span>ğŸ“í‚¤ì›Œë“œ</span>${r.keyword || "-"}</div>
    <div class="info-item"><span>ğŸ”— ë§í¬</span>${urlHtml}</div>
  `;
}


  
/*************************************************
 * ğŸ“¦ ì¶”ì²œ ìœ í†µì‚¬ ë Œë”ë§
 *************************************************/
function renderRecommendedVender(store) {
  const section = document.getElementById("venderSection");
  const card = document.getElementById("venderCard");

  const venders = findRecommendedVenders(store, 3);

  if (!store || !venders.length) {
    section.style.display = "none";
    card.innerHTML = "";
    return;
  }

  section.style.display = "block";
  card.innerHTML = "";

  // â­ 1) ëŒ€í‘œ ì¶”ì²œ
  const main = venders[0];

const importanceRaw = String(main.importance ?? "").trim();

let importanceLabel = "ë³´í†µ";
let importanceClass = "badge-priority";

if (importanceRaw === "ë§¤ìš°í•„ìš”") {
  importanceLabel = "ë§¤ìš°í•„ìš”";
  importanceClass = "badge-important";
} else if (importanceRaw === "í™•ì¥í•„ìš”") {
  importanceLabel = "í™•ì¥í•„ìš”";
  importanceClass = "badge-priority";
}


 card.innerHTML += `
  <div style="margin-bottom:14px;">
    <div style="font-size:13px; font-weight:700; margin-bottom:6px;">
      â­ ëŒ€í‘œ ì¶”ì²œ
    </div>

    <div style="font-size:15px; font-weight:800;">
      ${main.vender_name}${main.link_number ? ` Â· ${main.link_number}` : ""}
    </div>

    ${main.phone ? `<div style="font-size:12px;">${main.phone}</div>` : ""}
    ${main.strengths ? `<div style="font-size:12px; margin-top:4px;">${main.strengths}</div>` : ""}
    ${main.desc ? `<div style="font-size:12px; color:#6b7280;">${main.desc}</div>` : ""}

    <div style="margin-top:6px;">
      <span class="vender-badge ${importanceClass}">
        ${importanceLabel}
      </span>
      <span class="vender-badge badge-priority">
        ìš°ì„ ìˆœìœ„ ${main.priority ?? "-"}
      </span>
    </div>

    <!-- âœ… QR + ì„¤ì¹˜ ì™„ë£Œ ë²„íŠ¼ -->
    <div style="margin-top:10px; display:flex; gap:8px;">
      
      <!-- QR ë²„íŠ¼ -->
      ${main.qr_url ? `
        <a href="${main.qr_url}" target="_blank"
           style="
             flex:1;
             text-align:center;
             padding:8px 10px;
             border-radius:8px;
             background:#111827;
             color:white;
             font-size:12px;
             font-weight:700;
             text-decoration:none;
           ">
          ğŸ“± QR ì—´ê¸°
        </a>
      ` : ""}

      <!-- ì„¤ì¹˜ ì™„ë£Œ ë²„íŠ¼ -->
      <button
        onclick="confirmVenderInstalled('${main.vender_name}')"
        style="
          flex:1;
          padding:8px 10px;
          border-radius:8px;
          border:none;
          background:#2563eb;
          color:white;
          font-size:12px;
          font-weight:700;
          cursor:pointer;
        ">
        âœ” ì„¤ì¹˜ ì™„ë£Œ
      </button>
    </div>
  </div>
`;


  // ğŸ‘ 2) ëŒ€ì•ˆ ì¶”ì²œ (ë”ë³´ê¸°)
  const alternatives = venders.slice(1);
  if (!alternatives.length) return;

  const altId = "altVenderBox";

  card.innerHTML += `
    <div>
      <div
        style="cursor:pointer; font-size:13px; font-weight:700; color:#2563eb;"
        onclick="document.getElementById('${altId}').classList.toggle('hidden')"
      >
        ğŸ”½ ëŒ€ì•ˆ ì¶”ì²œ ë”ë³´ê¸° (${alternatives.length})
      </div>

      <div id="${altId}" class="hidden" style="margin-top:8px;">
       ${alternatives.map(v => `
  <div style="padding:10px; border-top:1px dashed #e5e7eb;">

    <!-- ìœ í†µì‚¬ ì´ë¦„ -->
    <div style="font-weight:700; font-size:14px;">
      ${v.vender_name}${v.link_number ? ` Â· ${v.link_number}` : ""}
    </div>

    <!-- ê°•ì  -->
    ${v.strengths ? `
      <div style="font-size:12px; margin-top:2px;">
        ${v.strengths}
      </div>
    ` : ""}

    <!-- ì¤‘ìš”ë„ / ìš°ì„ ìˆœìœ„ -->
    <div style="margin-top:6px;">
      ${v.importance ? `
        <span class="vender-badge ${
          v.importance === "ë§¤ìš°í•„ìš”"
            ? "badge-important"
            : "badge-priority"
        }">
          ${v.importance}
        </span>
      ` : ""}
      <span class="vender-badge badge-priority">
        ìš°ì„ ìˆœìœ„ ${v.priority ?? "-"}
      </span>
    </div>

    <!-- ğŸ”¥ QR + ì„¤ì¹˜ ë²„íŠ¼ (ì—¬ê¸°ê°€ í•µì‹¬) -->
    <div style="display:flex; gap:6px; margin-top:8px;">

      ${v.qr_url ? `
        <a href="${v.qr_url}" target="_blank"
           style="
             flex:1;
             text-align:center;
             padding:6px 8px;
             border-radius:6px;
             background:#374151;
             color:white;
             font-size:12px;
             font-weight:700;
             text-decoration:none;
           ">
          ğŸ“± QR ì—´ê¸°
        </a>
      ` : ""}

      <button
        onclick="confirmVenderInstalled('${v.vender_name}')"
        style="
          flex:1;
          padding:6px 8px;
          border-radius:6px;
          border:none;
          background:#2563eb;
          color:white;
          font-size:12px;
          font-weight:700;
          cursor:pointer;
        ">
        âœ” ì„¤ì¹˜ ì™„ë£Œ
      </button>
    </div>

  </div>
`).join("")}
  </div>
  </div>
`;






  
/*************************************************
 * â­ ìƒíƒœ ë“œë¡­ë‹¤ìš´ ê°’ ì„¸íŒ… í•¨ìˆ˜ ì¶”ê°€ ìœ„ì¹˜
 *************************************************/
function setStatusDropdown(store) {
  const select = document.getElementById("statusChangeSelect");
  select.value = store.Status || "";
}
/*************************************************
 * 13) ìƒíƒœ ë“œë¡­ë‹¤ìš´ ê°’ ì„¸íŒ…
 *************************************************/
function saveStatus() {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const manager = document.getElementById("managerInput").value.trim();
  if (!manager) return alert("ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

  const newStatus = document.getElementById("statusChangeSelect").value;
  if (!newStatus) return alert("ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

  const qs = new URLSearchParams({
    action: "updateStatus",
    name: selectedStoreName,
    status: newStatus,
    manager: manager,
    managerType: managerType
  });

  document.getElementById("historyList").innerHTML = "â³ ì €ì¥ ì¤‘...";

 fetch(`${BASE_URL}?${qs.toString()}`)
  .then(() => {

    // update local model only
    rawByName[selectedStoreName].Status = newStatus;
    rawRows = rawRows.map(r => r.name === selectedStoreName ? { ...r, Status: newStatus } : r);

    // ë§ˆì»¤ ìƒ‰ìƒë§Œ ë³€ê²½ (ì „ì²´ ì¬ëœë” NO)
    const marker = markersByName[selectedStoreName];
    if (marker) {
      marker.setIcon(createMarkerIcon(rawByName[selectedStoreName], false, true));
    }

    // ë¦¬ìŠ¤íŠ¸ & í†µê³„ë§Œ ì—…ë°ì´íŠ¸ (ì§€ë„ëŠ” ìœ ì§€)
    renderStoreList();
    renderStats();

    loadHistory(selectedStoreName);
    showToast("âœ” ìƒíƒœ ë³€ê²½ ì™„ë£Œ");
  });
}



/*************************************************
 * 15) íˆìŠ¤í† ë¦¬ ë¡œë”©
 *************************************************/
function loadHistory(name) {
  const listEl = document.getElementById("historyList");
  listEl.innerHTML = "<div class='history-empty'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";


  fetch(`${BASE_URL}?action=history&name=${encodeURIComponent(name)}`)
    .then(res => res.json())
    .then(items => {
      if (!Array.isArray(items) || items.length === 0) {
        listEl.innerHTML = `<div class="history-empty">íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      listEl.innerHTML = items
        .map(it => `
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-date">${it.date}</div>
            <div class="timeline-card">
              <div class="timeline-manager">${it.manager || "-"}</div>
              <div class="timeline-memo">${it.memo || ""}</div>
            </div>
          </div>
        `)
        .join("");
    })
    .catch(() => {
      listEl.innerHTML = `<div class="history-empty">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
    });
}

/*************************************************
 * 16) ë©”ëª¨ ì €ì¥
 *************************************************/
function saveMemo() {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const manager = document.getElementById("managerInput").value.trim();
  if (!manager) return alert("ë‹´ë‹¹ìë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

  const memo = document.getElementById("memoInput").value.trim();
  if (!memo) return alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  document.getElementById("historyList").innerHTML = "ì €ì¥ ì¤‘...";

  fetch(`${BASE_URL}?action=addMemo&name=${encodeURIComponent(selectedStoreName)}&memo=${encodeURIComponent(memo)}&manager=${encodeURIComponent(manager)}`)
   .then(() => {
    loadHistory(selectedStoreName);  // íˆìŠ¤í† ë¦¬ë§Œ ì—…ë°ì´íŠ¸
    document.getElementById("memoInput").value = "";
    showToast("âœ” ë©”ëª¨ ì €ì¥ ì™„ë£Œ");
    });
}

function confirmVenderInstalled(venderName) {
  if (!selectedStoreName) return alert("ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");

  if (!confirm("ì„¤ì¹˜ ì™„ë£Œë¡œ ê¸°ë¡í• ê¹Œìš”?")) return;

  const qs = new URLSearchParams({
    action: "installVender",
    name: selectedStoreName,
    vender_name: venderName
  });

  fetch(`${BASE_URL}?${qs.toString()}`)
    .then(() => {

      // âœ… 1) ë¡œì»¬ ëª¨ë¸ ì¦‰ì‹œ ë°˜ì˜
      const now = new Date().toISOString().slice(0, 19).replace("T", " ");
      rawByName[selectedStoreName].Vender_name = venderName;
      rawByName[selectedStoreName].App_Installed_Date = now;

      // âœ… 2) ì¶”ì²œ ì¹´ë“œ ì¦‰ì‹œ ì„¤ì¹˜ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
      renderRecommendedVender(rawByName[selectedStoreName]);

      // âœ… 3) ìƒíƒœê°’ ìë™ "ì œì•ˆ"
      const statusSelect = document.getElementById("statusChangeSelect");

      // ê¸°ë³¸ ì¶”ì²œ ìƒíƒœ
      if (!statusSelect.value) {
        statusSelect.value = "ë¯¸íŒ… ì™„ë£Œ";
      }

      // ë²„íŠ¼ í™œì„±í™”
      document.getElementById("statusSaveBtn").disabled = false;

      // íˆìŠ¤í† ë¦¬ ê°±ì‹ 
      loadHistory(selectedStoreName);

      showToast("âœ” ì„¤ì¹˜ ì™„ë£Œ ê¸°ë¡ë¨ Â· ìƒíƒœ ë³€ê²½ì„ ì¶”ì²œí•©ë‹ˆë‹¤");
    });
}


  
/*************************************************
 * 18) ë‹´ë‹¹ì ìë™ íˆìŠ¤í† ë¦¬ ê¸°ë¡
 *************************************************/
function addManagerHistory(manager) {
  // ğŸ”¥ ë‹´ë‹¹ì ë³€ê²½ ì‹œ íˆìŠ¤í† ë¦¬ë¥¼ ë‚¨ê¸°ì§€ ì•ŠìŒ
  return;
}

/*************************************************
 * ğŸ”¥ ê³µí†µ íˆìŠ¤í† ë¦¬ UI ì‚½ì… í•¨ìˆ˜
 *************************************************/
function insertHistoryUI(date, manager, memo) {
  const listEl = document.getElementById("historyList");

  listEl.insertAdjacentHTML(
    "afterbegin",
    `
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-date">${date}</div>
        <div class="timeline-card">
          <div class="timeline-manager">${manager}</div>
          <div class="timeline-memo">${memo}</div>
        </div>
      </div>
    `
  );
}

/*************************************************
 * 19) í†µê³„/ì°¨íŠ¸
 *************************************************/
function renderStats() {
const stats = {
  total: filteredRows.length,
  contact: 0,
  deal: 0,
  meetingDone: 0,
  request: 0,
  noAnswer: 0,
  reject: 0
};

filteredRows.forEach(r => {
  if (r.Status === "ì»¨í…") stats.contact++;
  else if (r.Status === "ê±°ë˜ ì„±ì‚¬") stats.deal++;
  else if (r.Status === "ë¯¸íŒ… ì™„ë£Œ") stats.meetingDone++;
  else if (r.Status === "ë¯¸íŒ… ìš”ì²­") stats.request++;
  else if (r.Status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") stats.noAnswer++;
  else if (r.Status === "ê±°ì ˆ") stats.reject++;
});


  const total = stats.total || 1;
  const pct = v => ((v / total) * 100).toFixed(1);

  document.getElementById("statTotal").textContent = stats.total.toLocaleString();
  document.getElementById("statDeal").textContent = stats.deal.toLocaleString();
  document.getElementById("statMeetingDone").textContent = stats.meetingDone.toLocaleString();
  document.getElementById("statRequest").textContent = stats.request.toLocaleString();
  document.getElementById("statNoAnswer").textContent = stats.noAnswer.toLocaleString();
  document.getElementById("statReject").textContent = stats.reject.toLocaleString();

  document.getElementById("statDealPct").textContent = `${pct(stats.deal)}%`;
  document.getElementById("statMeetingDonePct").textContent = `${pct(stats.meetingDone)}%`;
  document.getElementById("statRequestPct").textContent = `${pct(stats.request)}%`;
  document.getElementById("statNoAnswerPct").textContent = `${pct(stats.noAnswer)}%`;
  document.getElementById("statRejectPct").textContent = `${pct(stats.reject)}%`;

  document.getElementById("statContact").textContent = stats.contact.toLocaleString();
  document.getElementById("statContactPct").textContent = `${pct(stats.contact)}%`;


  if (chartInstance) chartInstance.destroy();

  const ctx = document.getElementById("statusChart");
  chartInstance = new Chart(ctx, {
    type: "doughnut",
    data: {
   labels: ["ì»¨í…","ë¯¸íŒ… ìš”ì²­","ë¯¸íŒ… ì™„ë£Œ","ê±°ë˜ ì„±ì‚¬","ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ","ê±°ì ˆ"],
   datasets: [{
       data: [
    stats.contact, stats.request, stats.meetingDone,
    stats.deal, stats.noAnswer, stats.reject
  ],
  backgroundColor: ["#5DADE2","#f1c40f","#3498db","#2ecc71","#95a5a6","#e74c3c"]
}]

    },
    options: {
      cutout: "65%",
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });

document.getElementById("chartStats").innerHTML = `
  <div><b>ì»¨í…:</b> ${stats.contact}ê°œ (${pct(stats.contact)}%)</div>
  <div><b>ë¯¸íŒ… ìš”ì²­:</b> ${stats.request}ê°œ (${pct(stats.request)}%)</div>
  <div><b>ë¯¸íŒ… ì™„ë£Œ:</b> ${stats.meetingDone}ê°œ (${pct(stats.meetingDone)}%)</div>
  <div><b>ê±°ë˜ ì„±ì‚¬:</b> ${stats.deal}ê°œ (${pct(stats.deal)}%)</div>
  <div><b>ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ:</b> ${stats.noAnswer}ê°œ (${pct(stats.noAnswer)}%)</div>
  <div><b>ê±°ì ˆ:</b> ${stats.reject}ê°œ (${pct(stats.reject)}%)</div>
`;

}
</script>


</body>
</html>
