<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sales Store Map Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
        system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ìƒë‹¨ ë°” */
    header {
      padding: 10px 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      white-space: nowrap;
    }
    .header-controls {
      display: flex;
      gap: 8px;
      flex: 1;
      align-items: center;
      position: relative;
    }
    .search-input,
    .select-input {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }
    .search-input { flex: 1; }

    /* ë ˆì´ì•„ì›ƒ */
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 300px;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    /* ì¢Œì¸¡ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ */
    .store-panel {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
    }
    .store-panel h2 {
      font-size: 14px;
      margin: 0 0 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .store-count {
      font-size: 11px;
      color: #6b7280;
    }
    .store-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .store-item {
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 6px;
      border: 1px solid transparent;
      background: #ffffff;
      transition: background 0.12s ease, border-color 0.12s ease,
        box-shadow 0.12s ease, transform 0.12s ease;
    }
    .store-item:hover {
      background: #f3f4ff;
      border-color: #e0e7ff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
      transform: translateY(-1px);
    }
    .store-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .store-meta {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      color: #ffffff;
    }

    /* ì§€ë„ */
    #map {
      width: 100%;
      height: 100%;
    }

    /* ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ */
    .dashboard-panel {
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
    }
    .dashboard-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-wrapper {
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px;
      margin-bottom: 8px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-top: 6px;
    }
    .stat-card {
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
    }
    .stat-label {
      font-size: 10px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 13px;
      font-weight: 700;
    }

    .section-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 10px;
      margin-top: 8px;
      font-size: 12px;
    }
    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .store-detail-line {
      margin-bottom: 3px;
    }
    .store-detail-line span {
      font-weight: 600;
      margin-right: 4px;
    }

    .status-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      font-size: 12px;
      background: #ffffff;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .history-list {
      max-height: 130px;
      overflow-y: auto;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      font-size: 11px;
    }
    .history-item {
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-meta {
      color: #6b7280;
      font-size: 10px;
      margin-bottom: 2px;
    }

    .memo-textarea {
      width: 100%;
      min-height: 60px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 12px;
      resize: vertical;
    }

    .autocomplete {
      position: absolute;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      width: 260px;
      max-height: 220px;
      overflow-y: auto;
      z-index: 50;
      border-radius: 8px;
      display: none;
      top: 34px;
      right: 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .autocomplete-item {
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .autocomplete-item:hover {
      background: #f3f4f6;
    }

    /* ë§ˆì»¤ */
    .marker-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
    }
    .marker-dot.selected {
      width: 26px;
      height: 26px;
      border-width: 3px;
      box-shadow: 0 0 10px rgba(0,0,0,0.35);
      animation: pop 0.18s ease-out;
    }
    @keyframes pop {
      0% { transform: scale(0.2); }
      80% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    .store-panel::-webkit-scrollbar,
    .dashboard-panel::-webkit-scrollbar {
      width: 6px;
    }
    .store-panel::-webkit-scrollbar-thumb,
    .dashboard-panel::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 0 minmax(0, 1fr) 0;
      }
      .store-panel { display: none; }
      .dashboard-panel {
        position: absolute;
        right: 0;
        top: 52px;
        bottom: 0;
        width: 280px;
        z-index: 20;
        box-shadow: -4px 0 12px rgba(0,0,0,0.08);
      }
    }
  </style>
</head>
<body>
<header>
  <h1>ğŸ“ Sales Store Map Dashboard</h1>
  <div class="header-controls">
    <!-- ìƒë‹¨: ìƒíƒœ â†’ ì¹´í…Œê³ ë¦¬ â†’ ê²€ìƒ‰ -->
    <select id="statusSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="ë§¤ì¥ëª… / ì§€ì—­ / ë„ë¡œëª…ì£¼ì†Œ / í‚¤ì›Œë“œ ê²€ìƒ‰"
    />
    <div id="autocomplete" class="autocomplete"></div>
  </div>
</header>

<div class="layout">
  <!-- ì¢Œì¸¡ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
  <aside class="store-panel">
    <h2>
      â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸
      <span class="store-count" id="storeCountLabel"></span>
    </h2>
    <ul id="storeList" class="store-list"></ul>
  </aside>

  <!-- ì§€ë„ -->
  <main>
    <div id="map"></div>
  </main>

  <!-- ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ -->
  <aside class="dashboard-panel">
    <div class="dashboard-title">
      <span>ğŸ“Š ëŒ€ì‹œë³´ë“œ</span>
      <span id="currentStoreLabel" style="font-size:11px;color:#6b7280;"></span>
    </div>

    <!-- 1) ë„ë„› ì°¨íŠ¸ -->
    <div class="chart-wrapper">
      <canvas id="statusChart" style="width:100%;height:170px;"></canvas>

      <!-- 2) ìˆ«ì ì¹´ìš´íŠ¸ -->
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-label">ì´ ë§¤ì¥ ìˆ˜</div>
          <div class="stat-value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ê±°ë˜ ì„±ì‚¬</div>
          <div class="stat-value" id="statDeal">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ë¯¸íŒ… ì™„ë£Œ</div>
          <div class="stat-value" id="statMeetingDone">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ë¯¸íŒ… ìš”ì²­</div>
          <div class="stat-value" id="statRequest">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
          <div class="stat-value" id="statNoAnswer">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ê±°ì ˆ</div>
          <div class="stat-value" id="statReject">0</div>
        </div>
      </div>
    </div>

    <!-- 3) ë§¤ì¥ ìƒì„¸ì •ë³´ -->
    <div class="section-card" id="storeDetailCard">
      <div class="section-title">ğŸ“Œ ë§¤ì¥ ìƒì„¸ì •ë³´</div>
      <div id="storeDetailBody" style="font-size:12px;color:#4b5563;">
        ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- 4) ìƒíƒœ ë³€ê²½ ë“œë¡­ë‹¤ìš´ -->
    <div class="section-card">
      <div class="section-title">
        <span>âœ… ìƒíƒœ ë³€ê²½</span>
      </div>
      <select id="statusChangeSelect" class="status-select" disabled>
        <option value="">ë§¤ì¥ ì„ íƒ í•„ìš”</option>
        <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
        <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
        <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
        <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
        <option value="ê±°ì ˆ">ê±°ì ˆ</option>
      </select>
      <div style="margin-top:6px;text-align:right;">
        <button id="statusChangeBtn" class="btn btn-primary" disabled>
          ìƒíƒœ ë³€ê²½ ì €ì¥
        </button>
      </div>
    </div>

    <!-- 5) íˆìŠ¤í† ë¦¬ ë¡œê·¸ -->
    <div class="section-card">
      <div class="section-title">
        <span>ğŸ“ íˆìŠ¤í† ë¦¬ ë¡œê·¸</span>
      </div>
      <div id="historyList" class="history-list">
        íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.
      </div>
    </div>

    <!-- 6) ë©”ëª¨ ì…ë ¥ -->
    <div class="section-card">
      <div class="section-title">
        <span>âœï¸ ë©”ëª¨ ì¶”ê°€</span>
      </div>
      <textarea
        id="memoInput"
        class="memo-textarea"
        placeholder="íˆìŠ¤í† ë¦¬ì— ë‚¨ê¸¸ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        disabled
      ></textarea>
      <div style="margin-top:6px;text-align:right;">
        <button id="memoSaveBtn" class="btn btn-primary" disabled>
          ë©”ëª¨ ì €ì¥
        </button>
      </div>
    </div>
  </aside>
</div>

<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// â­ ë‘ì˜ë‹˜ Apps Script WebApp ê¸°ë³¸ URL (ë§ˆì§€ë§‰ /exec ê¹Œì§€)
// ì˜ˆì‹œ: const API_BASE = "https://script.google.com/macros/s/AKfycbz3V3zX-.../exec";
const API_BASE =
  "https://script.google.com/macros/s/AKfycbz3V3zX-zdYbwajKaZjktsClGesOFEoTHqDsHHFrWdr6BdbYmgDPaXiNbYH5gNNtTVv/exec";

let rawRows = [];
let filteredRows = [];
let map, markerCluster, chartInstance;
let allMarkers = [];         // rowë³„ ë§ˆì»¤
let selectedMarker = null;
let currentStore = null;

// ìƒíƒœë³„ ìƒ‰ìƒ
const STATUS_COLOR = {
  "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
  "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
  "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
  "ê±°ì ˆ": "#e74c3c"
};

// ì´ˆê¸°í™”
window.addEventListener("load", async () => {
  initMap();
  initEvents();
  loadFilters();
  await loadData();
});

// ì§€ë„ ìƒì„±
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: true
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 40
  });
  map.addLayer(markerCluster);
}

// ì´ë²¤íŠ¸
function initEvents() {
  document.getElementById("searchInput").addEventListener("input", () => {
    applyFilters();
    saveFilters();
    showAutocomplete();
  });
  document.getElementById("categorySelect").addEventListener("change", () => {
    applyFilters();
    saveFilters();
  });
  document.getElementById("statusSelect").addEventListener("change", () => {
    applyFilters();
    saveFilters();
  });

  // ìƒíƒœ ë³€ê²½ ì €ì¥
  document.getElementById("statusChangeBtn").addEventListener("click", onClickStatusChange);
  // ë©”ëª¨ ì €ì¥
  document.getElementById("memoSaveBtn").addEventListener("click", onClickMemoSave);
}

// ë°ì´í„° ë¡œë“œ
async function loadData() {
  try {
    const res = await fetch(`${API_BASE}?action=places`);
    const json = await res.json();

    rawRows = json.filter(r => r.lat && r.lng);
    buildFilters(rawRows);
    applyFilters();
  } catch (e) {
    console.error("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", e);
    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

// í•„í„° ì˜µì…˜ êµ¬ì„±
function buildFilters(rows) {
  const categorySelect = document.getElementById("categorySelect");
  const statusSelect = document.getElementById("statusSelect");

  const categorySet = new Set();
  const statusSet = new Set();

  rows.forEach(r => {
    if (r.category) {
      const major = r.category.split(">")[0].trim();
      categorySet.add(major);
    }
    if (r.Status) {
      statusSet.add(r.Status);
    }
  });

  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
  const savedCat = categorySelect.value;
  categorySelect.innerHTML = '<option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>';
  Array.from(categorySet).sort().forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
  if (savedCat) categorySelect.value = savedCat;

  // ìƒíƒœ ì˜µì…˜
  const savedSt = statusSelect.value;
  statusSelect.innerHTML = '<option value="ALL">ì „ì²´ ìƒíƒœ</option>';
  Array.from(statusSet).forEach(st => {
    const opt = document.createElement("option");
    opt.value = st;
    opt.textContent = st;
    statusSelect.appendChild(opt);
  });
  if (savedSt) statusSelect.value = savedSt;
}

// í•„í„° ì ìš©
function applyFilters() {
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusSelect").value;

  filteredRows = rawRows.filter(r => {
    const text = [
      r.name || "",
      r.sigungu || "",
      r.roadAddress || "",
      r.keyword || ""
    ].join(" ").toLowerCase();
    const matchSearch = !q || text.includes(q);

    const major = r.category ? r.category.split(">")[0].trim() : "ê¸°íƒ€";
    const matchCat = cat === "ALL" || major === cat;
    const matchStatus = st === "ALL" || (r.Status || "") === st;

    return matchSearch && matchCat && matchStatus;
  });

  renderAll();
  updateCurrentStoreLabel();
}

function renderAll() {
  renderMarkers();
  renderStoreList();
  renderStats();
}

/* ë§ˆì»¤ ê´€ë ¨ */
function createMarkerIcon(status, selected = false) {
  const color = STATUS_COLOR[status] || "#7f8c8d";
  const cls = selected ? "marker-dot selected" : "marker-dot";
  return L.divIcon({
    className: "",
    html: `<div class="${cls}" style="background:${color};"></div>`,
    iconSize: selected ? [26, 26] : [18, 18],
    iconAnchor: selected ? [13, 13] : [9, 9]
  });
}

function renderMarkers() {
  markerCluster.clearLayers();
  allMarkers = [];
  selectedMarker = null;

  filteredRows.forEach(r => {
    const lat = Number(r.lat);
    const lng = Number(r.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const marker = L.marker([lat, lng], {
      icon: createMarkerIcon(r.Status, false)
    });

    marker._store = r;

    marker.on("click", () => {
      onSelectStore(r, marker);
    });

    markerCluster.addLayer(marker);
    allMarkers.push(marker);
  });

  if (filteredRows.length > 0) {
    const group = L.featureGroup(allMarkers);
    map.fitBounds(group.getBounds().pad(0.1));
  }
}

/* ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ */
function renderStoreList() {
  const listEl = document.getElementById("storeList");
  const countLabel = document.getElementById("storeCountLabel");
  listEl.innerHTML = "";

  countLabel.textContent = `${filteredRows.length.toLocaleString()}ê°œ ë§¤ì¥`;

  filteredRows.slice(0, 300).forEach(r => {
    const li = document.createElement("li");
    li.className = "store-item";

    const statusColor = STATUS_COLOR[r.Status] || "#6b7280";

    li.innerHTML = `
      <div class="store-name">
        <span>${r.name || "ë§¤ì¥ëª… ì—†ìŒ"}</span>
        ${r.Status ? `<span class="status-badge" style="background:${statusColor};">${r.Status}</span>` : ""}
      </div>
      <div class="store-meta">
        ${(r.sigungu || "")} Â· ${(r.category || "").split(">")[0] || ""} 
      </div>
      <div class="store-meta">${r.roadAddress || ""}</div>
    `;

    li.addEventListener("click", () => {
      // í•´ë‹¹ ë§¤ì¥ ë§ˆì»¤ ì°¾ê¸°
      const marker = allMarkers.find(m => m._store && m._store.name === r.name);
      onSelectStore(r, marker);
    });

    listEl.appendChild(li);
  });
}

/* ë§¤ì¥ ì„ íƒ ê³µí†µ ì²˜ë¦¬ */
function onSelectStore(store, marker) {
  currentStore = store;
  updateCurrentStoreLabel();
  highlightMarker(marker, store.Status);
  showStoreDetail(store);
  enableStoreControls(true);
  loadHistory(store.name);

  if (marker) {
    const latlng = marker.getLatLng();
    map.setView(latlng, 17, { animate: true });
  }
}

function highlightMarker(marker, status) {
  // ë‹¤ë¥¸ ë§ˆì»¤ëŠ” ëª¨ë‘ ê¸°ë³¸ ì•„ì´ì½˜ìœ¼ë¡œ
  allMarkers.forEach(m => {
    const st = (m._store && m._store.Status) || status;
    m.setIcon(createMarkerIcon(st, false));
  });

  // ì„ íƒ ë§ˆì»¤ë§Œ ê°•ì¡°
  if (marker) {
    marker.setIcon(createMarkerIcon(status, true));
    selectedMarker = marker;
  }
}

/* ìƒì„¸ì •ë³´ í‘œì‹œ */
function showStoreDetail(r) {
  const el = document.getElementById("storeDetailBody");

  if (!r) {
    el.innerHTML = "ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
    return;
  }

  const majorCat = (r.category || "").split(">")[0] || "";
  const urlHtml = r.URL
    ? `<a href="${r.URL}" target="_blank" style="color:#2563eb;">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—´ê¸°</a>`
    : "ì—†ìŒ";

  el.innerHTML = `
    <div class="store-detail-line"><span>ë§¤ì¥ëª…</span>${r.name || ""}</div>
    <div class="store-detail-line"><span>ì£¼ì†Œ</span>${r.roadAddress || ""}</div>
    <div class="store-detail-line"><span>ì§€ì—­</span>${r.sigungu || ""}</div>
    <div class="store-detail-line"><span>ì¹´í…Œê³ ë¦¬</span>${majorCat}</div>
    <div class="store-detail-line"><span>ìƒíƒœ</span>${r.Status || "-"}</div>
    <div class="store-detail-line"><span>ë¸”ë¡œê·¸ ìˆ˜</span>${r.blog_count || "-"}</div>
    <div class="store-detail-line"><span>í‚¤ì›Œë“œ</span>${r.keyword || "-"}</div>
    <div class="store-detail-line"><span>ë§í¬</span>${urlHtml}</div>
  `;

  // ìƒíƒœ ë³€ê²½ ë“œë¡­ë‹¤ìš´ ê°’ ì„¸íŒ…
  const statusSelect = document.getElementById("statusChangeSelect");
  statusSelect.disabled = false;
  statusSelect.value = r.Status || "";
}

/* ëŒ€ì‹œë³´ë“œ í†µê³„ (ì°¨íŠ¸ + ìˆ«ì) */
function renderStats() {
  const stats = {
    total: filteredRows.length,
    deal: 0,
    meetingDone: 0,
    request: 0,
    noAnswer: 0,
    reject: 0
  };

  filteredRows.forEach(r => {
    switch (r.Status) {
      case "ê±°ë˜ ì„±ì‚¬":
        stats.deal++; break;
      case "ë¯¸íŒ… ì™„ë£Œ":
        stats.meetingDone++; break;
      case "ë¯¸íŒ… ìš”ì²­":
        stats.request++; break;
      case "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ":
        stats.noAnswer++; break;
      case "ê±°ì ˆ":
        stats.reject++; break;
    }
  });

  // ìˆ«ì ì¹´ìš´íŠ¸
  document.getElementById("statTotal").textContent = stats.total.toLocaleString();
  document.getElementById("statDeal").textContent = stats.deal.toLocaleString();
  document.getElementById("statMeetingDone").textContent = stats.meetingDone.toLocaleString();
  document.getElementById("statRequest").textContent = stats.request.toLocaleString();
  document.getElementById("statNoAnswer").textContent = stats.noAnswer.toLocaleString();
  document.getElementById("statReject").textContent = stats.reject.toLocaleString();

  // ë„ë„› ì°¨íŠ¸
  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById("statusChart");

  chartInstance = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["ê±°ë˜ ì„±ì‚¬", "ë¯¸íŒ… ì™„ë£Œ", "ë¯¸íŒ… ìš”ì²­", "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ", "ê±°ì ˆ"],
      datasets: [{
        data: [
          stats.deal,
          stats.meetingDone,
          stats.request,
          stats.noAnswer,
          stats.reject
        ],
        backgroundColor: [
          STATUS_COLOR["ê±°ë˜ ì„±ì‚¬"],
          STATUS_COLOR["ë¯¸íŒ… ì™„ë£Œ"],
          STATUS_COLOR["ë¯¸íŒ… ìš”ì²­"],
          STATUS_COLOR["ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ"],
          STATUS_COLOR["ê±°ì ˆ"]
        ]
      }]
    },
    options: {
      cutout: "60%",
      responsive: true,
      plugins: {
        legend: {
          position: "bottom",
          labels: { boxWidth: 10, font: { size: 10 } }
        }
      }
    }
  });
}

/* ìë™ì™„ì„± */
function showAutocomplete() {
  const ac = document.getElementById("autocomplete");
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  if (!q) {
    ac.style.display = "none";
    return;
  }

  const matched = rawRows.filter(r => {
    const text = [
      r.name || "",
      r.roadAddress || "",
      r.keyword || ""
    ].join(" ").toLowerCase();
    return text.includes(q);
  }).slice(0, 12);

  if (!matched.length) {
    ac.style.display = "none";
    return;
  }

  ac.innerHTML = matched.map(r =>
    `<div class="autocomplete-item">${r.name}</div>`
  ).join("");

  ac.style.display = "block";

  const items = ac.querySelectorAll(".autocomplete-item");
  items.forEach((el, i) => {
    el.addEventListener("click", () => {
      const store = matched[i];
      document.getElementById("searchInput").value = store.name;
      ac.style.display = "none";
      // í•´ë‹¹ ë§¤ì¥ ì„ íƒ ì²˜ë¦¬
      const marker = allMarkers.find(m => m._store && m._store.name === store.name);
      onSelectStore(store, marker);
      applyFilters(); // ê²€ìƒ‰ í•„í„° ì ìš©
    });
  });
}

/* íˆìŠ¤í† ë¦¬ ë¡œë“œ */
async function loadHistory(storeName) {
  const box = document.getElementById("historyList");
  if (!storeName) {
    box.innerHTML = "íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.";
    return;
  }

  box.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  try {
    const res = await fetch(`${API_BASE}?action=history&store_id=${encodeURIComponent(storeName)}`);
    const logs = await res.json();

    if (!logs.length) {
      box.innerHTML = "ë“±ë¡ëœ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    box.innerHTML = logs.map(log => `
      <div class="history-item">
        <div class="history-meta">
          ${log.timestamp} Â· ${log.manager || ""}
        </div>
        <div>${log.memo || ""}</div>
      </div>
    `).join("");

  } catch (e) {
    console.error(e);
    box.innerHTML = "íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
  }
}

/* ìƒíƒœ ë³€ê²½ ì €ì¥ */
async function onClickStatusChange() {
  if (!currentStore) return;

  const select = document.getElementById("statusChangeSelect");
  const btn = document.getElementById("statusChangeBtn");
  const newStatus = select.value;

  if (!newStatus || newStatus === currentStore.Status) {
    alert("ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  btn.disabled = true;
  btn.textContent = "ì €ì¥ ì¤‘...";

  try {
    const body = new URLSearchParams({
      action: "updateStatus",
      store_id: currentStore.name,
      status: newStatus
    });

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });

    const json = await res.json();
    if (json && json.result === "ok") {
      // í”„ë¡ íŠ¸ ë°ì´í„° ê°±ì‹ 
      currentStore.Status = newStatus;
      rawRows.forEach(r => {
        if (r.name === currentStore.name) r.Status = newStatus;
      });
      applyFilters();
      showStoreDetail(currentStore);
      loadHistory(currentStore.name); // ìƒíƒœ ë³€ê²½ íˆìŠ¤í† ë¦¬ë„ í•¨ê»˜ ê¸°ë¡ë¨
      alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      alert("ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (e) {
    console.error(e);
    alert("ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  } finally {
    btn.disabled = false;
    btn.textContent = "ìƒíƒœ ë³€ê²½ ì €ì¥";
  }
}

/* ë©”ëª¨ ì €ì¥ */
async function onClickMemoSave() {
  if (!currentStore) return;
  const textarea = document.getElementById("memoInput");
  const btn = document.getElementById("memoSaveBtn");
  const memo = textarea.value.trim();
  if (!memo) {
    alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  btn.disabled = true;
  btn.textContent = "ì €ì¥ ì¤‘...";

  try {
    const body = new URLSearchParams({
      action: "addHistory",
      store_id: currentStore.name,
      memo: memo
    });

    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });

    const json = await res.json();
    if (json && json.result === "ok") {
      textarea.value = "";
      loadHistory(currentStore.name);
      alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      alert("ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (e) {
    console.error(e);
    alert("ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  } finally {
    btn.disabled = false;
    btn.textContent = "ë©”ëª¨ ì €ì¥";
  }
}

/* í•„í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° */
function saveFilters() {
  localStorage.setItem("kb_statusFilter", document.getElementById("statusSelect").value);
  localStorage.setItem("kb_categoryFilter", document.getElementById("categorySelect").value);
  localStorage.setItem("kb_search", document.getElementById("searchInput").value);
}
function loadFilters() {
  const st = localStorage.getItem("kb_statusFilter");
  const cat = localStorage.getItem("kb_categoryFilter");
  const q = localStorage.getItem("kb_search");
  if (st) document.getElementById("statusSelect").value = st;
  if (cat) document.getElementById("categorySelect").value = cat;
  if (q) document.getElementById("searchInput").value = q;
}

/* í˜„ì¬ ì„ íƒ ë§¤ì¥ ë¼ë²¨ */
function updateCurrentStoreLabel() {
  const label = document.getElementById("currentStoreLabel");
  if (currentStore && currentStore.name) {
    label.textContent = currentStore.name;
  } else {
    label.textContent = "";
  }
}

/* ë§¤ì¥ ì„ íƒ/ë¹„ì„ íƒ ì‹œ ë²„íŠ¼ í™œì„±/ë¹„í™œì„± */
function enableStoreControls(enabled) {
  document.getElementById("statusChangeSelect").disabled = !enabled;
  document.getElementById("statusChangeBtn").disabled = !enabled;
  document.getElementById("memoInput").disabled = !enabled;
  document.getElementById("memoSaveBtn").disabled = !enabled;
}
</script>
</body>
</html>
