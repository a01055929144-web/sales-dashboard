<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sales Store Map Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* ğŸ”’ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
.primary-btn:disabled {
  background: #93a5d3 !important;
  cursor: not-allowed;
  box-shadow: none !important;
  transform: none !important;
  opacity: 0.7;
}


    /* ìƒë‹¨ ë°” */
    header {
      padding: 10px 16px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      white-space: nowrap;
    }
    .header-controls {
      display: flex;
      gap: 8px;
      flex: 1;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-input,
    .select-input {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }
    .search-input { flex: 1; min-width: 160px; }
    .select-input { min-width: 140px; }
    .select-input.full-width { width: 100%; }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ (PC ê¸°ì¤€) */
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr) 320px;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    /* ì¢Œì¸¡ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ */
    .store-panel {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
      z-index: 15;
    }
    .store-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .store-header-row h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
    }
    .store-count {
      font-size: 11px;
      color: #6b7280;
    }
    .store-sort-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #6b7280;
    }
    .store-sort-row select {
      flex: 1;
      min-width: 0;
    }

    .store-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .store-item {
      padding: 8px 8px;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid transparent;
      margin-bottom: 6px;
      transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
      background: #ffffff;
    }
    .store-item:hover {
      background: #f3f4ff;
      border-color: #e0e7ff;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    }
    .store-header {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .store-name {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .fav-icon {
      font-size: 14px;
      color: #fbbf24;
      cursor: pointer;
      flex-shrink: 0;
    }
    .store-meta-line {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .status-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      flex-shrink: 0;
    }
    .meta-text {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .store-meta-address {
      font-size: 11px;
      color: #6b7280;
    }

    /* ì§€ë„ */
    #map { width: 100%; height: 100%; }

    /* ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ */
    .dashboard-panel {
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      padding: 12px;
      overflow-y: auto;
      z-index: 15;
    }
    .dashboard-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chart-wrapper {
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      margin-bottom: 8px;
    }
    #statusChart {
      width: 100%;
      max-height: 200px;
    }
    .chart-stats {
      font-size: 11px;
      color: #374151;
      margin-top: 6px;
      line-height: 1.4;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 10px;
    }
    .stat-card {
      padding: 6px 8px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .stat-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 14px;
      font-weight: 700;
    }
    .stat-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .detail-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
      margin-bottom: 8px;
    }
    .detail-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .detail-body {
      font-size: 12px;
      color: #374151;
    }
    .info-item {
      margin: 6px 0;
      font-size: 12px;
      color: #374151;
    }
    .info-item span {
      display: inline-block;
      width: 70px;
      font-weight: 600;
    }

    .status-change {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #fafafa;
      margin-bottom: 8px;
    }
    .status-change-header {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
    }

  .primary-btn,
.secondary-btn {
  border-radius: 999px;
  border: none;
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  margin-top: 6px;
}

/* ğŸ”¥ ê°•í™”ëœ primary ë²„íŠ¼ */
.primary-btn {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #ffffff;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 700;
  border-radius: 12px;
  width: 100%;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
  transition: all 0.18s ease-out;
}

.primary-btn:hover {
  background: linear-gradient(135deg, #1e40af, #1e3a8a);
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(30, 64, 175, 0.45);
}

.secondary-btn {
  background: #e5e7eb;
  color: #111827;
}

    .secondary-btn:hover { background: #d1d5db; }

    .history-section {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 180px;
    }
    .history-header {
      font-size: 12px;
      font-weight: 600;
    }
    .history-list {
      max-height: 130px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 6px;
      font-size: 11px;
      background: #f9fafb;
    }
    .history-item {
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px dashed #e5e7eb;
    }
    .history-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .history-meta {
      color: #6b7280;
      margin-bottom: 2px;
    }
    .history-text {
      color: #111827;
      white-space: pre-wrap;
    }
    .history-empty {
      color: #9ca3af;
    }

    .memo-box {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }
    .memo-box textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 12px;
      resize: vertical;
      min-height: 48px;
    }

    /* ì»¤ìŠ¤í…€ ë§ˆì»¤ */
    .custom-marker {
      border-radius: 999px;
      background: transparent;
    }
    .marker-dot {
      border-radius: 999px;
      border: 2px solid #ffffff;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
      animation: pop 0.25s ease-out;
    }
    .marker-selected {
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.9);
    }

    @keyframes pop {
      0% { transform: scale(0.2); opacity: 0; }
      80% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); }
    }

    /* ëª¨ë°”ì¼ ì „ìš© í”Œë¡œíŒ… ë²„íŠ¼ */
    .mobile-fab-container {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 8px;
      z-index: 40;
    }
    .fab {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ëª¨ë°”ì¼ì—ì„œ íŒ¨ë„ì„ Drawerì²˜ëŸ¼ ì‚¬ìš© */
    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr; /* ì§€ë„ë§Œ ê¸°ë³¸ í‘œì‹œ */
      }

      #map {
        height: calc(100vh - 52px); /* í—¤ë” ì œì™¸ ì „ì²´ */
      }

      .store-panel,
      .dashboard-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        max-height: 70vh;
        background: #ffffff;
        box-shadow: 0 -6px 12px rgba(15, 23, 42, 0.18);
        transform: translateY(100%);
        transition: transform 0.25s ease-out;
        border-radius: 14px 14px 0 0;
      }

      .store-panel.open,
      .dashboard-panel.open {
        transform: translateY(0);
      }

      .store-panel {
        border-right: none;
        padding-top: 8px;
      }

      .dashboard-panel {
        border-left: none;
        padding-top: 10px;
      }

      .mobile-fab-container {
        display: flex;
      }
    }

    /* ìŠ¤í¬ë¡¤ë°” */
    .store-panel::-webkit-scrollbar,
    .dashboard-panel::-webkit-scrollbar,
    .history-list::-webkit-scrollbar {
      width: 6px;
    }
    .store-panel::-webkit-scrollbar-thumb,
    .dashboard-panel::-webkit-scrollbar-thumb,
    .history-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }
    /* --- History Timeline ìŠ¤íƒ€ì¼ --- */
.timeline-item {
  position: relative;
  padding-left: 18px;
  margin-bottom: 12px;
}

.timeline-dot {
  width: 9px;
  height: 9px;
  background: #2563eb;
  border-radius: 999px;
  position: absolute;
  left: 0;
  top: 4px;
}

.timeline-date {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 2px;
}

.timeline-card {
  border: 1px solid #e5e7eb;
  background: #ffffff;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 12px;
  line-height: 1.4;
}

.timeline-manager {
  font-size: 11px;
  color: #374151;
  font-weight: 600;
  margin-bottom: 3px;
}

.timeline-memo {
  white-space: pre-wrap;
  color: #111827;
}

  </style>
</head>
<body>
<header>
  <h1>ğŸ“ Sales Store Map</h1>
  <div class="header-controls">
    <!-- ìƒíƒœ í•„í„° -->
    <select id="statusFilterSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <!-- ì§€ì—­(ì‹œêµ°êµ¬) í•„í„° -->
    <select id="regionSelect" class="select-input">
      <option value="ALL">ì „ì²´ ì§€ì—­</option>
    </select>

    <!-- ê¸°ì¡´ ê²€ìƒ‰ì°½ (ê·¸ëŒ€ë¡œ ìœ ì§€) -->
    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="ë§¤ì¥ëª… / ì§€ì—­ / ë„ë¡œëª…ì£¼ì†Œ / í‚¤ì›Œë“œ ê²€ìƒ‰"
    />
  </div>
</header>

<div class="layout">
  <!-- ì¢Œì¸¡: ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ (PC) / í•˜ë‹¨ Drawer (ëª¨ë°”ì¼) -->
  <aside class="store-panel" id="storePanel">
    <div class="store-header-row">
      <h2>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</h2>
      <span class="store-count" id="storeCountLabel"></span>
    </div>
    <div class="store-sort-row">
      <span>ì •ë ¬</span>
      <select id="sortSelect" class="select-input">
        <option value="default">ì¦ê²¨ì°¾ê¸° â–· ìƒíƒœ â–· ì´ë¦„</option>
        <option value="name">ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)</option>
        <option value="blog">ë¸”ë¡œê·¸ ìˆ˜ ë§ì€ìˆœ</option>
      </select>
    </div>
    <ul id="storeList" class="store-list"></ul>
  </aside>

  <!-- ê°€ìš´ë°: ì§€ë„ -->
  <main>
    <div id="map"></div>
  </main>

  <!-- ì˜¤ë¥¸ìª½: ëŒ€ì‹œë³´ë“œ (PC) / í•˜ë‹¨ Drawer (ëª¨ë°”ì¼) -->
  <aside class="dashboard-panel" id="dashboardPanel">
    <div class="dashboard-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>

    <!-- ë„ë„› ì°¨íŠ¸ + ìƒíƒœ ë¹„ìœ¨ -->
    <div class="chart-wrapper">
      <canvas id="statusChart"></canvas>
      <div id="chartStats" class="chart-stats"></div>
    </div>

    <!-- ìˆ«ì ì¹´ìš´íŠ¸ -->
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">ì´ ë§¤ì¥ ìˆ˜</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ê±°ë˜ ì„±ì‚¬</div>
        <div class="stat-value" id="statDeal">0</div>
        <div class="stat-sub" id="statDealPct"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¯¸íŒ… ì™„ë£Œ</div>
        <div class="stat-value" id="statMeetingDone">0</div>
        <div class="stat-sub" id="statMeetingDonePct"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¯¸íŒ… ìš”ì²­</div>
        <div class="stat-value" id="statRequest">0</div>
        <div class="stat-sub" id="statRequestPct"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
        <div class="stat-value" id="statNoAnswer">0</div>
        <div class="stat-sub" id="statNoAnswerPct"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ê±°ì ˆ</div>
        <div class="stat-value" id="statReject">0</div>
        <div class="stat-sub" id="statRejectPct"></div>
      </div>
    </div>

    <!-- ë§¤ì¥ ìƒì„¸ì •ë³´ -->
    <div class="detail-card">
      <div class="detail-title">ğŸª ë§¤ì¥ ìƒì„¸ì •ë³´</div>
      <div id="storeDetailBody" class="detail-body">
        ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>
<!-- ë‹´ë‹¹ì ì…ë ¥ -->
<div class="detail-card">
  <div class="detail-title">ë‹´ë‹¹ì*í•„ìˆ˜*</div>
  <select id="managerInput" class="select-input full-width">
    <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
    <option value="Zero">Zero</option>
    <option value="Grandal">Grandal</option>
    <option value="Jose">Jose</option>
    <option value="Aimee">Aimee</option>
    <option value="Merry">Merry</option>
  </select>
</div>

    <!-- ìƒíƒœ ë³€ê²½ -->
    <div class="status-change">
      <div class="status-change-header">ìƒíƒœ ë³€ê²½</div>
      <select id="statusChangeSelect" class="select-input full-width">
        <option value="">ìƒíƒœ ì„ íƒ</option>
        <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
        <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
        <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
        <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
        <option value="ê±°ì ˆ">ê±°ì ˆ</option>
      </select>
      <button id="statusSaveBtn" class="primary-btn">ìƒíƒœ ë³€ê²½ ì €ì¥</button>

    </div>

    
    <!-- íˆìŠ¤í† ë¦¬ + ë©”ëª¨ -->
    <div class="history-section">
      <div class="history-header">ğŸ•’ íˆìŠ¤í† ë¦¬</div>
      <div id="historyList" class="history-list">
        ë§¤ì¥ì„ ì„ íƒí•˜ë©´ íˆìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
      <div class="memo-box">
        <textarea
          id="memoInput"
          rows="3"
          placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ë©´ ì €ì¥ ì‹œ ì¼ì‹œê°€ ìë™ ê¸°ë¡ë©ë‹ˆë‹¤."
        ></textarea>
        <button id="memoSaveBtn" class="primary-btn" disabled>ë©”ëª¨ ì €ì¥</button>
      </div>
    </div>
  </aside>
</div>

<!-- ëª¨ë°”ì¼ìš© í”Œë¡œíŒ… ë²„íŠ¼ -->
<div class="mobile-fab-container" id="mobileFab">
  <button id="mobileListBtn" class="fab">ğŸ“‹ ë§¤ì¥</button>
  <button id="mobileDashboardBtn" class="fab">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
</div>

<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  /*************************************************
   * ğŸ”‘ Apps Script WebApp URL
   *  - places_raw ì‹œíŠ¸ì—ì„œ ë§¤ì¥ ë°ì´í„° ì œê³µ (action=places)
   *  - ìƒíƒœ ë³€ê²½ (action=updateStatus)
   *  - ì¦ê²¨ì°¾ê¸° (action=favorite)
   *  - íˆìŠ¤í† ë¦¬ ì¡°íšŒ (action=history)
   *  - ë©”ëª¨ ì €ì¥ (action=addMemo)
   *
   *  ğŸ“Œ íˆìŠ¤í† ë¦¬ ì‹œíŠ¸ ì˜ˆì‹œ
   *  ì‹œíŠ¸ëª…: history
   *  í—¤ë”: name | date | manager | memo | source
   *************************************************/
  const BASE_URL =
    "https://script.google.com/macros/s/AKfycbyTEpSlrv6vFRU4jwICu5ZM9z_xRBskTl5hxyjNZs1Wp1jXd1EzMEejnWGS0hHMKzWK/exec";

  let rawRows = [];
  let rawByName = {};
  let filteredRows = [];
  let map, markerCluster, chartInstance;
  let markersByName = {};
  let selectedStoreName = null;

  const STATUS_COLOR = {
    "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
    "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
    "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
    "ê±°ì ˆ": "#e74c3c"
  };

  const STATUS_ORDER = {
    "ê±°ë˜ ì„±ì‚¬": 0,
    "ë¯¸íŒ… ì™„ë£Œ": 1,
    "ë¯¸íŒ… ìš”ì²­": 2,
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": 3,
    "ê±°ì ˆ": 4
  };

  window.addEventListener("load", () => {
    initMap();
    initEvents();
    loadData();
  });

  /**************** ì§€ë„ ì´ˆê¸°í™” ****************/
  function initMap() {
    map = L.map("map", {
      center: [37.5665, 126.9780],
      zoom: 11,
      zoomControl: true
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    markerCluster = L.markerClusterGroup({
      showCoverageOnHover: false,
      maxClusterRadius: 40
    });
    map.addLayer(markerCluster);
  }

  /**************** ì´ë²¤íŠ¸ ë°”ì¸ë”© ****************/
  function initEvents() {
    document
      .getElementById("searchInput")
      .addEventListener("input", applyFilters);

    document
      .getElementById("globalSearchInput")
      .addEventListener("input", applyFilters);

    document
      .getElementById("categorySelect")
      .addEventListener("change", applyFilters);

    document
      .getElementById("statusFilterSelect")
      .addEventListener("change", applyFilters);

    document
      .getElementById("regionSelect")
      .addEventListener("change", applyFilters);

    document
      .getElementById("sortSelect")
      .addEventListener("change", applyFilters);

    document
      .getElementById("statusSaveBtn")
      .addEventListener("click", saveStatus);

    document
      .getElementById("memoSaveBtn")
      .addEventListener("click", saveMemo);

    // ëª¨ë°”ì¼ í”Œë¡œíŒ… ë²„íŠ¼
    document
      .getElementById("mobileListBtn")
      .addEventListener("click", () => {
        toggleMobilePanel("list");
      });

    document
      .getElementById("mobileDashboardBtn")
      .addEventListener("click", () => {
        toggleMobilePanel("dashboard");
      });
  }

  /**************** ëª¨ë°”ì¼ Drawer í† ê¸€ ****************/
  function toggleMobilePanel(which) {
    if (window.innerWidth > 1024) return; // PCì—ì„œëŠ” ë¬´ì‹œ

    const storePanel = document.getElementById("storePanel");
    const dashboardPanel = document.getElementById("dashboardPanel");

    if (which === "list") {
      const isOpen = storePanel.classList.contains("open");
      storePanel.classList.toggle("open", !isOpen);
      dashboardPanel.classList.remove("open");
    } else if (which === "dashboard") {
      const isOpen = dashboardPanel.classList.contains("open");
      dashboardPanel.classList.toggle("open", !isOpen);
      storePanel.classList.remove("open");
    }
  }

  /**************** ë°ì´í„° ë¡œë“œ ****************/
  async function loadData() {
    try {
      const res = await fetch(`${BASE_URL}?action=places`);
      const json = await res.json();

      console.log("ğŸ“Œ ì›ë³¸ ë°ì´í„° ì˜ˆì‹œ", json.slice(0, 3));

      rawRows = json
        .filter(r => r.lat && r.lng)
        .map(r => ({
          ...r,
          lat: Number(r.lat),
          lng: Number(r.lng),
          favorite: r.favorite === true || r.favorite === "TRUE"
        }));

      rawByName = {};
      rawRows.forEach(r => {
        if (r.name) rawByName[r.name] = r;
      });

      buildFilters(rawRows);
      applyFilters();
    } catch (e) {
      console.error("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", e);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /**************** í•„í„° ì˜µì…˜ êµ¬ì„± ****************/
  function buildFilters(rows) {
    const categorySelect = document.getElementById("categorySelect");
    const statusFilterSelect = document.getElementById("statusFilterSelect");
    const regionSelect = document.getElementById("regionSelect");

    const categorySet = new Set();
    const statusSet = new Set();
    const regionSet = new Set();

    rows.forEach(r => {
      if (r.category) {
        const major = r.category.split(">")[0].trim();
        categorySet.add(major);
      }
      if (r.Status) statusSet.add(r.Status);
      if (r.sigungu) regionSet.add(r.sigungu.trim());
    });

    // ì¹´í…Œê³ ë¦¬ ì˜µì…˜
    categorySelect.innerHTML =
      '<option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>';
    Array.from(categorySet)
      .sort()
      .forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });

    // ìƒíƒœ ì˜µì…˜
    statusFilterSelect.innerHTML =
      '<option value="ALL">ì „ì²´ ìƒíƒœ</option>';
    Array.from(statusSet)
      .sort((a, b) => (STATUS_ORDER[a] ?? 99) - (STATUS_ORDER[b] ?? 99))
      .forEach(st => {
        const opt = document.createElement("option");
        opt.value = st;
        opt.textContent = st;
        statusFilterSelect.appendChild(opt);
      });

    // ì§€ì—­(ì‹œêµ°êµ¬) ì˜µì…˜
    regionSelect.innerHTML =
      '<option value="ALL">ì „ì²´ ì§€ì—­</option>';
    Array.from(regionSet)
      .sort()
      .forEach(region => {
        const opt = document.createElement("option");
        opt.value = region;
        opt.textContent = region;
        regionSelect.appendChild(opt);
      });
  }

  /**************** í•„í„° ì ìš© ****************/
  function applyFilters() {
    const q1 = document
      .getElementById("searchInput")
      .value.trim()
      .toLowerCase();
    const q2 = document
      .getElementById("globalSearchInput")
      .value.trim()
      .toLowerCase();

    // ë‘ ê²€ìƒ‰ì°½ì„ ëª¨ë‘ ì‚¬ìš© (í•©ì³ì„œ ê²€ìƒ‰)
    const q = (q1 + " " + q2).trim();

    const cat = document.getElementById("categorySelect").value;
    const st = document.getElementById("statusFilterSelect").value;
    const region = document.getElementById("regionSelect").value;
    const sortMode = document.getElementById("sortSelect").value;

    filteredRows = rawRows.filter(r => {
      const text =
        `${r.name || ""} ${r.sigungu || ""} ${r.roadAddress || ""} ${
          r.keyword || ""
        }`.toLowerCase();
      const matchSearch = !q || text.includes(q);

      let major = "ê¸°íƒ€";
      if (r.category) {
        major = r.category.split(">")[0].trim();
      }
      const matchCat = cat === "ALL" || major === cat;
      const matchStatus = st === "ALL" || (r.Status || "") === st;
      const matchRegion = region === "ALL" || (r.sigungu || "") === region;

      return matchSearch && matchCat && matchStatus && matchRegion;
    });

    filteredRows = sortStores(filteredRows, sortMode);

    renderAll();
  }

  /**************** ì •ë ¬ ë¡œì§ ****************/
  function sortStores(rows, mode) {
    const list = [...rows];
    list.sort((a, b) => {
      // ì¦ê²¨ì°¾ê¸° ìš°ì„  + ìƒíƒœ + ì´ë¦„
      if (mode === "default") {
        if (a.favorite !== b.favorite) {
          return a.favorite ? -1 : 1;
        }
        const soA = STATUS_ORDER[a.Status] ?? 99;
        const soB = STATUS_ORDER[b.Status] ?? 99;
        if (soA !== soB) return soA - soB;
        return (a.name || "").localeCompare(b.name || "", "ko");
      }

      if (mode === "name") {
        return (a.name || "").localeCompare(b.name || "", "ko");
      }

      if (mode === "blog") {
        const ba = Number(a.blog_count || 0);
        const bb = Number(b.blog_count || 0);
        if (bb !== ba) return bb - ba;
        return (a.name || "").localeCompare(b.name || "", "ko");
      }

      return 0;
    });
    return list;
  }

  /**************** ì „ì²´ ë Œë”ë§ ****************/
  function renderAll() {
    renderMarkers();
    renderStoreList();
    renderStats();
  }

  /**************** ë§ˆì»¤ ì•„ì´ì½˜ ****************/
  function createMarkerIcon(status, favorite = false, selected = false) {
    const color = STATUS_COLOR[status] || "#7f8c8d";
    const size = selected ? 22 : 16;
    const borderColor = favorite ? "#fbbf24" : "#ffffff";

    return L.divIcon({
      className: "custom-marker",
      html: `<div class="marker-dot ${
        selected ? "marker-selected" : ""
      }" style="
        background:${color};
        border-color:${borderColor};
        width:${size}px;
        height:${size}px;
      "></div>`,
      iconSize: [size + 4, size + 4],
      iconAnchor: [(size + 4) / 2, (size + 4) / 2]
    });
  }

  /**************** ë§ˆì»¤ ë Œë”ë§ ****************/
  function renderMarkers() {
    markerCluster.clearLayers();
    markersByName = {};

    filteredRows.forEach(r => {
      const marker = L.marker([r.lat, r.lng], {
        icon: createMarkerIcon(
          r.Status,
          r.favorite,
          r.name === selectedStoreName
        )
      });

      marker.bindTooltip(r.name || "", {
        permanent: false,
        direction: "top",
        offset: [0, -10]
      });

      marker.on("click", () => {
        focusOnStore(r);
      });

      markerCluster.addLayer(marker);
      if (r.name) markersByName[r.name] = marker;
    });

    if (filteredRows.length > 0) {
      const group = L.featureGroup(markerCluster.getLayers());
      map.fitBounds(group.getBounds().pad(0.1));
    }

    document.getElementById("storeCountLabel").textContent =
      `${filteredRows.length.toLocaleString()}ê°œ ë§¤ì¥`;
  }

  /**************** ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ****************/
  function renderStoreList() {
    const listEl = document.getElementById("storeList");
    listEl.innerHTML = "";

    filteredRows.slice(0, 500).forEach(r => {
      const li = document.createElement("li");
      li.className = "store-item";

      const major = (r.category || "").split(">")[0] || "";
      const statusLabel = r.Status || "ìƒíƒœ ì—†ìŒ";

      li.innerHTML = `
        <div class="store-header">
          <span class="fav-icon">${r.favorite ? "â­" : "â˜†"}</span>
          <div class="store-name">${r.name || "ë§¤ì¥ëª… ì—†ìŒ"}</div>
        </div>
        <div class="store-meta-line">
          <span class="status-badge">${statusLabel}</span>
          <span class="meta-text">${r.sigungu || ""} Â· ${major}</span>
        </div>
        <div class="store-meta-address">${r.roadAddress || ""}</div>
      `;

      // ë§¤ì¥ ì„ íƒ
      li.addEventListener("click", () => {
        focusOnStore(r);
      });

      // ì¦ê²¨ì°¾ê¸° í† ê¸€
      const favSpan = li.querySelector(".fav-icon");
      favSpan.addEventListener("click", e => {
        e.stopPropagation();
        toggleFavorite(r);
      });

      listEl.appendChild(li);
    });
  }

  /**************** ë§¤ì¥ ì„ íƒ ì‹œ í¬ì»¤ìŠ¤ ****************/
  function focusOnStore(store) {
    selectedStoreName = store.name;

    // ì§€ë„ ì´ë™
    if (!isNaN(store.lat) && !isNaN(store.lng)) {
      map.setView([store.lat, store.lng], 17);
    }

    // ë§ˆì»¤ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
    Object.keys(markersByName).forEach(name => {
      const marker = markersByName[name];
      const row = rawByName[name];
      if (!row) return;
      const selected = name === selectedStoreName;
      marker.setIcon(
        createMarkerIcon(row.Status, row.favorite, selected)
      );
    });

    showStoreDetail(store);
    setStatusDropdown(store);
    loadHistory(store.name);

    // ëª¨ë°”ì¼ì—ì„œëŠ” ìƒì„¸ì •ë³´ Drawer(ëŒ€ì‹œë³´ë“œ íŒ¨ë„) ìë™ ì˜¤í”ˆ
    if (window.innerWidth <= 1024) {
      const storePanel = document.getElementById("storePanel");
      const dashboardPanel = document.getElementById("dashboardPanel");
      storePanel.classList.remove("open");
      dashboardPanel.classList.add("open");
    }
  }

  /**************** ìƒì„¸ì •ë³´ í‘œì‹œ ****************/
  function showStoreDetail(r) {
    const box = document.getElementById("storeDetailBody");
    if (!r) {
      box.textContent = "ë§¤ì¥ì„ ì„ íƒí•˜ë©´ ìƒì„¸ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
      return;
    }

    const majorCat = (r.category || "").split(">")[0] || "-";

    // ğŸ”¹ URL ìë™ ë³´ì • (http/https ì—†ìœ¼ë©´ https:// ë¶™ì´ê¸°)
    let safeUrl = r.URL || r.url || "";
    if (safeUrl && !/^https?:\/\//i.test(safeUrl)) {
      safeUrl = "https://" + safeUrl;
    }
    const urlHtml = safeUrl
      ? `<a href="${safeUrl}" target="_blank" style="color:#2563eb;font-weight:600;">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—´ê¸°</a>`
      : "-";

    box.innerHTML = `
      <div style="font-size:15px;font-weight:700;color:#111;margin-bottom:6px;">
        ${r.name || ""}
      </div>
      <div class="info-item"><span>ğŸ  ì£¼ì†Œ</span>${r.roadAddress || "-"}</div>
      <div class="info-item"><span>ğŸ“ ì§€ì—­</span>${r.sigungu || "-"}</div>
      <div class="info-item"><span>ğŸ½ ì—…ì¢…</span>${majorCat}</div>
      <div class="info-item"><span>â­ ìƒíƒœ</span>${r.Status || "-"}</div>
      <div class="info-item"><span>ğŸ“ í‚¤ì›Œë“œ</span>${r.keyword || "-"}</div>
      <div class="info-item"><span>ğŸ”— ë§í¬</span>${urlHtml}</div>
    `;
  }

  function setStatusDropdown(store) {
    const select = document.getElementById("statusChangeSelect");
    select.value = store?.Status || "";
  }

 /**************** ìƒíƒœ ë³€ê²½ ì €ì¥ + ìë™ íˆìŠ¤í† ë¦¬ ê¸°ë¡ ****************/
function saveStatus() {
  if (!selectedStoreName) {
    alert("ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  // ë‹´ë‹¹ì í•„ìˆ˜ ì²´í¬
  const manager = document.getElementById("managerInput").value.trim();
  if (!manager) {
    alert("ë‹´ë‹¹ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const newStatus = document.getElementById("statusChangeSelect").value;
  if (!newStatus) {
    alert("ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const row = rawByName[selectedStoreName];
  if (!row) return;

  row.Status = newStatus;

  // í™”ë©´ ì „ì²´ ì—…ë°ì´íŠ¸
  applyFilters();

  /* ğŸ”µ 1) íˆìŠ¤í† ë¦¬ UIì— ì¦‰ì‹œ ì¶”ê°€ */
  const now = new Date().toLocaleString("ko-KR");
  const memoText = `ìƒíƒœë¥¼ '${newStatus}'ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`;

  const listEl = document.getElementById("historyList");
  const newItem = `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-date">${now}</div>
      <div class="timeline-card">
        <div class="timeline-manager">${manager}</div>
        <div class="timeline-memo">${memoText}</div>
      </div>
    </div>`;
  listEl.insertAdjacentHTML("afterbegin", newItem);

  /* ğŸ”µ 2) ìƒíƒœ ì—…ë°ì´íŠ¸ ì €ì¥ */
  const url1 =
    `${BASE_URL}?action=updateStatus` +
    `&name=${encodeURIComponent(selectedStoreName)}` +
    `&status=${encodeURIComponent(newStatus)}` +
    `&manager=${encodeURIComponent(manager)}`;

  fetch(url1).catch(e =>
    console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e)
  );

  /* ğŸ”µ 3) íˆìŠ¤í† ë¦¬ ì €ì¥ */
  const url2 =
    `${BASE_URL}?action=addMemo` +
    `&name=${encodeURIComponent(selectedStoreName)}` +
    `&memo=${encodeURIComponent(memoText)}` +
    `&manager=${encodeURIComponent(manager)}`;

  fetch(url2).catch(e =>
    console.error("ìƒíƒœ ë³€ê²½ íˆìŠ¤í† ë¦¬ ì €ì¥ ì˜¤ë¥˜:", e)
  );
}

 /**************** íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (íƒ€ì„ë¼ì¸ + ìµœì‹ ìˆœ ì •ë ¬) ****************/
function loadHistory(storeName) {
  const listEl = document.getElementById("historyList");

  if (!storeName) {
    listEl.innerHTML =
      '<div class="history-empty">ë§¤ì¥ì„ ì„ íƒí•˜ë©´ íˆìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
    return;
  }

  listEl.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  fetch(`${BASE_URL}?action=history&name=${encodeURIComponent(storeName)}`)
    .then(res => res.json())
    .then(items => {
      if (!Array.isArray(items) || !items.length) {
        listEl.innerHTML =
          '<div class="history-empty">íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      listEl.innerHTML = items
        .map(it => `
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-date">${it.date}</div>
            <div class="timeline-card">
              <div class="timeline-manager">${it.manager || "-"}</div>
              <div class="timeline-memo">${it.memo || ""}</div>
            </div>
          </div>
        `)
        .join("");
    })
    .catch(e => {
      console.error("íˆìŠ¤í† ë¦¬ ë¡œë”© ì˜¤ë¥˜:", e);
      listEl.innerHTML =
        '<div class="history-empty">íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    });
}


/**************** ë©”ëª¨ ì €ì¥ (íƒ€ì„ë¼ì¸ ì¦‰ì‹œ ë°˜ì˜) ****************/
function saveMemo() {
  if (!selectedStoreName) {
    alert("ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const textarea = document.getElementById("memoInput");
  const text = textarea.value.trim();
  if (!text) {
    alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // ğŸ”¹ ìƒˆë¡œ ì¶”ê°€ëœ ë‹´ë‹¹ì ì…ë ¥ë€
  const manager = document.getElementById("managerInput").value.trim() || "ë¯¸ê¸°ì…";

  // í™”ë©´ ì¦‰ì‹œ ë°˜ì˜
  const now = new Date();
  const ts = now.toLocaleString("ko-KR");

  const listEl = document.getElementById("historyList");
  const newItem = `
    <div class="history-item">
      <div class="history-meta">${ts} Â· ${manager}</div>
      <div class="history-text">${text}</div>
    </div>
  `;
  listEl.insertAdjacentHTML("afterbegin", newItem);
  textarea.value = "";

  // ğŸš€ GAS ì „ì†¡
  const url =
    `${BASE_URL}?action=addMemo` +
    `&name=${encodeURIComponent(selectedStoreName)}` +
    `&memo=${encodeURIComponent(text)}` +
    `&manager=${encodeURIComponent(manager)}`;

  fetch(url).catch(e => console.error("ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:", e));
}

  /**************** í†µê³„ + ì°¨íŠ¸ ****************/
  function renderStats() {
    const stats = {
      total: filteredRows.length,
      deal: 0,
      meetingDone: 0,
      request: 0,
      noAnswer: 0,
      reject: 0
    };

    filteredRows.forEach(r => {
      if (r.Status === "ê±°ë˜ ì„±ì‚¬") stats.deal++;
      else if (r.Status === "ë¯¸íŒ… ì™„ë£Œ") stats.meetingDone++;
      else if (r.Status === "ë¯¸íŒ… ìš”ì²­") stats.request++;
      else if (r.Status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") stats.noAnswer++;
      else if (r.Status === "ê±°ì ˆ") stats.reject++;
    });

    const total = stats.total || 1;
    const pct = v => ((v / total) * 100).toFixed(1);

    // ìˆ«ì ì¹´ë“œ
    document.getElementById("statTotal").textContent =
      stats.total.toLocaleString();
    document.getElementById("statDeal").textContent =
      stats.deal.toLocaleString();
    document.getElementById("statMeetingDone").textContent =
      stats.meetingDone.toLocaleString();
    document.getElementById("statRequest").textContent =
      stats.request.toLocaleString();
    document.getElementById("statNoAnswer").textContent =
      stats.noAnswer.toLocaleString();
    document.getElementById("statReject").textContent =
      stats.reject.toLocaleString();

    document.getElementById(
      "statDealPct"
    ).textContent = `${pct(stats.deal)}%`;
    document.getElementById(
      "statMeetingDonePct"
    ).textContent = `${pct(stats.meetingDone)}%`;
    document.getElementById(
      "statRequestPct"
    ).textContent = `${pct(stats.request)}%`;
    document.getElementById(
      "statNoAnswerPct"
    ).textContent = `${pct(stats.noAnswer)}%`;
    document.getElementById(
      "statRejectPct"
    ).textContent = `${pct(stats.reject)}%`;

    // ë„ë„› ì°¨íŠ¸
    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById("statusChart");

    chartInstance = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: [
          "ê±°ë˜ ì„±ì‚¬",
          "ë¯¸íŒ… ì™„ë£Œ",
          "ë¯¸íŒ… ìš”ì²­",
          "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ",
          "ê±°ì ˆ"
        ],
        datasets: [
          {
            data: [
              stats.deal,
              stats.meetingDone,
              stats.request,
              stats.noAnswer,
              stats.reject
            ],
            backgroundColor: [
              "#2ecc71",
              "#3498db",
              "#f1c40f",
              "#95a5a6",
              "#e74c3c"
            ]
          }
        ]
      },
      options: {
        cutout: "65%",
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });

    document.getElementById("chartStats").innerHTML = `
      <div><b>ê±°ë˜ ì„±ì‚¬:</b> ${stats.deal}ê°œ (${pct(stats.deal)}%)</div>
      <div><b>ë¯¸íŒ… ì™„ë£Œ:</b> ${stats.meetingDone}ê°œ (${pct(stats.meetingDone)}%)</div>
      <div><b>ë¯¸íŒ… ìš”ì²­:</b> ${stats.request}ê°œ (${pct(stats.request)}%)</div>
      <div><b>ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ:</b> ${stats.noAnswer}ê°œ (${pct(stats.noAnswer)}%)</div>
      <div><b>ê±°ì ˆ:</b> ${stats.reject}ê°œ (${pct(stats.reject)}%)</div>
    `;
  }
  /**************** ë‹´ë‹¹ì ì„ íƒ ì‹œ ìë™ íˆìŠ¤í† ë¦¬ ê¸°ë¡ ****************/
document.getElementById("managerInput").addEventListener("change", () => {
  if (!selectedStoreName) return;

  const manager = document.getElementById("managerInput").value;
  if (!manager) return;

  const now = new Date().toLocaleString("ko-KR");
  const memoText = `ë‹´ë‹¹ìë¥¼ ${manager}ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`;

  // í™”ë©´ ì¦‰ì‹œ ë°˜ì˜ (íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼)
  const listEl = document.getElementById("historyList");
  const newItem = `
    <div class="timeline-item">
      <div class="timeline-dot"></div>
      <div class="timeline-date">${now}</div>
      <div class="timeline-card">
        <div class="timeline-manager">${manager}</div>
        <div class="timeline-memo">${memoText}</div>
      </div>
    </div>`;
  listEl.insertAdjacentHTML("afterbegin", newItem);

  // GAS ì €ì¥
  const url =
    `${BASE_URL}?action=addMemo` +
    `&name=${encodeURIComponent(selectedStoreName)}` +
    `&memo=${encodeURIComponent(memoText)}` +
    `&manager=${encodeURIComponent(manager)}`;

  fetch(url).catch(err => console.error("ë‹´ë‹¹ì ìë™ ê¸°ë¡ ì˜¤ë¥˜:", err));
});

/*********************  
 * ë‹´ë‹¹ì í•„ìˆ˜ ì„ íƒ  
 * â†’ ë‘ ë²„íŠ¼ ìë™ í™œì„±í™”/ë¹„í™œì„±í™”
 *********************/
const managerSelect = document.getElementById("managerInput");
const statusBtn = document.getElementById("statusSaveBtn");
const memoBtn = document.getElementById("memoSaveBtn");

managerSelect.addEventListener("change", () => {
  const manager = managerSelect.value.trim();
  const enable = manager !== "";

  statusBtn.disabled = !enable;
  memoBtn.disabled = !enable;
});

/*********************
 * ìƒíƒœ ë³€ê²½ ì‹œ ë‹´ë‹¹ì ë¯¸ì„ íƒ ë°©ì§€
 *********************/
function saveStatus() {
  if (!selectedStoreName) {
    alert("ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  const manager = managerSelect.value.trim();
  if (!manager) {
    alert("ë‹´ë‹¹ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const newStatus =
    document.getElementById("statusChangeSelect").value;
  if (!newStatus) {
    alert("ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  const row = rawByName[selectedStoreName];
  if (!row) return;

  row.Status = newStatus;
  applyFilters();

  // GAS ì—…ë°ì´íŠ¸
  const url = `${BASE_URL}?action=updateStatus&name=${encodeURIComponent(
    selectedStoreName
  )}&status=${encodeURIComponent(newStatus)}`;
  fetch(url).catch(e => console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e));

  // íˆìŠ¤í† ë¦¬ ìë™ ê¸°ë¡
  const memoText = `ìƒíƒœë¥¼ '${newStatus}'ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`;
  const url2 =
    `${BASE_URL}?action=addMemo` +
    `&name=${encodeURIComponent(selectedStoreName)}` +
    `&memo=${encodeURIComponent(memoText)}` +
    `&manager=${encodeURIComponent(manager)}`;
  fetch(url2).catch(e =>
    console.error("ìƒíƒœ ë³€ê²½ íˆìŠ¤í† ë¦¬ ê¸°ë¡ ì‹¤íŒ¨:", e)
  );
}

</script>
</body>
</html>

