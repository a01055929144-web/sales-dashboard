<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sales Store Map Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Marker Cluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
    body {
        margin: 0;
        font-family: 'Apple SD Gothic Neo', sans-serif;
        overflow: hidden;
        background: #f8f9fb;
    }

    /* ìƒë‹¨ í•„í„° ì˜ì—­ */
    .top-bar {
        width: 100%;
        padding: 10px;
        display: flex;
        gap: 10px;
        background: #ffffff;
        border-bottom: 1px solid #eee;
        position: fixed;
        top: 0;
        z-index: 999;
    }

    .top-bar input,
    .top-bar select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
    .layout {
        display: flex;
        height: 100vh;
        padding-top: 60px;
    }

    /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
    .sidebar {
        width: 360px;
        background: #ffffff;
        border-right: 1px solid #eee;
        overflow-y: auto;
        padding: 15px;
    }

    .store-item {
        padding: 12px 10px;
        border-bottom: 1px solid #efefef;
        cursor: pointer;
    }

    .store-item:hover {
        background: #f1f5ff;
    }

    .store-title { font-weight: bold; font-size: 15px; margin-bottom: 3px; }
    .store-address { font-size: 13px; color: #666; }
    .store-url { font-size: 13px; color: #0066ff; }

    /* ì§€ë„ */
    #map {
        flex: 1;
        height: 100%;
        position: relative;
    }

    /* ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ */
    .dashboard {
        width: 320px;
        background: #ffffff;
        border-left: 1px solid #eee;
        padding: 15px;
        overflow-y: auto;
        transition: 0.3s ease;
    }

    /* ì ‘í˜ */
    .dashboard.hidden {
        width: 0;
        padding: 0;
        border: none;
        overflow: hidden;
    }

    .toggle-btn {
        position: absolute;
        right: 330px;
        top: 80px;
        z-index: 999;
        background: #fff;
        border: 1px solid #ccc;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
    }

    /* ìƒíƒœ ìƒ‰ìƒ */
    .status-pill {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 12px;
        color: #fff;
    }

    .s-ìš”ì²­ { background: #f8c200; }
    .s-ë¯¸ì‘ë‹µ { background: #7d7d7d; }
    .s-ê±°ì ˆ { background: #e63946; }
    .s-ì™„ë£Œ { background: #007bff; }
    .s-ì„±ì‚¬ { background: #3cb44b; }
</style>
</head>

<body>

<!-- ìƒë‹¨ í•„í„° -->
<div class="top-bar">
    <input id="searchInput" placeholder="ë§¤ì¥ëª… / ì§€ë²ˆ / í‚¤ì›Œë“œ ê²€ìƒ‰" />
    <select id="categoryFilter">
        <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>
    <select id="statusFilter">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
        <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
        <option value="ê±°ì ˆ">ê±°ì ˆ</option>
        <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
        <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
    </select>
</div>

<div class="layout">
    <!-- ì™¼ìª½ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
    <div class="sidebar" id="storeList"></div>

    <!-- ì§€ë„ -->
    <div id="map"></div>

    <!-- ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ -->
    <div class="dashboard" id="dashboard">
        <h3>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h3>
        <div id="dashContent"></div>
    </div>

    <button class="toggle-btn" onclick="toggleDashboard()">ëŒ€ì‹œë³´ë“œ ì ‘ê¸°</button>
</div>

<script>
/* ---------------------------------------------------------
   1) ìƒíƒœ â†’ ìƒ‰ìƒ ë§¤ì¹­
--------------------------------------------------------- */
const statusColor = {
    "ë¯¸íŒ… ìš”ì²­": "#f8c200",
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#7d7d7d",
    "ê±°ì ˆ": "#e63946",
    "ë¯¸íŒ… ì™„ë£Œ": "#007bff",
    "ê±°ë˜ ì„±ì‚¬": "#3cb44b"
};

/* ---------------------------------------------------------
   2) êµ¬ê¸€ì‹œíŠ¸ Web App URL (ì—¬ê¸°ë§Œ ë³¸ì¸ ê²ƒìœ¼ë¡œ êµì²´!)
--------------------------------------------------------- */
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjG-mfQqwp21pjDoZ8VMnnVnHvQgoeDhy8f9UjzRLE0D5Gs53CEuCJ1_EmXkbns7X28H1cZ6kxoME_EQ5_zztRsFEDfRBzlc_WTF4VNsHmPSfQ5_52TRri_zbF_PifgjBzWuoIQ2-5VBLaXyg_6g2JNsF3LAmAfG3xrr-udWMKueJlBl8Fz0ml1g1D1FQHdXvj5nL2ErLo5OtGJr6VsxPBlPvlt95V8K8EF0eyuO4_5CsfP4pvWHkf6LlCwgeuqs7mrKjHXoEwd5eZ0gPWwE9216B5XIGYVRBMnHDrnAQ3WgQEu_08&lib=MCTt9Ziml74IIgZ1LHRXuHrbiB0og-dIC";

/* ---------------------------------------------------------
   3) ì§€ë„ ì´ˆê¸°í™”
--------------------------------------------------------- */
const map = L.map('map').setView([37.55, 126.98], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

let markers = L.markerClusterGroup();
map.addLayer(markers);

let allData = [];

/* ---------------------------------------------------------
   4) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
--------------------------------------------------------- */
async function loadData() {
    const res = await fetch(API_URL);
    const json = await res.json();
    allData = json;

    buildCategoryFilter();
    render();
}

loadData();

/* ---------------------------------------------------------
   5) ì¹´í…Œê³ ë¦¬ í•„í„° ìë™ ìƒì„±
--------------------------------------------------------- */
function buildCategoryFilter() {
    const catSet = [...new Set(allData.map(r => r.category))];
    const sel = document.getElementById("categoryFilter");

    catSet.forEach(c => {
        if (c && c.trim() !== "") {
            const opt = document.createElement("option");
            opt.value = c;
            opt.innerText = c;
            sel.appendChild(opt);
        }
    });
}

/* ---------------------------------------------------------
   6) ë Œë”ë§: ì§€ë„ + ë¦¬ìŠ¤íŠ¸ + ëŒ€ì‹œë³´ë“œ
--------------------------------------------------------- */
function render() {
    const search = document.getElementById("searchInput").value.trim();
    const cat = document.getElementById("categoryFilter").value;
    const status = document.getElementById("statusFilter").value;

    markers.clearLayers();
    document.getElementById("storeList").innerHTML = "";

    const filtered = allData.filter(r => {
        if (search) {
            const key = (r.name + r.keyword + r.roadAddress).toLowerCase();
            if (!key.includes(search.toLowerCase())) return false;
        }
        if (cat && r.category !== cat) return false;
        if (status && r.Status !== status) return false;
        return true;
    });

    filtered.forEach(store => {
        const lat = parseFloat(store.lat);
        const lng = parseFloat(store.lng);
        if (!lat || !lng) return;

        const color = statusColor[store.Status] || "#999";

        const icon = L.divIcon({
            html: `<div style="width:14px;height:14px;background:${color};border-radius:50%;border:2px solid white;"></div>`
        });

        const marker = L.marker([lat, lng], { icon });
        marker.bindPopup(`<b>${store.name}</b><br>${store.roadAddress}<br><a href="${store.URL}" target="_blank">ë°”ë¡œê°€ê¸°</a>`);
        markers.addLayer(marker);

        // ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
        const li = document.createElement("div");
        li.className = "store-item";
        li.innerHTML = `
            <div class="store-title">${store.name}</div>
            <div class="store-address">${store.roadAddress}</div>
            <a class="store-url" href="${store.URL}" target="_blank">ë°”ë¡œê°€ê¸°</a>
        `;
        li.onclick = () => {
            map.setView([lat, lng], 17);
            marker.openPopup();
        };
        document.getElementById("storeList").appendChild(li);
    });

    updateDashboard(filtered);
}

/* ---------------------------------------------------------
   7) ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
--------------------------------------------------------- */
function updateDashboard(list) {
    const total = list.length;
    const ì„±ì‚¬ = list.filter(r => r.Status === "ê±°ë˜ ì„±ì‚¬").length;
    const ì™„ë£Œ = list.filter(r => r.Status === "ë¯¸íŒ… ì™„ë£Œ").length;
    const ìš”ì²­ = list.filter(r => r.Status === "ë¯¸íŒ… ìš”ì²­").length;
    const ë¯¸ì‘ë‹µ = list.filter(r => r.Status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ").length;
    const ê±°ì ˆ = list.filter(r => r.Status === "ê±°ì ˆ").length;

    document.getElementById("dashContent").innerHTML = `
        <p>ì´ ë§¤ì¥ ìˆ˜: <b>${total}</b></p>
        <p>ê±°ë˜ ì„±ì‚¬: ${ì„±ì‚¬}</p>
        <p>ë¯¸íŒ… ì™„ë£Œ: ${ì™„ë£Œ}</p>
        <p>ë¯¸íŒ… ìš”ì²­: ${ìš”ì²­}</p>
        <p>ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ: ${ë¯¸ì‘ë‹µ}</p>
        <p>ê±°ì ˆ: ${ê±°ì ˆ}</p>
    `;
}

/* ---------------------------------------------------------
   8) ëŒ€ì‹œë³´ë“œ í† ê¸€
--------------------------------------------------------- */
function toggleDashboard() {
    const d = document.getElementById("dashboard");
    const btn = document.querySelector(".toggle-btn");

    if (d.classList.contains("hidden")) {
        d.classList.remove("hidden");
        btn.innerText = "ëŒ€ì‹œë³´ë“œ ì ‘ê¸°";
    } else {
        d.classList.add("hidden");
        btn.innerText = "ëŒ€ì‹œë³´ë“œ ì—´ê¸°";
    }
}

/* ---------------------------------------------------------
   9) í•„í„° ì´ë²¤íŠ¸
--------------------------------------------------------- */
document.getElementById("searchInput").addEventListener("input", render);
document.getElementById("categoryFilter").addEventListener("change", render);
document.getElementById("statusFilter").addEventListener("change", render);
</script>
</body>
</html>
