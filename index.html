<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Sales Store Map Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet & MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: #f3f4f6;
    color: #111827;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    padding: 10px 16px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  header h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    white-space: nowrap;
  }
  .header-controls {
    display: flex;
    gap: 8px;
    flex: 1;
    align-items: center;
    position: relative;
  }
  .search-input,
  .select-input {
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    padding: 6px 12px;
    font-size: 13px;
    outline: none;
    background: #f9fafb;
  }
  .search-input { flex: 1; }

  .layout {
    flex: 1;
    display: grid;
    grid-template-columns: 320px minmax(0, 1fr) 320px;
    height: calc(100vh - 52px);
    overflow: hidden;
  }

  /* ì¢Œì¸¡ íŒ¨ë„ */
  .store-panel {
    background: #ffffff;
    border-right: 1px solid #e5e7eb;
    padding: 12px;
    overflow-y: auto;
  }
  .store-panel h2 {
    font-size: 14px;
    margin: 0 0 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .store-count { font-size: 11px; color: #6b7280; }
  .store-list { list-style: none; margin: 0; padding: 0; }
  .store-item {
    padding: 10px 8px;
    border-radius: 10px;
    border: 1px solid #f3f4f6;
    margin-bottom: 6px;
    background: #fff;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .store-item:hover {
    background: #eef2ff;
    border-color: #dbe4ff;
    transform: translateY(-1px);
  }
  .store-name {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .store-meta {
    font-size: 11px;
    color: #6b7280;
  }
  .status-badge {
    display: inline-block;
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 999px;
    color: #ffffff;
    margin-right: 4px;
  }

  #map { width: 100%; height: 100%; }

  /* ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ */
  .dashboard-panel {
    background: #ffffff;
    border-left: 1px solid #e5e7eb;
    padding: 12px;
    overflow-y: auto;
  }
  .dashboard-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .number-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }
  .number-card {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 8px;
    text-align: center;
  }
  .number-title {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 4px;
  }
  .number-value {
    font-size: 16px;
    font-weight: 700;
  }

  .autocomplete {
    position: absolute;
    background: white;
    border: 1px solid #e5e7eb;
    width: 260px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 50;
    border-radius: 8px;
    display: none;
    top: 34px;
    right: 0;
  }
  .autocomplete-item {
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
  }
  .autocomplete-item:hover { background: #f3f4f6; }

  .marker-dot {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
    animation: pop 0.3s ease-out;
  }
  @keyframes pop {
    0% { transform: scale(0.2); }
    80% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .store-detail {
    margin-top: 15px;
    padding: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    font-size: 13px;
  }
  .store-detail h3 { margin: 0 0 8px; font-size: 15px; }

  .photo-carousel {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    margin-top: 8px;
  }
  .photo-carousel img {
    width: 120px;
    height: 90px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
  }

  .history-log {
    margin-top: 10px;
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    padding: 10px;
    max-height: 180px;
    overflow-y: auto;
    font-size: 12px;
  }
  .history-item {
    padding: 6px 4px;
    border-bottom: 1px solid #f1f5f9;
  }
  .history-item:last-child { border-bottom: none; }
  .history-date { font-weight: 600; color: #374151; }
  .history-user { color: #6b7280; font-size: 11px; }
  .history-text { margin-top: 2px; }

  .status-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }
  .status-buttons button {
    border: none;
    border-radius: 999px;
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    background: #e5e7eb;
    color: #111827;
  }

  .toggle-btn {
    margin-top: 10px;
    padding: 6px 10px;
    background: #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    font-size: 12px;
  }
</style>
</head>
<body>

<header>
  <h1>ğŸ“ Sales Store Map Dashboard</h1>
  <div class="header-controls">

    <select id="statusSelect" class="select-input">
      <option value="ALL">ì „ì²´ ìƒíƒœ</option>
    </select>

    <select id="categorySelect" class="select-input">
      <option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <input
      id="searchInput"
      class="search-input"
      type="text"
      placeholder="ë§¤ì¥ëª… / ì§€ì—­ / ë„ë¡œëª…ì£¼ì†Œ / í‚¤ì›Œë“œ ê²€ìƒ‰"
    />

    <div id="autocomplete" class="autocomplete"></div>
  </div>
</header>

<div class="layout">
  <aside class="store-panel">
    <h2>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ <span class="store-count" id="storeCountLabel"></span></h2>
    <ul id="storeList" class="store-list"></ul>
  </aside>

  <main><div id="map"></div></main>

  <aside class="dashboard-panel">
    <div class="dashboard-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>

    <!-- ìˆ«ì ìš”ì•½ ì¹´ë“œ -->
    <div id="numberStats" class="number-stats"></div>

    <!-- ìƒíƒœ ë„ë„› ì°¨íŠ¸ -->
    <canvas id="statusChart" style="width:100%; height:180px;"></canvas>

    <!-- ë™ì„  í† ê¸€ ë²„íŠ¼ -->
    <button id="routeToggle" class="toggle-btn">ë™ì„  ë³´ê¸° í† ê¸€</button>

    <!-- ìƒì„¸ ì •ë³´ -->
    <div id="storeDetail" class="store-detail"></div>

    <!-- ì‚¬ì§„ ìºëŸ¬ì…€ -->
    <div id="storePhotos" class="photo-carousel"></div>

    <!-- íˆìŠ¤í† ë¦¬ ë¡œê·¸ -->
    <div id="historyLog" class="history-log"></div>

    <!-- ìƒíƒœ ë³€ê²½ ë²„íŠ¼ -->
    <div class="status-buttons">
      <button class="status-button" data-status="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</button>
      <button class="status-button" data-status="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</button>
      <button class="status-button" data-status="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</button>
      <button class="status-button" data-status="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</button>
      <button class="status-button" data-status="ê±°ì ˆ">ê±°ì ˆ</button>
    </div>
  </aside>
</div>

<!-- Leaflet Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* â­ WebApp BASE URL (action ì—†ìŒ) */
const BASE_URL =
  "https://script.google.com/macros/s/AKfycbz3V3zX-zdYbwajKaZjktsClGesOFEoTHqDsHHFrWdr6BdbYmgDPaXiNbYH5gNNtTVv/exec";

const PLACES_URL  = BASE_URL + "?action=places";

let rawRows = [];
let filteredRows = [];
let map, markerCluster, chartInstance;
let currentStore = null;
let routeLayer = null;

/* ìƒíƒœ ìƒ‰ìƒ */
const STATUS_COLOR = {
  "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
  "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
  "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#95a5a6",
  "ê±°ì ˆ": "#e74c3c"
};

/* ì´ˆê¸° ë¡œë“œ */
window.addEventListener("load", async () => {
  initMap();
  initEvents();
  loadFilters();
  await loadData();
});

/* ì§€ë„ */
function initMap() {
  map = L.map("map", {
    center: [37.5665, 126.9780],
    zoom: 11,
    zoomControl: true
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  markerCluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    maxClusterRadius: 40
  });
  map.addLayer(markerCluster);
}

function initEvents() {
  document.getElementById("searchInput").addEventListener("input", () => {
    applyFilters();
    saveFilters();
    showAutocomplete();
  });
  document.getElementById("categorySelect").addEventListener("change", () => {
    applyFilters(); saveFilters();
  });
  document.getElementById("statusSelect").addEventListener("change", () => {
    applyFilters(); saveFilters();
  });

  document.getElementById("routeToggle").addEventListener("click", toggleRoute);

  document.querySelectorAll(".status-button").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const newStatus = e.target.dataset.status;
      await onChangeStatus(newStatus);
    });
  });
}

/* ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadData() {
  const res = await fetch(PLACES_URL);
  const json = await res.json();

  rawRows = json.filter(r => r.lat && r.lng);
  buildFilters(rawRows);
  applyFilters();
}

/* í•„í„° ëª©ë¡ ìƒì„± */
function buildFilters(rows) {
  const statusSet = new Set();
  const categorySet = new Set();

  rows.forEach(r => {
    if (r.Status) statusSet.add(r.Status);
    if (r.category) categorySet.add(r.category.split(">")[0].trim());
  });

  const statusSelect = document.getElementById("statusSelect");
  const categorySelect = document.getElementById("categorySelect");

  // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€(ALL ì œì™¸ ì œê±° í›„ ì¬ìƒì„±)í•  ìˆ˜ë„ ìˆì§€ë§Œ, ê°„ë‹¨íˆ í•œ ë²ˆë§Œ ìƒì„±í•˜ëŠ” ì „ì œ
  if (statusSelect.options.length === 1) {
    [...statusSet].sort().forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      statusSelect.appendChild(opt);
    });
  }

  if (categorySelect.options.length === 1) {
    [...categorySet].sort().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      categorySelect.appendChild(opt);
    });
  }
}

/* ìë™ì™„ì„± */
function showAutocomplete() {
  const ac = document.getElementById("autocomplete");
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  if (!q) { ac.style.display = "none"; return; }

  const matched = rawRows.filter(r =>
    (r.name || "").toLowerCase().includes(q) ||
    (r.roadAddress || "").toLowerCase().includes(q) ||
    (r.keyword || "").toLowerCase().includes(q)
  ).slice(0, 10);

  ac.innerHTML = matched.map(r =>
    `<div class="autocomplete-item">${r.name}</div>`
  ).join("");

  ac.style.display = matched.length ? "block" : "none";

  document.querySelectorAll(".autocomplete-item").forEach((el, i) => {
    el.addEventListener("click", () => {
      const store = matched[i];
      document.getElementById("searchInput").value = store.name;
      ac.style.display = "none";
      map.setView([store.lat, store.lng], 17);
      showStoreDetail(store);
      applyFilters();
    });
  });
}

/* í•„í„° ì ìš© */
function applyFilters() {
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const cat = document.getElementById("categorySelect").value;
  const st = document.getElementById("statusSelect").value;

  filteredRows = rawRows.filter(r => {
    const text = `${r.name} ${r.sigungu} ${r.roadAddress} ${r.keyword}`.toLowerCase();
    const matchSearch = !q || text.includes(q);

    const major = (r.category || "").split(">")[0].trim();
    const matchCat = cat === "ALL" || major === cat;
    const matchStatus = st === "ALL" || r.Status === st;

    return matchSearch && matchCat && matchStatus;
  });

  renderAll();
}

/* ì „ì²´ ë Œë”ë§ */
function renderAll() {
  renderMarkers();
  renderStoreList();
  renderStats(filteredRows);

  // ë™ì„  ë‹¤ì‹œ ê·¸ë¦¼
  if (routeLayer) {
    map.removeLayer(routeLayer);
    drawRouteLine();
  }
}

/* ë§ˆì»¤ */
function createMarkerIcon(status) {
  return L.divIcon({
    className: "custom-marker",
    html: `<div class="marker-dot" style="background:${STATUS_COLOR[status] || "#7f8c8d"}"></div>`,
    iconSize: [18, 18], iconAnchor: [9, 9]
  });
}

function renderMarkers() {
  markerCluster.clearLayers();
  filteredRows.forEach(r => {
    const marker = L.marker([r.lat, r.lng], {
      icon: createMarkerIcon(r.Status)
    });
    markerCluster.addLayer(marker);
  });
}

/* ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ */
function renderStoreList() {
  const list = document.getElementById("storeList");
  list.innerHTML = "";
  document.getElementById("storeCountLabel").textContent =
    `${filteredRows.length}ê°œ`;

  filteredRows.slice(0, 500).forEach(r => {
    const li = document.createElement("li");
    li.className = "store-item";

    const major = (r.category || "").split(">")[0];

    li.innerHTML = `
      <div class="store-name">${r.name || "ë§¤ì¥ëª… ì—†ìŒ"}</div>
      <div class="store-meta">
        <span class="status-badge" style="background:${STATUS_COLOR[r.Status] || "#9ca3af"}">${r.Status || "ìƒíƒœ ì—†ìŒ"}</span>
        ${major || "ê¸°íƒ€"} Â· ${r.sigungu || ""}
      </div>
      <div class="store-meta">${r.roadAddress || ""}</div>
    `;

    li.addEventListener("click", () => {
      map.setView([r.lat, r.lng], 17);
      showStoreDetail(r);
    });

    list.appendChild(li);
  });
}

/* ìƒì„¸ ì •ë³´ + íˆìŠ¤í† ë¦¬ + ì‚¬ì§„ */
async function showStoreDetail(r) {
  currentStore = r;

  const box = document.getElementById("storeDetail");
  const photosBox = document.getElementById("storePhotos");
  const historyBox = document.getElementById("historyLog");

  box.innerHTML = `
    <h3>${r.name || "ë§¤ì¥ëª… ì—†ìŒ"}</h3>
    <div><strong>ì£¼ì†Œ:</strong> ${r.roadAddress || ""}</div>
    <div><strong>ìƒíƒœ:</strong> ${r.Status || ""}</div>
    <div><strong>ì¹´í…Œê³ ë¦¬:</strong> ${(r.category || "").split(">")[0]}</div>
    <div><strong>ì‹œêµ°êµ¬:</strong> ${r.sigungu || ""}</div>
    <div><strong>ë¸”ë¡œê·¸ ìˆ˜:</strong> ${r.blog_count || "-"}</div>
    <div><strong>í‚¤ì›Œë“œ:</strong> ${r.keyword || ""}</div>
    ${r.URL ? `<div><a href="${r.URL}" target="_blank">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì—´ê¸°</a></div>` : ""}
  `;

  photosBox.innerHTML = "";
  historyBox.innerHTML = "íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  // íˆìŠ¤í† ë¦¬ ë¡œë“œ
  try {
    const storeId = r.store_id || (r.name + "|" + r.roadAddress);
    const resH = await fetch(`${BASE_URL}?action=history&storeId=${encodeURIComponent(storeId)}`);
    const logs = await resH.json();
    if (logs.length === 0) {
      historyBox.innerHTML = "<div class='history-item'>íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    } else {
      historyBox.innerHTML = logs.map(log => `
        <div class="history-item">
          <div class="history-date">${formatDate(log.date)}</div>
          <div class="history-user">${log.user || ""}</div>
          <div class="history-text">${log.memo || ""}</div>
        </div>
      `).join("");
    }
  } catch (e) {
    historyBox.innerHTML = "<div class='history-item'>íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>";
  }

  // ì‚¬ì§„ ë¡œë“œ (og:image 1ê°œ)
  if (r.URL) {
    try {
      const resP = await fetch(`${BASE_URL}?action=photos&url=${encodeURIComponent(r.URL)}`);
      const imgs = await resP.json();
      if (imgs.length > 0) {
        photosBox.innerHTML = imgs.slice(0, 5).map(src =>
          `<img src="${src}" onclick="window.open('${src}')" />`
        ).join("");
      } else {
        photosBox.innerHTML = "";
      }
    } catch (e) {
      photosBox.innerHTML = "";
    }
  }
}

function formatDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const day = String(dt.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/* ìˆ«ì + ì°¨íŠ¸ */
function renderStats(rows) {
  const stats = {
    total: rows.length,
    deal: 0,
    meetingDone: 0,
    request: 0,
    noAnswer: 0,
    reject: 0
  };

  rows.forEach(r => {
    if (r.Status === "ê±°ë˜ ì„±ì‚¬") stats.deal++;
    else if (r.Status === "ë¯¸íŒ… ì™„ë£Œ") stats.meetingDone++;
    else if (r.Status === "ë¯¸íŒ… ìš”ì²­") stats.request++;
    else if (r.Status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") stats.noAnswer++;
    else if (r.Status === "ê±°ì ˆ") stats.reject++;
  });

  renderNumberStats(stats);
  renderStatusChart(stats);
}

function renderNumberStats(stats) {
  const progress = stats.total > 0
    ? ((stats.deal + stats.meetingDone) / stats.total * 100).toFixed(1)
    : 0;

  document.getElementById("numberStats").innerHTML = `
    <div class="number-card">
      <div class="number-title">ì´ ë§¤ì¥ ìˆ˜</div>
      <div class="number-value">${stats.total}</div>
    </div>
    <div class="number-card">
      <div class="number-title">ê±°ë˜ ì„±ì‚¬</div>
      <div class="number-value">${stats.deal}</div>
    </div>
    <div class="number-card">
      <div class="number-title">ë¯¸íŒ… ì™„ë£Œ</div>
      <div class="number-value">${stats.meetingDone}</div>
    </div>
    <div class="number-card">
      <div class="number-title">ì§„í–‰ë¥ </div>
      <div class="number-value">${progress}%</div>
    </div>
    <div class="number-card">
      <div class="number-title">ë¯¸íŒ… ìš”ì²­</div>
      <div class="number-value">${stats.request}</div>
    </div>
    <div class="number-card">
      <div class="number-title">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
      <div class="number-value">${stats.noAnswer}</div>
    </div>
  `;
}

function renderStatusChart(stats) {
  const ctx = document.getElementById("statusChart");

  const labels = ["ê±°ë˜ ì„±ì‚¬", "ë¯¸íŒ… ì™„ë£Œ", "ë¯¸íŒ… ìš”ì²­", "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ", "ê±°ì ˆ"];
  const values = [
    stats.deal,
    stats.meetingDone,
    stats.request,
    stats.noAnswer,
    stats.reject
  ];

  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: ["#2ecc71","#3498db","#f1c40f","#95a5a6","#e74c3c"]
      }]
    },
    options: {
      cutout: "60%",
      responsive: true,
      plugins: { legend: { position: "bottom" } }
    }
  });
}

/* ë™ì„  (Polyline) */
function toggleRoute() {
  if (routeLayer) {
    map.removeLayer(routeLayer);
    routeLayer = null;
  } else {
    drawRouteLine();
  }
}

function drawRouteLine() {
  if (filteredRows.length < 2) return;
  const points = filteredRows.map(r => [r.lat, r.lng]);
  routeLayer = L.polyline(points, {
    color: "#3498db",
    weight: 3,
    dashArray: "4, 6"
  }).addTo(map);
}

/* ìƒíƒœ ë³€ê²½ */
async function onChangeStatus(newStatus) {
  if (!currentStore) {
    alert("ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }
  if (!confirm(`ìƒíƒœë¥¼ "${newStatus}"(ìœ¼)ë¡œ ë³€ê²½í• ê¹Œìš”?`)) return;

  const rowId = currentStore._row;
  const storeId = currentStore.store_id || (currentStore.name + "|" + currentStore.roadAddress);

  const url =
    `${BASE_URL}?action=updateStatus&id=${encodeURIComponent(rowId)}&status=${encodeURIComponent(newStatus)}&storeId=${encodeURIComponent(storeId)}`;

  await fetch(url);
  await loadData();
  applyFilters();

  // ë³€ê²½ëœ ë§¤ì¥ ë‹¤ì‹œ ì°¾ì•„ì„œ ìƒì„¸ì •ë³´ ê°±ì‹ 
  const updated = rawRows.find(r => r._row === rowId);
  if (updated) showStoreDetail(updated);
}

/* í•„í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° */
function saveFilters() {
  localStorage.setItem("filterStatus", document.getElementById("statusSelect").value);
  localStorage.setItem("filterCategory", document.getElementById("categorySelect").value);
  localStorage.setItem("filterSearch", document.getElementById("searchInput").value);
}

function loadFilters() {
  const st = localStorage.getItem("filterStatus");
  const cat = localStorage.getItem("filterCategory");
  const q = localStorage.getItem("filterSearch");

  if (st) document.getElementById("statusSelect").value = st;
  if (cat) document.getElementById("categorySelect").value = cat;
  if (q) document.getElementById("searchInput").value = q;
}
</script>
</body>
</html>
