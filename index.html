<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Store Map Dashboard</title>

  <!-- Leaflet ê¸°ë³¸ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f3f4f7;
      color: #222;
    }

    header {
      padding: 14px 20px;
      font-size: 20px;
      font-weight: 700;
      background: #ffffff;
      border-bottom: 1px solid #e3e4ea;
    }

    .container {
      padding: 16px 16px 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* í•„í„° ì˜ì—­ */
    #filters {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    #filters input,
    #filters select {
      flex: 1;
      padding: 9px 11px;
      border-radius: 8px;
      border: 1px solid #d0d2dc;
      font-size: 14px;
      background: #fff;
    }

    #filters input {
      flex: 2.2;
    }

    #map {
      width: 100%;
      height: 60vh;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #d0d2dc;
    }

    /* ì•„ë˜ ì˜ì—­: ëŒ€ì‹œë³´ë“œ / ë¦¬ìŠ¤íŠ¸ */
    #bottom-row {
      display: flex;
      gap: 14px;
      margin-top: 16px;
    }

    #dashboard {
      flex: 0.9;
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 14px 10px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      min-width: 260px;
    }

    #store-panel {
      flex: 2.1;
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 14px 6px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      max-height: 32vh;
      overflow-y: auto;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 19px;
    }

    h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .kpi-card {
      background: #f7f8fc;
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
    }

    .kpi-label {
      color: #6b7280;
      margin-bottom: 3px;
    }

    .kpi-value {
      font-size: 17px;
      font-weight: 700;
    }

    /* ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ */
    #store-panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    #store-count {
      font-size: 13px;
      color: #6b7280;
    }

    .store-item {
      padding: 6px 0;
      border-bottom: 1px solid #f0f1f6;
      font-size: 13px;
    }

    .store-item:last-child {
      border-bottom: none;
      margin-bottom: 6px;
    }

    .store-name-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }

    .store-name {
      font-weight: 600;
      font-size: 13px;
    }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      color: #ffffff;
      white-space: nowrap;
    }

    .category-text {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 1px;
    }

    .address-text {
      font-size: 11px;
      color: #6b7280;
    }

    .store-link {
      font-size: 11px;
      color: #2563eb;
      text-decoration: none;
    }

    .store-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 960px) {
      #bottom-row {
        flex-direction: column;
      }
      #store-panel {
        max-height: none;
      }
    }
  </style>
</head>

<body>
<header>ğŸ“ Sales Store Map Dashboard</header>

<div class="container">

  <!-- í•„í„° ì˜ì—­ -->
  <div id="filters">
    <input id="searchInput" placeholder="ë§¤ì¥ëª… / ì‹œêµ°êµ¬ / ë„ë¡œëª…ì£¼ì†Œ / í‚¤ì›Œë“œ ê²€ìƒ‰" />

    <select id="categoryFilter">
      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <select id="statusFilter">
      <option value="">ì „ì²´ ìƒíƒœ</option>
      <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
      <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
      <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
      <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
      <option value="ê±°ì ˆ">ê±°ì ˆ</option>
    </select>
  </div>

  <!-- ì§€ë„ -->
  <div id="map"></div>

  <!-- ì•„ë˜ ëŒ€ì‹œë³´ë“œ + ë¦¬ìŠ¤íŠ¸ -->
  <div id="bottom-row">
    <section id="dashboard">
      <h3>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h3>
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">ì´ ë§¤ì¥ ìˆ˜</div>
          <div class="kpi-value" id="kpi-total">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ê±°ë˜ ì„±ì‚¬</div>
          <div class="kpi-value" id="kpi-deal">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ë¯¸íŒ… ì™„ë£Œ</div>
          <div class="kpi-value" id="kpi-done">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ë¯¸íŒ… ìš”ì²­</div>
          <div class="kpi-value" id="kpi-request">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
          <div class="kpi-value" id="kpi-noanswer">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ê±°ì ˆ</div>
          <div class="kpi-value" id="kpi-deny">0</div>
        </div>
      </div>
    </section>

    <section id="store-panel">
      <div id="store-panel-title">
        <h3>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</h3>
        <div id="store-count"></div>
      </div>
      <div id="store-list"></div>
    </section>
  </div>

</div>

<script>
  // â­ Apps Script JSON API
  const API_URL =
    "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

  // ìƒíƒœë³„ ìƒ‰ìƒ
  const STATUS_COLOR = {
    "ë¯¸íŒ… ìš”ì²­": "#f1c40f",      // ë…¸ë‘
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#7f8c8d",  // íšŒìƒ‰
    "ê±°ì ˆ": "#e74c3c",          // ë¹¨ê°•
    "ë¯¸íŒ… ì™„ë£Œ": "#3498db",    // íŒŒë‘
    "ê±°ë˜ ì„±ì‚¬": "#2ecc71"     // ì´ˆë¡
  };

  let map;
  let markerCluster;
  let rawData = [];
  let normalizedData = [];

  function initMap() {
    map = L.map("map").setView([37.5665, 126.9780], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    loadData();
  }

  // ì‹œíŠ¸ â†’ í”„ë¡ íŠ¸ì—ì„œ ì‚¬ìš©í•  í˜•íƒœë¡œ ì •ê·œí™”
  function normalizeRow(r) {
    const lat = Number(r.lat || r.Lat || r.latitude || r.LAT);
    const lng = Number(r.lng || r.Lng || r.longitude || r.LNG);

    const categoryFull = (r.category || r.Category || "").toString();
    const bigCategory = categoryFull.split(">")[0].trim();

    return {
      name: r.name || r.Name || "",
      sigungu: r.sigungu || r.ì‹œêµ°êµ¬ || "",
      blog_count: r.blog_count || r.blogCount || "",
      keyword: r.keyword || "",
      address: r.address || r.roadAddress || r.ì£¼ì†Œ || "",
      url: r.url || r.URL || "",
      manager: r.manager || r["Manager(Call)"] || "",
      status: r.status || r.Status || "",
      lat,
      lng,
      categoryFull,
      bigCategory
    };
  }

  async function loadData() {
    try {
      const res = await fetch(API_URL);
      rawData = await res.json();

      normalizedData = rawData.map(normalizeRow);

      buildCategoryFilter(normalizedData);
      applyFilters(); // ì²« ë Œë”ë§
    } catch (err) {
      console.error("ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", err);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  function buildCategoryFilter(rows) {
    const select = document.getElementById("categoryFilter");
    select.innerHTML = `<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>`;

    const cats = [...new Set(rows.map(r => r.bigCategory).filter(Boolean))].sort();
    cats.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      select.appendChild(opt);
    });
  }

  function applyFilters() {
    const kw = document.getElementById("searchInput").value.trim();
    const cat = document.getElementById("categoryFilter").value;
    const st = document.getElementById("statusFilter").value;

    const filtered = normalizedData.filter(r => {
      if (kw) {
        const inText =
          (r.name && r.name.includes(kw)) ||
          (r.sigungu && r.sigungu.includes(kw)) ||
          (r.address && r.address.includes(kw)) ||
          (r.keyword && r.keyword.includes(kw));
        if (!inText) return false;
      }

      if (cat && r.bigCategory !== cat) return false;

      if (st && r.status !== st) return false;

      return true;
    });

    renderMarkers(filtered);
    renderDashboard(filtered);
    renderStoreList(filtered);
  }

  function renderMarkers(rows) {
    markerCluster.clearLayers();

    rows.forEach(r => {
      if (isNaN(r.lat) || isNaN(r.lng)) return;

      const color = STATUS_COLOR[r.status] || "#6b7280";

      const marker = L.circleMarker([r.lat, r.lng], {
        radius: 8,
        color: color,
        fillColor: color,
        fillOpacity: 0.9
      });

      const popupHtml = `
        <div style="font-size:12px;">
          <b>${r.name}</b><br/>
          <span>${r.address}</span><br/>
          <span>${r.status || ""}</span><br/>
          ${r.url ? `<a href="${r.url}" target="_blank">ë§í¬ ì—´ê¸°</a>` : ""}
        </div>
      `;

      marker.bindPopup(popupHtml);
      markerCluster.addLayer(marker);
    });
  }

  function renderDashboard(rows) {
    const total = rows.length;
    let deal = 0, done = 0, request = 0, noanswer = 0, deny = 0;

    rows.forEach(r => {
      const s = r.status;
      if (s === "ê±°ë˜ ì„±ì‚¬") deal++;
      else if (s === "ë¯¸íŒ… ì™„ë£Œ") done++;
      else if (s === "ë¯¸íŒ… ìš”ì²­") request++;
      else if (s === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") noanswer++;
      else if (s === "ê±°ì ˆ") deny++;
    });

    document.getElementById("kpi-total").textContent = total;
    document.getElementById("kpi-deal").textContent = deal;
    document.getElementById("kpi-done").textContent = done;
    document.getElementById("kpi-request").textContent = request;
    document.getElementById("kpi-noanswer").textContent = noanswer;
    document.getElementById("kpi-deny").textContent = deny;
  }

  function renderStoreList(rows) {
    const box = document.getElementById("store-list");
    const countBox = document.getElementById("store-count");

    countBox.textContent = `${rows.length}ê°œ ë§¤ì¥`;

    box.innerHTML = "";

    rows.forEach(r => {
      const color = STATUS_COLOR[r.status] || "#6b7280";

      const div = document.createElement("div");
      div.className = "store-item";
      div.innerHTML = `
        <div class="store-name-row">
          <span class="store-name">${r.name}</span>
          ${
            r.status
              ? `<span class="badge" style="background:${color};">${r.status}</span>`
              : ""
          }
        </div>
        ${
          r.categoryFull
            ? `<div class="category-text">ì¹´í…Œê³ ë¦¬: ${r.categoryFull}</div>`
            : ""
        }
        <div class="address-text">${r.address || ""}</div>
        ${
          r.url
            ? `<a class="store-link" href="${r.url}" target="_blank">URL ì—´ê¸°</a>`
            : ""
        }
      `;
      box.appendChild(div);
    });
  }

  document.getElementById("searchInput").addEventListener("input", applyFilters);
  document.getElementById("categoryFilter").addEventListener("change", applyFilters);
  document.getElementById("statusFilter").addEventListener("change", applyFilters);

  window.onload = initMap;
</script>

</body>
</html>
