<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sales Store Map Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Marker Cluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
  body { margin: 0; background: #f5f6fa; font-family: "Pretendard", sans-serif; }
  #map { height: 60vh; width: 100%; border-radius: 10px; }

  .container { width: 95%; margin: auto; padding-top: 15px; }
  .filters { display: flex; gap: 10px; margin-bottom: 10px; }
  input, select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 100%; }

  /* ì¹´ë“œ */
  .dash-container { display: flex; gap: 10px; margin-top: 15px; }
  .card {
    flex: 1;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  }

  .store-list { max-height: 55vh; overflow-y: auto; }
  .store-item { padding: 10px 0; border-bottom: 1px solid #eee; }

  .status-badge {
    display: inline-block;
    padding: 3px 7px;
    border-radius: 5px;
    color: white;
    font-size: 12px;
  }

  .green { background:#2ecc71; }
  .blue { background:#3498db; }
  .orange { background:#e67e22; }
  .gray { background:#7f8c8d; }
  .red { background:#e74c3c; }

</style>
</head>

<body>
<div class="container">
  <!-- í•„í„° -->

  <div class="filters">
    <input id="searchInput" placeholder="ë§¤ì¥ëª… / ì§€ë²ˆ / í‚¤ì›Œë“œ ê²€ìƒ‰" />

    <select id="categoryFilter">
      <option value="ì „ì²´">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    </select>

    <select id="statusFilter">
      <option value="ì „ì²´">ì „ì²´ ìƒíƒœ</option>
    </select>
  </div>

  <!-- ì§€ë„ -->
  <div id="map"></div>

  <!-- ì•„ë˜ ë ˆì´ì•„ì›ƒ -->
  <div class="dash-container">
    <!-- ëŒ€ì‹œë³´ë“œ -->
    <div class="card" id="dashboardCard">
      <h3>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h3>
      <p>ì´ ë§¤ì¥ ìˆ˜: <b id="totalCount">0</b></p>
      <p>ê±°ë˜ ì„±ì‚¬: <b id="doneCount">0</b></p>
      <p>ë¯¸íŒ… ì™„ë£Œ: <b id="meetingDoneCount">0</b></p>
      <p>ë¯¸íŒ… ìš”ì²­: <b id="meetingReqCount">0</b></p>
      <p>ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ: <b id="noRespCount">0</b></p>
      <p>ê±°ì ˆ: <b id="rejectCount">0</b></p>
    </div>

    <!-- ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card store-list" id="storeListCard">
      <h3>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</h3>
      <div id="storeList"></div>
    </div>
  </div>
</div>

<script>
/* -----------------------------------------------
    1) API URL
------------------------------------------------*/
const API_URL =
 "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

/* -----------------------------------------------
    2) ìƒíƒœê°’ â†’ ìƒ‰ìƒ ë§¤í•‘
------------------------------------------------*/
const statusColor = {
  "ê±°ë˜ ì„±ì‚¬": "green",
  "ë¯¸íŒ… ì™„ë£Œ": "blue",
  "ë¯¸íŒ… ìš”ì²­": "orange",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "gray",
  "ê±°ì ˆ": "red",
};

/* -----------------------------------------------
    3) ì „ì—­
------------------------------------------------*/
let map;
let markers = L.markerClusterGroup();
let rawData = [];

/* -----------------------------------------------
    4) ì§€ë„ ì´ˆê¸°í™”
------------------------------------------------*/
function initMap() {
  map = L.map('map').setView([37.55, 126.97], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  map.addLayer(markers);

  loadData();
}

/* -----------------------------------------------
    5) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
------------------------------------------------*/
async function loadData() {
  const res = await fetch(API_URL);
  rawData = await res.json();

  buildFilters();     // ì¹´í…Œê³ ë¦¬/ìƒíƒœ í•„í„° ìƒì„±
  renderAll(rawData); // ì§€ë„ + ë¦¬ìŠ¤íŠ¸ + ëŒ€ì‹œë³´ë“œ
}

/* -----------------------------------------------
    6) í•„í„° UI êµ¬ì„±
------------------------------------------------*/
function buildFilters() {
  const categories = [...new Set(rawData.map(r => r.category))].sort();
  const statuses = [...new Set(rawData.map(r => r.status))];

  const catSel = document.getElementById("categoryFilter");
  const stSel = document.getElementById("statusFilter");

  categories.forEach(c => {
    catSel.innerHTML += `<option value="${c}">${c}</option>`;
  });

  statuses.forEach(s => {
    stSel.innerHTML += `<option value="${s}">${s}</option>`;
  });

  catSel.onchange = applyFilter;
  stSel.onchange = applyFilter;
  document.getElementById("searchInput").oninput = applyFilter;
}

/* -----------------------------------------------
    7) í•„í„° ì ìš©
------------------------------------------------*/
function applyFilter() {
  let keyword = document.getElementById("searchInput").value.trim().toLowerCase();
  let cat = document.getElementById("categoryFilter").value;
  let st = document.getElementById("statusFilter").value;

  const filtered = rawData.filter(r => {
    if (cat !== "ì „ì²´" && r.category !== cat) return false;
    if (st !== "ì „ì²´" && r.status !== st) return false;

    if (keyword) {
      const t = (r.name + r.keyword + r.roadAddress).toLowerCase();
      if (!t.includes(keyword)) return false;
    }
    return true;
  });

  renderAll(filtered);
}

/* -----------------------------------------------
    8) ì „ì²´ ë Œë”ë§ (ì§€ë„ + ë¦¬ìŠ¤íŠ¸ + ëŒ€ì‹œë³´ë“œ)
------------------------------------------------*/
function renderAll(data) {
  renderMarkers(data);
  renderList(data);
  renderDashboard(data);
}

/* -----------------------------------------------
    9) ì§€ë„ ë§ˆì»¤
------------------------------------------------*/
function renderMarkers(data) {
  markers.clearLayers();

  data.forEach(r => {
    if (!r.lat || !r.lng) return;

    const color = statusColor[r.status] || "gray";

    const icon = L.divIcon({
      className: "",
      html: `<div style="
        width:18px;
        height:18px;
        background:${color};
        border-radius:50%;
        border:2px solid white;
      "></div>`
    });

    const marker = L.marker([r.lat, r.lng], { icon });

    marker.bindPopup(`
      <b>${r.name}</b><br>
      ${r.roadAddress}<br>
      <a href="${r.url}" target="_blank">URL ì´ë™</a><br>
      ìƒíƒœ: ${r.status}
    `);

    markers.addLayer(marker);
  });
}

/* -----------------------------------------------
    10) ë¦¬ìŠ¤íŠ¸ UI
------------------------------------------------*/
function renderList(data) {
  const box = document.getElementById("storeList");

  box.innerHTML = data.map(r => `
    <div class="store-item">
      <div><b>${r.name}</b></div>
      <div>${r.roadAddress}</div>
      <div>
        <span class="status-badge ${statusColor[r.status]}">${r.status}</span>
        Â· <a href="${r.url}" target="_blank">ë°”ë¡œê°€ê¸°</a>
      </div>
    </div>
  `).join("");
}

/* -----------------------------------------------
    11) ëŒ€ì‹œë³´ë“œ UI
------------------------------------------------*/
function renderDashboard(data) {
  const count = {
    total: data.length,
    deal: data.filter(r => r.status === "ê±°ë˜ ì„±ì‚¬").length,
    done: data.filter(r => r.status === "ë¯¸íŒ… ì™„ë£Œ").length,
    req: data.filter(r => r.status === "ë¯¸íŒ… ìš”ì²­").length,
    noresp: data.filter(r => r.status === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ").length,
    reject: data.filter(r => r.status === "ê±°ì ˆ").length
  };

  document.getElementById("totalCount").innerText = count.total;
  document.getElementById("doneCount").innerText = count.deal;
  document.getElementById("meetingDoneCount").innerText = count.done;
  document.getElementById("meetingReqCount").innerText = count.req;
  document.getElementById("noRespCount").innerText = count.noresp;
  document.getElementById("rejectCount").innerText = count.reject;
}

/* -----------------------------------------------
    ì‹œì‘
------------------------------------------------*/
initMap();
</script>
</body>
</html>
