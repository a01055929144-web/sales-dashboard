<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Store Map Dashboard</title>

<!-- Leaflet ê¸°ë³¸ CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Marker Cluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<style>
  body {
    margin: 0;
    font-family: "Noto Sans KR", sans-serif;
    background: #f6f7fb;
  }
  header {
    padding: 15px 20px;
    font-size: 22px;
    font-weight: bold;
    background: white;
    border-bottom: 1px solid #eee;
  }
  #container {
    display: flex;
    padding: 15px;
    gap: 15px;
  }
  #left-side {
    flex: 7;
  }
  #right-side {
    flex: 3;
  }
  #map {
    width: 100%;
    height: 65vh;
    border-radius: 10px;
  }
  #filters {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  input, select {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    width: 100%;
  }
  /* Dashboard ì¹´ë“œ */
  .card {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    margin-bottom: 12px;
  }
  .kpi-box {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .kpi {
    width: 48%;
    padding: 12px;
    background: #fafafa;
    border-radius: 8px;
    font-size: 14px;
  }
  /* ë¦¬ìŠ¤íŠ¸ */
  #store-list {
    margin-top: 15px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    height: 25vh;
    overflow-y: auto;
  }
  .store-item {
    padding: 6px 0;
    border-bottom: 1px solid #eee;
  }
  .badge {
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px;
    margin-left: 6px;
    color: white;
  }
</style>
</head>

<body>

<header>ğŸ“ Sales Store Map Dashboard</header>

<div id="container">
  <!-- ì™¼ìª½ ì˜ì—­ -->
  <div id="left-side">

    <!-- ğŸ” ê²€ìƒ‰/í•„í„° -->
    <div id="filters">
      <input id="searchInput" placeholder="ë§¤ì¥ëª… / ì§€ë²ˆ / í‚¤ì›Œë“œ ê²€ìƒ‰" />

      <select id="categoryFilter">
        <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
      </select>

      <select id="statusFilter">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <option>ë¯¸íŒ… ìš”ì²­</option>
        <option>ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
        <option>ê±°ì ˆ</option>
        <option>ë¯¸íŒ… ì™„ë£Œ</option>
        <option>ê±°ë˜ ì„±ì‚¬</option>
      </select>
    </div>

    <!-- ì§€ë„ -->
    <div id="map"></div>

    <!-- ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
    <div id="store-list">
      <b>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</b> (í•„í„° ì ìš©)
      <div id="store-items"></div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ Dashboard -->
  <div id="right-side">

    <div class="card">
      <h3>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h3>

      <div class="kpi-box">
        <div class="kpi">
          <b>ì´ ë§¤ì¥ ìˆ˜</b><br>
          <span id="stat-total">0</span>
        </div>

        <div class="kpi">
          <b>ê±°ë˜ ì„±ì‚¬</b><br>
          <span id="stat-deal">0</span>
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi">
          <b>ë¯¸íŒ… ì™„ë£Œ</b><br>
          <span id="stat-done">0</span>
        </div>

        <div class="kpi">
          <b>ë¯¸íŒ… ìš”ì²­</b><br>
          <span id="stat-request">0</span>
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi">
          <b>ë¶€ì¬ì¤‘ / ë¯¸ì‘ë‹µ</b><br>
          <span id="stat-noanswer">0</span>
        </div>

        <div class="kpi">
          <b>ê±°ì ˆ</b><br>
          <span id="stat-deny">0</span>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// â­ ë°ì´í„° API (Apps Script)
const API_URL =
 "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

// ì§€ë„ + í´ëŸ¬ìŠ¤í„°
let map;
let markerCluster;

// ì›ë³¸ ë°ì´í„°
let storeData = [];

// ------------------------------
// ìƒíƒœê°’ ìƒ‰ìƒ ê·œì¹™
// ------------------------------
function getStatusColor(statusRaw) {
  if (!statusRaw) return "gray";
  const s = statusRaw.toLowerCase();

  if (s.includes("ê±°ë˜ ì„±ì‚¬")) return "green";
  if (s.includes("ë¯¸íŒ… ì™„ë£Œ")) return "blue";
  if (s.includes("ë¯¸íŒ… ìš”ì²­")) return "orange";
  if (s.includes("ë¶€ì¬ì¤‘") || s.includes("ë¯¸ì‘ë‹µ")) return "gray";
  if (s.includes("ê±°ì ˆ")) return "red";

  return "gray";
}

// ------------------------------
// ì§€ë„ ì´ˆê¸°í™”
// ------------------------------
function initMap() {
  map = L.map('map').setView([37.5665, 126.9780], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  markerCluster = L.markerClusterGroup();
  map.addLayer(markerCluster);

  loadData();
}

// ------------------------------
// ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
// ------------------------------
async function loadData() {
  const res = await fetch(API_URL);
  const rows = await res.json();
  storeData = rows;

  populateCategoryFilter(rows);
  render(rows);
}

// ------------------------------
// ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ë§Œë“¤ê¸°
// ------------------------------
function populateCategoryFilter(rows) {
  const select = document.getElementById("categoryFilter");
  const categories = [...new Set(rows.map(r => r.category).filter(Boolean))];

  categories.forEach(cat => {
    const op = document.createElement("option");
    op.value = cat;
    op.textContent = cat;
    select.appendChild(op);
  });
}

// ------------------------------
// ëŒ€ì‹œë³´ë“œ KPI ì—…ë°ì´íŠ¸
// ------------------------------
function updateDashboard(rows) {
  let deal = 0, done = 0, request = 0, noAnswer = 0, deny = 0;

  rows.forEach(r => {
    const s = (r.status || "").toLowerCase();

    if (s.includes("ê±°ë˜ ì„±ì‚¬")) deal++;
    else if (s.includes("ë¯¸íŒ… ì™„ë£Œ")) done++;
    else if (s.includes("ë¯¸íŒ… ìš”ì²­")) request++;
    else if (s.includes("ë¶€ì¬ì¤‘") || s.includes("ë¯¸ì‘ë‹µ")) noAnswer++;
    else if (s.includes("ê±°ì ˆ")) deny++;
  });

  document.getElementById("stat-total").textContent = rows.length;
  document.getElementById("stat-deal").textContent = deal;
  document.getElementById("stat-done").textContent = done;
  document.getElementById("stat-request").textContent = request;
  document.getElementById("stat-noanswer").textContent = noAnswer;
  document.getElementById("stat-deny").textContent = deny;
}

// ------------------------------
// ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
// ------------------------------
function renderList(rows) {
  const box = document.getElementById("store-items");
  box.innerHTML = "";

  rows.forEach(r => {
    const color = getStatusColor(r.status);

    box.innerHTML += `
      <div class="store-item">
        <b>${r.name}</b>
        <span class="badge" style="background:${color};">${r.status || "ìƒíƒœ ì—†ìŒ"}</span><br>
        <small>${r.address || ""}</small>
      </div>
    `;
  });
}

// ------------------------------
// ì§€ë„ ë§ˆì»¤ ì¶œë ¥
// ------------------------------
function renderMarkers(rows) {
  markerCluster.clearLayers();

  rows.forEach(r => {
    if (!r.lat || !r.lng) return;

    const color = getStatusColor(r.status);

    const marker = L.circleMarker([r.lat, r.lng], {
      radius: 8,
      color: color,
      fillColor: color,
      fillOpacity: 0.9
    });

    marker.bindPopup(`<b>${r.name}</b><br>${r.address}<br>${r.status}`);

    markerCluster.addLayer(marker);
  });
}

// ------------------------------
// ê²€ìƒ‰ + í•„í„° í†µí•© ì²˜ë¦¬
// ------------------------------
function render(filtered) {
  updateDashboard(filtered);
  renderMarkers(filtered);
  renderList(filtered);
}

// ------------------------------
// í•„í„° ì´ë²¤íŠ¸
// ------------------------------
document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("categoryFilter").addEventListener("change", applyFilters);
document.getElementById("statusFilter").addEventListener("change", applyFilters);

function applyFilters() {
  const kw = document.getElementById("searchInput").value.trim();
  const cat = document.getElementById("categoryFilter").value;
  const status = document.getElementById("statusFilter").value;

  const filtered = storeData.filter(r => {
    const okKeyword = kw === "" ||
      (r.name && r.name.includes(kw)) ||
      (r.address && r.address.includes(kw));

    const okCat = cat === "" || (r.category === cat);

    const okStatus = status === "" || (r.status && r.status.includes(status));

    return okKeyword && okCat && okStatus;
  });

  render(filtered);
}

// ------------------------------
// ì‹œì‘
// ------------------------------
window.onload = initMap;
</script>

</body>
</html>
