<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sales Store Map Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Marker Cluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
  :root {
    --bg: #f4f6fb;
    --card-bg: #ffffff;
    --border: #e3e5ee;
    --text-main: #222;
    --text-sub: #666;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo",
      "ë§‘ì€ ê³ ë”•", system-ui, sans-serif;
    background: var(--bg);
    overflow: hidden;
  }

  /* ìƒë‹¨ í•„í„°ë°” */
  .top-bar {
    position: fixed;
    z-index: 1000;
    top: 0;
    left: 0;
    right: 0;
    padding: 8px 12px;
    display: flex;
    gap: 8px;
    background: #fff;
    border-bottom: 1px solid var(--border);
  }

  .top-bar input,
  .top-bar select {
    border-radius: 8px;
    border: 1px solid var(--border);
    padding: 8px 10px;
    font-size: 13px;
    outline: none;
  }

  .top-bar input {
    flex: 1.6;
  }

  .top-bar select {
    flex: 0.7;
  }

  /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
  .layout {
    display: flex;
    height: 100vh;
    padding-top: 52px; /* top-bar ë†’ì´ */
  }

  /* ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ */
  .sidebar {
    width: 340px;
    min-width: 260px;
    max-width: 420px;
    background: #fff;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 10px 0;
  }

  .sidebar-header {
    padding: 4px 16px 8px;
    font-size: 13px;
    color: var(--text-sub);
    border-bottom: 1px solid var(--border);
  }

  .store-item {
    padding: 10px 16px;
    border-bottom: 1px solid #f1f1f1;
    cursor: pointer;
  }

  .store-item:hover {
    background: #f5f7ff;
  }

  .store-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 2px;
  }

  .store-address {
    font-size: 12px;
    color: var(--text-sub);
    margin-bottom: 2px;
  }

  .store-meta {
    font-size: 11px;
    color: var(--text-sub);
  }

  .store-url {
    font-size: 11px;
    color: #2563eb;
    text-decoration: none;
  }

  /* ì§€ë„ */
  #map {
    flex: 1;
    height: 100%;
    position: relative;
  }

  /* ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ */
  .dashboard {
    width: 280px;
    background: #fff;
    border-left: 1px solid var(--border);
    padding: 10px 14px;
    overflow-y: auto;
    transition: width 0.25s ease, padding 0.25s ease;
  }

  .dashboard.hidden {
    width: 0;
    padding: 0;
    border-left: none;
  }

  .dash-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .dash-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 6px;
  }

  .dash-card {
    padding: 7px 9px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #edf2ff;
    font-size: 12px;
  }

  .dash-label {
    color: var(--text-sub);
    margin-bottom: 2px;
  }

  .dash-value {
    font-size: 14px;
    font-weight: 600;
  }

  /* ëŒ€ì‹œë³´ë“œ í† ê¸€ ë²„íŠ¼ */
  .toggle-btn {
    position: fixed;
    top: 60px;
    right: 290px;
    z-index: 1100;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #fff;
    cursor: pointer;
  }

  .dashboard.hidden + .toggle-btn {
    right: 10px;
  }

  /* ìƒíƒœ pill */
  .status-pill {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 999px;
    font-size: 11px;
    color: #fff;
  }

  .s-request { background: #facc15; }   /* ë¯¸íŒ… ìš”ì²­ (ë…¸ë‘) */
  .s-miss   { background: #9ca3af; }   /* ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ (íšŒìƒ‰) */
  .s-deny   { background: #ef4444; }   /* ê±°ì ˆ (ë¹¨ê°•) */
  .s-done   { background: #3b82f6; }   /* ë¯¸íŒ… ì™„ë£Œ (íŒŒë‘) */
  .s-win    { background: #22c55e; }   /* ê±°ë˜ ì„±ì‚¬ (ì´ˆë¡) */

  /* í•˜ë‹¨ ìƒì„¸ ë°”í…€ ì‹œíŠ¸ */
  .detail-panel {
    position: fixed;
    left: 340px;
    right: 280px;
    bottom: 0;
    background: #ffffff;
    border-top: 1px solid var(--border);
    box-shadow: 0 -4px 12px rgba(15, 23, 42, 0.15);
    padding: 10px 14px;
    font-size: 12px;
    max-height: 160px;
    transform: translateY(100%);
    transition: transform 0.25s ease;
    z-index: 1050;
  }

  .detail-panel.open {
    transform: translateY(0);
  }

  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }

  .detail-title {
    font-size: 14px;
    font-weight: 600;
  }

  .detail-close {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 16px;
  }

  .detail-row {
    margin-bottom: 2px;
  }

  .detail-label {
    color: var(--text-sub);
    margin-right: 4px;
  }

  /* ëª¨ë°”ì¼ ëŒ€ì‘ */
  @media (max-width: 1024px) {
    .layout {
      flex-direction: column;
    }
    .sidebar {
      width: 100%;
      max-width: 100%;
      height: 35vh;
      border-right: none;
      border-bottom: 1px solid var(--border);
    }
    #map {
      height: calc(65vh - 120px);
    }
    .dashboard {
      position: fixed;
      right: 0;
      top: 52px;
      bottom: 0;
      width: 260px;
      border-left: 1px solid var(--border);
      border-top: none;
    }
    .detail-panel {
      left: 0;
      right: 0;
    }
    .toggle-btn {
      top: 56px;
    }
  }
</style>
</head>
<body>

<!-- ìƒë‹¨ í•„í„° -->
<div class="top-bar">
  <input id="searchInput" placeholder="ë§¤ì¥ëª… / ì§€ë²ˆ / í‚¤ì›Œë“œ ê²€ìƒ‰" />
  <select id="categoryFilter">
    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
  </select>
  <select id="statusFilter">
    <option value="">ì „ì²´ ìƒíƒœ</option>
    <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
    <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
    <option value="ê±°ì ˆ">ê±°ì ˆ</option>
    <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
    <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
  </select>
</div>

<div class="layout">
  <!-- ì¢Œì¸¡ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</span>
      <span id="listCount" style="float:right;">0ê°œ</span>
    </div>
    <div id="storeList"></div>
  </div>

  <!-- ì§€ë„ -->
  <div id="map"></div>

  <!-- ìš°ì¸¡ ëŒ€ì‹œë³´ë“œ -->
  <div class="dashboard" id="dashboard">
    <div class="dash-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
    <div class="dash-grid">
      <div class="dash-card">
        <div class="dash-label">ì´ ë§¤ì¥ ìˆ˜</div>
        <div class="dash-value" id="dashTotal">0</div>
      </div>
      <div class="dash-card">
        <div class="dash-label">ê±°ë˜ ì„±ì‚¬</div>
        <div class="dash-value" id="dashWin">0</div>
      </div>
      <div class="dash-card">
        <div class="dash-label">ë¯¸íŒ… ì™„ë£Œ</div>
        <div class="dash-value" id="dashDone">0</div>
      </div>
      <div class="dash-card">
        <div class="dash-label">ë¯¸íŒ… ìš”ì²­</div>
        <div class="dash-value" id="dashRequest">0</div>
      </div>
      <div class="dash-card">
        <div class="dash-label">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</div>
        <div class="dash-value" id="dashMiss">0</div>
      </div>
      <div class="dash-card">
        <div class="dash-label">ê±°ì ˆ</div>
        <div class="dash-value" id="dashDeny">0</div>
      </div>
    </div>
  </div>

  <!-- í† ê¸€ ë²„íŠ¼ -->
  <button class="toggle-btn" id="dashToggleBtn" onclick="toggleDashboard()">ëŒ€ì‹œë³´ë“œ ì ‘ê¸°</button>
</div>

<!-- í•˜ë‹¨ ìƒì„¸ íŒ¨ë„ -->
<div class="detail-panel" id="detailPanel">
  <div class="detail-header">
    <div class="detail-title" id="detailTitle">ë§¤ì¥ ìƒì„¸ì •ë³´</div>
    <button class="detail-close" onclick="closeDetail()">&times;</button>
  </div>
  <div id="detailBody"></div>
</div>

<script>
  /********************************************************
   * 1. ìƒìˆ˜ ë° ìƒ‰ìƒ í…Œì´ë¸”
   ********************************************************/
  // âš ï¸ ì—¬ê¸°ë§Œ ë‘ì˜ë‹˜ WebApp URLë¡œ êµì²´
  const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjG-mfQqwp21pjDoZ8VMnnVnHvQgoeDhy8f9UjzRLE0D5Gs53CEuCJ1_EmXkbns7X28H1cZ6kxoME_EQ5_zztRsFEDfRBzlc_WTF4VNsHmPSfQ5_52TRri_zbF_PifgjBzWuoIQ2-5VBLaXyg_6g2JNsF3LAmAfG3xrr-udWMKueJlBl8Fz0ml1g1D1FQHdXvj5nL2ErLo5OtGJr6VsxPBlPvlt95V8K8EF0eyuO4_5CsfP4pvWHkf6LlCwgeuqs7mrKjHXoEwd5eZ0gPWwE9216B5XIGYVRBMnHDrnAQ3WgQEu_08&lib=MCTt9Ziml74IIgZ1LHRXuHrbiB0og-dIC";

  // ìƒíƒœ â†’ ìƒ‰ìƒ
  const STATUS_COLORS = {
    "ë¯¸íŒ… ìš”ì²­": "#facc15",
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#9ca3af",
    "ê±°ì ˆ": "#ef4444",
    "ë¯¸íŒ… ì™„ë£Œ": "#3b82f6",
    "ê±°ë˜ ì„±ì‚¬": "#22c55e"
  };

  // ìƒíƒœ â†’ pill í´ë˜ìŠ¤
  const STATUS_CLASS = {
    "ë¯¸íŒ… ìš”ì²­": "s-request",
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "s-miss",
    "ê±°ì ˆ": "s-deny",
    "ë¯¸íŒ… ì™„ë£Œ": "s-done",
    "ê±°ë˜ ì„±ì‚¬": "s-win"
  };

  /********************************************************
   * 2. ì§€ë„ ì´ˆê¸°í™”
   ********************************************************/
  const map = L.map("map").setView([37.56, 126.97], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  const markerCluster = L.markerClusterGroup({
    chunkedLoading: true,
    spiderfyOnMaxZoom: true
  });
  map.addLayer(markerCluster);

  let allData = [];
  let filteredData = [];
  let markerMap = new Map(); // name+address â†’ marker

  /********************************************************
   * 3. WebAppì—ì„œ ë°ì´í„° ë¡œë“œ
   ********************************************************/
  async function loadData() {
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      allData = json || [];
      buildCategoryFilter();
      renderAll();
    } catch (e) {
      console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)");
    }
  }

  loadData();

  /********************************************************
   * 4. ì¹´í…Œê³ ë¦¬ í•„í„°: ëŒ€ë¶„ë¥˜ë§Œ (ì˜ˆ: 'ìŒì‹ì >ì–‘ì‹' â†’ 'ìŒì‹ì ')
   ********************************************************/
  function getCategoryGroup(row) {
    const cat = row.category || "";
    if (!cat) return "";
    // 'ìŒì‹ì >ì–‘ì‹' í˜•íƒœë¼ë©´ ë§¨ ì•ë§Œ ì‚¬ìš©
    return cat.split(">")[0].trim();
  }

  function buildCategoryFilter() {
    const set = new Set();
    allData.forEach(r => {
      const g = getCategoryGroup(r);
      if (g) set.add(g);
    });

    const sel = document.getElementById("categoryFilter");
    [...set].sort().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  /********************************************************
   * 5. Status í‚¤ ìë™ ì¸ì‹ (ì˜ˆë°©ìš©)
   ********************************************************/
  function getStatus(row) {
    // ê¸°ë³¸: ì •í™•íˆ 'Status' í‚¤ ì‚¬ìš©
    if (row.Status !== undefined && row.Status !== null) return String(row.Status).trim();

    // í˜¹ì‹œë¼ë„ í‚¤ê°€ ë‹¤ë¥¸ ê²½ìš° ë°©ì–´ ì½”ë“œ
    const keys = Object.keys(row);
    const foundKey = keys.find(k =>
      k.toLowerCase().replace(/\s+/g, "") === "status"
    );
    if (foundKey) return String(row[foundKey]).trim();

    return "";
  }

  /********************************************************
   * 6. ë Œë”ë§ ì „ì²´ (ì§€ë„ + ë¦¬ìŠ¤íŠ¸ + ëŒ€ì‹œë³´ë“œ)
   ********************************************************/
  function renderAll() {
    const q = document.getElementById("searchInput").value.trim().toLowerCase();
    const cat = document.getElementById("categoryFilter").value;
    const statusFilter = document.getElementById("statusFilter").value;

    markerCluster.clearLayers();
    markerMap.clear();

    // í•„í„°ë§
    filteredData = allData.filter(row => {
      const name = (row.name || "").toLowerCase();
      const keyword = (row.keyword || "").toLowerCase();
      const addr = (row.roadAddress || "").toLowerCase();
      const categoryGroup = getCategoryGroup(row);
      const status = getStatus(row);

      if (q) {
        if (!name.includes(q) && !keyword.includes(q) && !addr.includes(q)) {
          return false;
        }
      }
      if (cat && categoryGroup !== cat) return false;
      if (statusFilter && status !== statusFilter) return false;
      return true;
    });

    renderList();
    renderMarkers();
    updateDashboard();
  }

  /********************************************************
   * 7. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì¢Œì¸¡)
   ********************************************************/
  function renderList() {
    const box = document.getElementById("storeList");
    box.innerHTML = "";
    const frag = document.createDocumentFragment();

    filteredData.forEach(row => {
      const status = getStatus(row);

      const div = document.createElement("div");
      div.className = "store-item";

      const catText = row.category || "";
      const callDate = row.Call_date || "";
      const manager = row["Manager(Call)"] || "";

      div.innerHTML = `
        <div class="store-title">${row.name || "ì´ë¦„ ì—†ìŒ"}</div>
        <div class="store-address">${row.roadAddress || ""}</div>
        <div class="store-meta">
          ${catText ? `ì¹´í…Œê³ ë¦¬: ${catText} Â· ` : ""}
          ${manager ? `ë‹´ë‹¹: ${manager} Â· ` : ""}
          ${callDate ? `ì½œì¼: ${callDate}` : ""}
        </div>
        <a class="store-url" href="${row.URL || "#"}" target="_blank">ë°”ë¡œê°€ê¸°</a>
      `;

      div.addEventListener("click", () => {
        focusStore(row);
      });

      frag.appendChild(div);
    });

    box.appendChild(frag);
    document.getElementById("listCount").textContent = filteredData.length + "ê°œ";
  }

  /********************************************************
   * 8. ë§ˆì»¤ ë Œë”ë§ + í´ëŸ¬ìŠ¤í„°
   ********************************************************/
  function renderMarkers() {
    filteredData.forEach(row => {
      const lat = parseFloat(row.lat);
      const lng = parseFloat(row.lng);
      if (!lat || !lng) return;

      const status = getStatus(row);
      const color = STATUS_COLORS[status] || "#6b7280";

      const icon = L.divIcon({
        html: `<div style="width:14px;height:14px;border-radius:50%;background:${color};border:2px solid #fff;"></div>`,
        className: ""
      });

      const marker = L.marker([lat, lng], { icon });

      marker.bindPopup(`
        <b>${row.name || "ë§¤ì¥"}</b><br/>
        ${row.roadAddress || ""}<br/>
        ${status ? `<span style="display:inline-block;margin-top:2px;padding:2px 6px;border-radius:10px;font-size:11px;color:#fff;background:${color};">${status}</span><br/>` : ""}
        ${row.URL ? `<a href="${row.URL}" target="_blank">ë°”ë¡œê°€ê¸°</a>` : ""}
      `);

      marker.on("click", () => openDetail(row));

      const key = (row.name || "") + "|" + (row.roadAddress || "");
      markerMap.set(key, marker);

      markerCluster.addLayer(marker);
    });

    if (filteredData.length > 0) {
      const first = filteredData[0];
      const lat = parseFloat(first.lat);
      const lng = parseFloat(first.lng);
      if (lat && lng) map.setView([lat, lng], 12);
    }
  }

  /********************************************************
   * 9. íŠ¹ì • ë§¤ì¥ í¬ì»¤ìŠ¤ (ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ)
   ********************************************************/
  function focusStore(row) {
    const lat = parseFloat(row.lat);
    const lng = parseFloat(row.lng);
    if (!lat || !lng) return;

    const key = (row.name || "") + "|" + (row.roadAddress || "");
    const marker = markerMap.get(key);

    map.setView([lat, lng], 16);
    if (marker) marker.openPopup();
    openDetail(row);
  }

  /********************************************************
   * 10. ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ (ìƒíƒœê°’ ì¹´ìš´íŠ¸)
   ********************************************************/
  function updateDashboard() {
    const total = filteredData.length;

    let win = 0, done = 0, req = 0, miss = 0, deny = 0;

    filteredData.forEach(r => {
      const s = getStatus(r);
      if (s === "ê±°ë˜ ì„±ì‚¬") win++;
      else if (s === "ë¯¸íŒ… ì™„ë£Œ") done++;
      else if (s === "ë¯¸íŒ… ìš”ì²­") req++;
      else if (s === "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ") miss++;
      else if (s === "ê±°ì ˆ") deny++;
    });

    document.getElementById("dashTotal").textContent = total;
    document.getElementById("dashWin").textContent = win;
    document.getElementById("dashDone").textContent = done;
    document.getElementById("dashRequest").textContent = req;
    document.getElementById("dashMiss").textContent = miss;
    document.getElementById("dashDeny").textContent = deny;
  }

  /********************************************************
   * 11. ìƒì„¸ íŒ¨ë„ (í•˜ë‹¨ ë°”í…€ì‹œíŠ¸)
   ********************************************************/
  function openDetail(row) {
    const panel = document.getElementById("detailPanel");
    const body = document.getElementById("detailBody");
    const title = document.getElementById("detailTitle");

    const status = getStatus(row);
    const statusClass = STATUS_CLASS[status] || "";
    const statusHtml = status
      ? `<span class="status-pill ${statusClass}">${status}</span>`
      : "";

    title.textContent = row.name || "ë§¤ì¥ ìƒì„¸ì •ë³´";

    body.innerHTML = `
      <div class="detail-row">
        ${statusHtml}
      </div>
      <div class="detail-row">
        <span class="detail-label">ì£¼ì†Œ</span>${row.roadAddress || ""}
      </div>
      <div class="detail-row">
        <span class="detail-label">ì¹´í…Œê³ ë¦¬</span>${row.category || ""}
      </div>
      <div class="detail-row">
        <span class="detail-label">ë‹´ë‹¹(Call)</span>${row["Manager(Call)"] || ""} 
        &nbsp; Â· &nbsp;
        <span class="detail-label">ë‹´ë‹¹(Sales)</span>${row["Manager(Sales)"] || ""}
      </div>
      <div class="detail-row">
        <span class="detail-label">ì½œì¼</span>${row.Call_date || ""} 
        &nbsp; Â· &nbsp;
        <span class="detail-label">ì™„ë£Œì¼</span>${row.Completed_Meeting_Date || ""}
      </div>
      <div class="detail-row">
        <span class="detail-label">ë¹„ê³ </span>${row.Notes || ""}
      </div>
      ${row.URL ? `<div class="detail-row"><a href="${row.URL}" target="_blank">ë„¤ì´ë²„ ë°”ë¡œê°€ê¸°</a></div>` : ""}
    `;

    panel.classList.add("open");
  }

  function closeDetail() {
    document.getElementById("detailPanel").classList.remove("open");
  }

  /********************************************************
   * 12. ëŒ€ì‹œë³´ë“œ í† ê¸€
   ********************************************************/
  function toggleDashboard() {
    const dash = document.getElementById("dashboard");
    const btn = document.getElementById("dashToggleBtn");
    dash.classList.toggle("hidden");
    btn.textContent = dash.classList.contains("hidden") ? "ëŒ€ì‹œë³´ë“œ ì—´ê¸°" : "ëŒ€ì‹œë³´ë“œ ì ‘ê¸°";
  }

  /********************************************************
   * 13. í•„í„° ì´ë²¤íŠ¸
   ********************************************************/
  document.getElementById("searchInput").addEventListener("input", () => {
    renderAll();
  });
  document.getElementById("categoryFilter").addEventListener("change", () => {
    renderAll();
  });
  document.getElementById("statusFilter").addEventListener("change", () => {
    renderAll();
  });
</script>
</body>
</html>
