<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Store Map Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
  body { margin:0; background:#f3f4f7; font-family: 'Pretendard', sans-serif; }
  .container { padding:20px; }

  #map { height: 70vh; width: 100%; border-radius: 10px; margin-top: 10px; }

  .filter-box {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  input, select {
    height: 42px;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 14px;
  }

  .dashboard {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin-left: 10px;
    width: 320px;
  }

  .stat-box {
    background: #fafafa;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
  }

  .store-list {
    margin-top: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
  }
</style>
</head>

<body>
<div class="container">

  <h2>ğŸ“ Sales Store Map Dashboard</h2>

  <div class="filter-box">
    <input id="searchInput" placeholder="ë§¤ì¥ëª… / ì§€ì—­ / í‚¤ì›Œë“œ ê²€ìƒ‰" />

    <select id="categorySelect"></select>

    <select id="statusSelect">
      <option value="ì „ì²´">ì „ì²´ ìƒíƒœ</option>
      <option value="ê±°ë˜ ì„±ì‚¬">ê±°ë˜ ì„±ì‚¬</option>
      <option value="ë¯¸íŒ… ì™„ë£Œ">ë¯¸íŒ… ì™„ë£Œ</option>
      <option value="ë¯¸íŒ… ìš”ì²­">ë¯¸íŒ… ìš”ì²­</option>
      <option value="ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ</option>
      <option value="ê±°ì ˆ">ê±°ì ˆ</option>
    </select>
  </div>

  <div style="display:flex;">
    <div style="flex:1;">
      <div id="map"></div>

      <div class="store-list" id="storeList"></div>
    </div>

    <div class="dashboard">
      <h3>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h3>
      <div id="dashboardContent"></div>
    </div>
  </div>

</div>

<script>
const API_URL =
 "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

// ìƒíƒœë³„ ìƒ‰ìƒ
const STATUS_COLOR = {
  "ê±°ë˜ ì„±ì‚¬": "#2ecc71",
  "ë¯¸íŒ… ì™„ë£Œ": "#3498db",
  "ë¯¸íŒ… ìš”ì²­": "#f1c40f",
  "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": "#7f8c8d",
  "ê±°ì ˆ": "#e74c3c"
};

// ì¹´í…Œê³ ë¦¬ ë§¤í•‘
const CATEGORY_MAP = {
  "í•œì‹": ["í•œì‹","ë°±ë°˜","êµ­ë°¥","ì°Œê°œ","í•´ì¥êµ­","í•œì •ì‹","ë³´ìŒˆ","ì¡±ë°œ"],
  "ì–‘ì‹": ["ì–‘ì‹","ìŠ¤í…Œì´í¬","íŒŒìŠ¤íƒ€","í”¼ì","ê·¸ë¦´","ë¦¬ì¡°ë˜"],
  "ì¼ì‹": ["ì¼ì‹","ì´ˆë°¥","ìŠ¤ì‹œ","ëˆì¹´ì¸ ","ë¼ë©˜","ìš°ë™"],
  "ì¤‘ì‹": ["ì¤‘ì‹","ì§œì¥","ì§¬ë½•","íƒ•ìˆ˜ìœ¡","ì¤‘í™”"],
  "ê³ ê¹ƒì§‘": ["ê³ ê¸°","ì‚¼ê²¹ì‚´","ê°ˆë¹„","êµ¬ì´","ê³±ì°½","ë§‰ì°½","í•œìš°"],
  "ìˆ ì§‘Â·ì£¼ì ": ["ìˆ ì§‘","ì£¼ì ","ìš”ë¦¬ì£¼ì ","í¬ì°¨","ì™€ì¸","í˜¸í”„"],
  "ì¹´í˜": ["ì¹´í˜","ì»¤í”¼","ë””ì €íŠ¸"],
  "ë² ì´ì»¤ë¦¬": ["ë² ì´ì»¤ë¦¬","ë¹µ","ì¼€ì´í¬","ì œê³¼"],
  "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ": ["í–„ë²„ê±°","íŒ¨ìŠ¤íŠ¸í‘¸ë“œ","ë²„ê±°","ì¹˜í‚¨"],
  "ë¶„ì‹": ["ë¶„ì‹","ë–¡ë³¶ì´","ê¹€ë°¥"],
  "ë¸ŒëŸ°ì¹˜": ["ë¸ŒëŸ°ì¹˜","ëª¨ë‹"],
  "ì„¸ê³„ìŒì‹": ["ë©•ì‹œì½”","ë‚¨ë¯¸","ë² íŠ¸ë‚¨","íƒœêµ­","ì•„ì‹œì•„","ì¸ë„"]
};

function mapCategory(raw) {
  raw = raw || "";
  for (const [big, list] of Object.entries(CATEGORY_MAP)) {
    if (list.some(w => raw.includes(w))) return big;
  }
  return "";
}

// ì§€ë„
let map = L.map("map").setView([37.55, 126.98], 11);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°
let markers = L.markerClusterGroup();
map.addLayer(markers);

let globalData = [];

async function loadData() {
  const res = await fetch(API_URL);
  globalData = await res.json();

  globalData.forEach(r => {
    r.bigCategory = mapCategory(r.category || "");
  });

  buildCategoryFilter();
  renderAll();
}

// ì¹´í…Œê³ ë¦¬ í•„í„° ìƒì„±
function buildCategoryFilter() {
  const select = document.getElementById("categorySelect");
  select.innerHTML = `<option value="ì „ì²´">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>`;

  Object.keys(CATEGORY_MAP).forEach(cat => {
    select.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
}

function renderAll() {
  const keyword = document.getElementById("searchInput").value.trim();
  const selCategory = document.getElementById("categorySelect").value;
  const selStatus = document.getElementById("statusSelect").value;

  let filtered = globalData.filter(r => {
    let ok = true;

    if (keyword) {
      ok &= (r.name.includes(keyword) || r.address.includes(keyword));
    }

    if (selCategory !== "ì „ì²´") {
      ok &= (r.bigCategory === selCategory);
    }

    if (selStatus !== "ì „ì²´") {
      ok &= (r.status === selStatus);
    }

    return ok;
  });

  renderMarkers(filtered);
  renderList(filtered);
  renderDashboard(filtered);
}

// ë§ˆì»¤ ë Œë”ë§
function renderMarkers(data) {
  markers.clearLayers();

  data.forEach(r => {
    if (!r.lat || !r.lng) return;

    const marker = L.circleMarker([r.lat, r.lng], {
      radius: 10,
      color: STATUS_COLOR[r.status] || "#555",
      fillColor: STATUS_COLOR[r.status] || "#555",
      fillOpacity: 0.9,
    }).bindPopup(`<b>${r.name}</b><br>${r.address}<br><a href="${r.url}" target="_blank">URL ì—´ê¸°</a>`);

    markers.addLayer(marker);
  });
}

// ë¦¬ìŠ¤íŠ¸
function renderList(data) {
  const box = document.getElementById("storeList");
  box.innerHTML = `<h3>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ (${data.length}ê°œ)</h3>`;

  data.forEach(r => {
    box.innerHTML += `
      <div style="padding:6px 0;">
        <b>${r.name}</b> (${r.bigCategory})
        <br><span style="color:#555;">${r.address}</span>
        <br><a href="${r.url}" target="_blank">URL ë³´ê¸°</a>
      </div>
      <hr />
    `;
  });
}

// ëŒ€ì‹œë³´ë“œ
function renderDashboard(data) {
  const total = data.length;

  const stat = {
    "ê±°ë˜ ì„±ì‚¬": 0,
    "ë¯¸íŒ… ì™„ë£Œ": 0,
    "ë¯¸íŒ… ìš”ì²­": 0,
    "ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ": 0,
    "ê±°ì ˆ": 0
  };

  data.forEach(r => {
    if (stat[r.status] !== undefined) stat[r.status]++;
  });

  const dash = document.getElementById("dashboardContent");
  dash.innerHTML = `
    <div class="stat-box">ì´ ë§¤ì¥ ìˆ˜ <h2>${total}</h2></div>
    <div class="stat-box">ê±°ë˜ ì„±ì‚¬ <h3>${stat["ê±°ë˜ ì„±ì‚¬"]}</h3></div>
    <div class="stat-box">ë¯¸íŒ… ì™„ë£Œ <h3>${stat["ë¯¸íŒ… ì™„ë£Œ"]}</h3></div>
    <div class="stat-box">ë¯¸íŒ… ìš”ì²­ <h3>${stat["ë¯¸íŒ… ìš”ì²­"]}</h3></div>
    <div class="stat-box">ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ <h3>${stat["ë¶€ì¬ì¤‘/ë¯¸ì‘ë‹µ"]}</h3></div>
    <div class="stat-box">ê±°ì ˆ <h3>${stat["ê±°ì ˆ"]}</h3></div>
  `;
}

document.getElementById("searchInput").addEventListener("input", renderAll);
document.getElementById("categorySelect").addEventListener("change", renderAll);
document.getElementById("statusSelect").addEventListener("change", renderAll);

loadData();
</script>

</body>
</html>
