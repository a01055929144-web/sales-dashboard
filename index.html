<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Store Map Dashboard</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #fafafa;
    }
    h2 {
      margin: 20px;
    }
    #map {
      width: 100%;
      height: 70vh;
    }
    #store-list {
      padding: 20px;
      font-size: 15px;
      line-height: 1.6;
    }
    .store-item {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>

  <h2>ğŸ“Œ Sales Store Map Dashboard</h2>

  <div id="map"></div>

  <div id="store-list">
    <b>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</b><br><br>
  </div>

  <script>
    // ğŸ”— Apps Script API URL (ì´ë¯¸ ë°°í¬ëœ URL ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    const API_URL =
      "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

    let map; // ì „ì—­ ì§€ë„ ê°ì²´

    // --------------------------------------------------
    // 1) ë„¤ì´ë²„ ì§€ë„ ì´ˆê¸°í™”
    // --------------------------------------------------
    function initMap() {
      map = new naver.maps.Map("map", {
        center: new naver.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì‹œì²­ ê·¼ì²˜
        zoom: 11
      });

      // ë°ì´í„° ë¡œë”©
      loadData();
    }

    // --------------------------------------------------
    // 2) Apps Scriptì—ì„œ JSON ê°€ì ¸ì˜¤ê¸°
    // --------------------------------------------------
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const rows = await res.json();

        console.log("ğŸ“¦ places ë°ì´í„°:", rows);

        if (!Array.isArray(rows)) {
          alert("API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
          return;
        }

        renderList(rows);
        renderMarkers(rows);

      } catch (err) {
        console.error("API ì—ëŸ¬:", err);
        alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!");
      }
    }

    // --------------------------------------------------
    // 3) ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // --------------------------------------------------
    function renderList(rows) {
      const box = document.getElementById("store-list");
      box.innerHTML = "<b>â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</b><br><br>";

      rows.forEach((r) => {
        const name = r.name || "ë§¤ì¥ëª… ì—†ìŒ";
        box.innerHTML += `
          <div class="store-item">
            ğŸ“ ${name}
          </div>
        `;
      });
    }

    // --------------------------------------------------
    // 4) ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
    // --------------------------------------------------
    function renderMarkers(rows) {
      rows.forEach((r) => {
        const lat = parseFloat(r.lat);
        const lng = parseFloat(r.lng);

        // lat/lngê°€ ìˆ«ìê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ
        if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

        const position = new naver.maps.LatLng(lat, lng);

        // ë§ˆì»¤
        new naver.maps.Marker({
          position,
          map
        });

        // ì¸í¬ìœˆë„ìš°
        const name = r.name || "ë§¤ì¥";
        const info = new naver.maps.InfoWindow({
          content: `<div style="padding:6px;font-size:12px;">${name}</div>`
        });

        // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í† ê¸€
        naver.maps.Event.addListener(
          map, 
          "idle",
          function () {
            // idleì—ì„œ ìë™ ì˜¤í”ˆ ê°™ì€ ê±´ ì•ˆ í•  ê±°ë¼ ë¹„ì›Œë‘ 
          }
        );

        naver.maps.Event.addListener(
          new naver.maps.Marker({ position, map }),
          "click",
          function () {
            info.open(map, this);
          }
        );
      });
    }
  </script>

  <!-- âœ… ë„¤ì´ë²„ ì§€ë„ JS SDK (Maps > Application ì˜ Client ID ì‚¬ìš©) -->
  <script
    src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=oci3g40oau">
  </script>

  <!-- í˜ì´ì§€ ë¡œë“œ í›„ ì§€ë„ ì´ˆê¸°í™” -->
  <script>
    window.onload = initMap;
  </script>

</body>
</html>
