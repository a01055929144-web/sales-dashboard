<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Store Map Dashboard</title>

  <!-- Leaflet ê¸°ë³¸ CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
        sans-serif;
      background: #f5f6fa;
      color: #222;
    }

    header {
      padding: 14px 20px 10px;
      border-bottom: 1px solid #e0e3ef;
      background: #ffffff;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span {
      font-size: 20px;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #main {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 10px 10px 12px;
      min-height: 0;
    }

    /* ì™¼ìª½: ì§€ë„ + ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
    #left-panel {
      flex: 2.2;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    #controls-card,
    #map-card,
    #list-card,
    #dashboard-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      border: 1px solid #e3e7f2;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #controls input,
    #controls select {
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid #d7dbe8;
      border-radius: 6px;
      background: #f9fafc;
      outline: none;
    }

    #controls input:focus,
    #controls select:focus {
      border-color: #4c6fff;
      background: #ffffff;
    }

    #searchInput {
      flex: 1 1 220px;
    }

    #categoryFilter,
    #statusFilter {
      flex: 0 0 150px;
    }

    #map {
      width: 100%;
      height: 52vh;
      border-radius: 8px;
    }

    #list-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }

    #list-subtitle {
      font-size: 11px;
      color: #888;
      margin-bottom: 8px;
    }

    #store-list {
      max-height: 26vh;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 13px;
    }

    .store-item {
      margin-bottom: 4px;
      cursor: pointer;
      padding: 4px 4px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .store-item:hover {
      background: #f0f3ff;
    }

    .store-main-line {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .store-name {
      font-weight: 500;
    }

    .store-sub-line {
      font-size: 11px;
      color: #666;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 3px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 6px;
      font-size: 10px;
      border-radius: 999px;
      background: #eef1ff;
      color: #3c4b8f;
      margin-left: 4px;
      border: 1px solid #dde1ff;
    }

    .badge-status {
      background: #ffe8e8;
      color: #9b3030;
      border-color: #ffd2d2;
    }

    .badge-category {
      background: #e4f3ff;
      color: #1b4a7a;
      border-color: #cfe5ff;
    }

    /* ì˜¤ë¥¸ìª½: ëŒ€ì‹œë³´ë“œ ì˜ì—­ */
    #right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 260px;
    }

    #dashboard-header {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .kpi-card {
      border-radius: 8px;
      padding: 8px 10px;
      background: #f7f8ff;
      border: 1px solid #e0e4ff;
      font-size: 12px;
    }

    .kpi-label {
      color: #666;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .kpi-value {
      font-size: 16px;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 11px;
      color: #999;
    }

    .legend {
      margin-top: 6px;
      font-size: 11px;
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid #ccc;
    }

    .bar-list {
      margin-top: 8px;
      font-size: 11px;
    }

    .bar-row {
      margin-bottom: 6px;
    }

    .bar-label-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .bar-track {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #f0f1f7;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #4c6fff, #8f5cff);
    }

    @media (max-width: 960px) {
      #main {
        flex-direction: column;
      }
      #right-panel {
        min-width: 0;
      }
      #map {
        height: 45vh;
      }
      #store-list {
        max-height: 22vh;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <header>
      <h1>
        <span>ğŸ“</span> Sales Store Map Dashboard
      </h1>
    </header>

    <div id="main">
      <!-- ì™¼ìª½ íŒ¨ë„: ê²€ìƒ‰/ì§€ë„/ë¦¬ìŠ¤íŠ¸ -->
      <div id="left-panel">
        <div id="controls-card">
          <div id="controls">
            <input
              type="text"
              id="searchInput"
              placeholder="ë§¤ì¥ëª… / ì§€ì—­ / í‚¤ì›Œë“œ ê²€ìƒ‰"
            />
            <select id="categoryFilter">
              <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            </select>
            <select id="statusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
            </select>
          </div>
        </div>

        <div id="map-card">
          <div id="map"></div>
        </div>

        <div id="list-card">
          <div id="list-title">â­ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸</div>
          <div id="list-subtitle"></div>
          <div id="store-list"></div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: ëŒ€ì‹œë³´ë“œ -->
      <div id="right-panel">
        <div id="dashboard-card">
          <div id="dashboard-header">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>

          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">í˜„ì¬ í•„í„° ê¸°ì¤€ ë§¤ì¥ ìˆ˜</div>
              <div class="kpi-value" id="stat-total">-</div>
              <div class="kpi-sub" id="stat-total-sub">ì „ì²´ -ê°œ ì¤‘ -ê°œ</div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">ê±°ë˜ / ë¯¸íŒ… ì§„í–‰</div>
              <div class="kpi-value" id="stat-active">-</div>
              <div class="kpi-sub" id="stat-active-sub">ê±°ë˜ / ë¯¸íŒ… ì˜ˆì • / ì™„ë£Œ</div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">ê±°ì ˆ / ë³´ë¥˜</div>
              <div class="kpi-value" id="stat-deny">-</div>
              <div class="kpi-sub" id="stat-deny-sub">ê±°ì ˆ Â· ë³´ë¥˜ ë¹„ì¤‘</div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">ì‹ ê·œ/ë¯¸ì²˜ë¦¬</div>
              <div class="kpi-value" id="stat-new">-</div>
              <div class="kpi-sub" id="stat-new-sub">ìƒíƒœê°’ ì—†ëŠ” ë§¤ì¥</div>
            </div>
          </div>

          <div class="legend">
            <div style="font-weight:600; margin-bottom:4px;">ë§ˆì»¤ ìƒ‰ìƒ (ìƒíƒœ)</div>
            <div class="legend-row">
              <div class="legend-color" style="background:#2ecc71;"></div> ê±°ë˜ / ê±°ë˜ì„±ì‚¬
            </div>
            <div class="legend-row">
              <div class="legend-color" style="background:#3498db;"></div> ë¯¸íŒ… ì™„ë£Œ
            </div>
            <div class="legend-row">
              <div class="legend-color" style="background:#e67e22;"></div> ë¯¸íŒ… ì˜ˆì • / ì½œë°±
            </div>
            <div class="legend-row">
              <div class="legend-color" style="background:#e74c3c;"></div> ê±°ì ˆ / ì¤‘ë‹¨
            </div>
            <div class="legend-row">
              <div class="legend-color" style="background:#7f8c8d;"></div> ê¸°íƒ€ / ë¯¸ì •
            </div>
          </div>

          <div class="bar-list" id="category-bars">
            <!-- ì¹´í…Œê³ ë¦¬ ë¶„í¬ ë§‰ëŒ€ ê·¸ë˜í”„ ë“¤ì–´ê°€ëŠ” ìë¦¬ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // â­ Apps Script API URL (ë‘ì˜ë‹˜ ê²ƒ)
    const API_URL =
      "https://script.google.com/macros/s/AKfycbyLPa-oF57-XqHkz3Lkz9KZ0PzHQxhEIcQKkSXJErEPC5rm090eUvCLzr0KUDjP_QHK/exec?action=places";

    let map;
    let allRows = [];
    let markersLayer;

    // ìƒ‰ìƒë³„ ë§ˆì»¤ ì•„ì´ì½˜ ì„¸íŒ… (ì™¸ë¶€ ê³µìš© ë¦¬ì†ŒìŠ¤ ì‚¬ìš©)
    const iconBase =
      "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/";
    const iconShadow =
      "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png";

    const markerIcons = {
      blue: L.icon({
        iconUrl: iconBase + "marker-icon-2x-blue.png",
        shadowUrl: iconShadow,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
      green: L.icon({
        iconUrl: iconBase + "marker-icon-2x-green.png",
        shadowUrl: iconShadow,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
      orange: L.icon({
        iconUrl: iconBase + "marker-icon-2x-orange.png",
        shadowUrl: iconShadow,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
      red: L.icon({
        iconUrl: iconBase + "marker-icon-2x-red.png",
        shadowUrl: iconShadow,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
      gray: L.icon({
        iconUrl: iconBase + "marker-icon-2x-grey.png",
        shadowUrl: iconShadow,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
      violet: L.icon({
        iconUrl: iconBase + "marker-icon-2x-violet.png",
        shadowUrl: iconShadow,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      }),
    };

    // ìƒíƒœê°’ â†’ ìƒ‰ìƒ ë§¤í•‘
    function getStatusColor(statusRaw) {
      if (!statusRaw) return "gray";
      const s = statusRaw.toString().toLowerCase();

      if (s.includes("ê±°ë˜")) return "green";
      if (s.includes("ì™„ë£Œ")) return "blue"; // ë¯¸íŒ… ì™„ë£Œ
      if (s.includes("ë¯¸íŒ…") || s.includes("ì½œë°±") || s.includes("ì˜ˆì •"))
        return "orange";
      if (s.includes("ê±°ì ˆ") || s.includes("ì¤‘ë‹¨") || s.includes("í¬ê¸°"))
        return "red";

      return "gray";
    }

    function getStatus(r) {
      return r.Status || r.status || r.ìƒíƒœ || "";
    }

    // ì¹´í…Œê³ ë¦¬ ìë™ ê·¸ë£¹í™”
    function getCategory(r) {
      const raw =
        r.category ||
        r.Category ||
        r.ì¹´í…Œê³ ë¦¬ ||
        r.keyword ||
        r.keywordorAddress ||
        r.keywordOrAddress ||
        r.type ||
        r.ì—…ì¢… ||
        "";

      const text = raw.toString().toLowerCase();

      if (
        text.includes("í•œì‹") ||
        text.includes("ë°±ë°˜") ||
        text.includes("êµ­ë°¥") ||
        text.includes("ë¶„ì‹")
      )
        return "í•œì‹";
      if (
        text.includes("ì–‘ì‹") ||
        text.includes("í”¼ì") ||
        text.includes("íŒŒìŠ¤íƒ€") ||
        text.includes("ìŠ¤í…Œì´í¬")
      )
        return "ì–‘ì‹";
      if (text.includes("ì¤‘ì‹") || text.includes("ì¤‘êµ­")) return "ì¤‘ì‹";
      if (
        text.includes("ì¼ì‹") ||
        text.includes("ì´ˆë°¥") ||
        text.includes("ìŠ¤ì‹œ") ||
        text.includes("ë¼ë©˜")
      )
        return "ì¼ì‹";
      if (
        text.includes("ê³ ê¸°") ||
        text.includes("ê³ ê¹ƒì§‘") ||
        text.includes("ì‚¼ê²¹") ||
        text.includes("ì •ìœ¡")
      )
        return "ê³ ê¹ƒì§‘";
      if (
        text.includes("ë²„ê±°") ||
        text.includes("í–„ë²„ê±°") ||
        text.includes("íŒ¨ìŠ¤íŠ¸í‘¸ë“œ")
      )
        return "í–„ë²„ê±°/íŒ¨ìŠ¤íŠ¸í‘¸ë“œ";
      if (
        text.includes("ì¹´í˜") ||
        text.includes("ì»¤í”¼") ||
        text.includes("coffe")
      )
        return "ì¹´í˜";
      if (
        text.includes("ë² ì´ì»¤ë¦¬") ||
        text.includes("ë¹µ") ||
        text.includes("bakery")
      )
        return "ë² ì´ì»¤ë¦¬";

      if (!raw) return "";
      return "ê¸°íƒ€";
    }

    function getUrl(r) {
      return r.URL || r.Url || r.url || r.link || "";
    }

    function getSigungu(r) {
      return r.sigungu || r.ì£¼ì†Œ || r.address || "";
    }

    // ì§€ë„ ì´ˆê¸° ì„¸íŒ…
    map = L.map("map").setView([37.5665, 126.978], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    markersLayer = L.markerClusterGroup();
    map.addLayer(markersLayer);

    // ë°ì´í„° ë¡œë“œ
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const rows = await res.json();

        allRows = rows.map((r, idx) => ({
          ...r,
          _id: idx,
        }));

        console.log("ğŸ“Œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:", allRows);

        buildFilters(allRows);
        applyFilters();
      } catch (e) {
        console.error("API ì˜¤ë¥˜:", e);
        alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!");
      }
    }

    // í•„í„° ì˜µì…˜ êµ¬ì„±
    function buildFilters(rows) {
      const categorySet = new Set();
      const statusSet = new Set();

      rows.forEach((r) => {
        const cat = getCategory(r);
        const status = getStatus(r);
        if (cat) categorySet.add(cat);
        if (status) statusSet.add(status);
      });

      const categoryFilter = document.getElementById("categoryFilter");
      const statusFilter = document.getElementById("statusFilter");

      [...categorySet]
        .sort()
        .forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          categoryFilter.appendChild(opt);
        });

      [...statusSet]
        .sort()
        .forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          statusFilter.appendChild(opt);
        });

      document
        .getElementById("searchInput")
        .addEventListener("input", applyFilters);
      categoryFilter.addEventListener("change", applyFilters);
      statusFilter.addEventListener("change", applyFilters);
    }

    // í•„í„° ì ìš©
    function applyFilters() {
      const searchText = document
        .getElementById("searchInput")
        .value.toLowerCase()
        .trim();
      const catFilter = document.getElementById("categoryFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;

      const filtered = allRows.filter((r) => {
        const name = (r.name || "").toLowerCase();
        const sigungu = getSigungu(r).toLowerCase();
        const vendor = (r.Vender || r.vendor || "").toLowerCase();
        const cat = getCategory(r);
        const status = getStatus(r);

        // ê²€ìƒ‰ í•„í„°
        if (searchText) {
          const combined = `${name} ${sigungu} ${vendor} ${(cat || "").toLowerCase()}`;
          if (!combined.includes(searchText)) return false;
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„°
        if (catFilter && cat !== catFilter) return false;

        // ìƒíƒœ í•„í„°
        if (statusFilter && status !== statusFilter) return false;

        return true;
      });

      renderList(filtered);
      renderMarkers(filtered);
      updateDashboard(filtered);
    }

    // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderList(rows) {
      const box = document.getElementById("store-list");
      const sub = document.getElementById("list-subtitle");

      box.innerHTML = "";
      sub.textContent = `í˜„ì¬ í•„í„° ê¸°ì¤€ ${rows.length.toLocaleString()}ê°œ ë§¤ì¥`;

      rows.forEach((r) => {
        const name = r.name || "ë§¤ì¥ëª… ì—†ìŒ";
        const cat = getCategory(r);
        const status = getStatus(r);
        const sigungu = getSigungu(r);
        const vendor = r.Vender || r.vendor || "";

        const color = getStatusColor(status);

        const item = document.createElement("div");
        item.className = "store-item";
        item.dataset.id = r._id;

        const mainLine = document.createElement("div");
        mainLine.className = "store-main-line";

        const dot = document.createElement("span");
        dot.className = "status-dot";
        dot.style.background =
          color === "green"
            ? "#2ecc71"
            : color === "blue"
            ? "#3498db"
            : color === "orange"
            ? "#e67e22"
            : color === "red"
            ? "#e74c3c"
            : "#7f8c8d";

        const nameSpan = document.createElement("span");
        nameSpan.className = "store-name";
        nameSpan.textContent = name;

        mainLine.appendChild(dot);
        mainLine.appendChild(nameSpan);

        if (cat) {
          const bCat = document.createElement("span");
          bCat.className = "badge badge-category";
          bCat.textContent = cat;
          mainLine.appendChild(bCat);
        }
        if (status) {
          const bStatus = document.createElement("span");
          bStatus.className = "badge badge-status";
          bStatus.textContent = status;
          mainLine.appendChild(bStatus);
        }

        const subLine = document.createElement("div");
        subLine.className = "store-sub-line";

        if (sigungu) subLine.innerHTML += `<span>${sigungu}</span>`;
        if (vendor) subLine.innerHTML += `<span>ê³µê¸‰ì‚¬: ${vendor}</span>`;

        item.appendChild(mainLine);
        item.appendChild(subLine);

        item.addEventListener("click", () => {
          const marker = r._marker;
          if (marker) {
            map.setView(marker.getLatLng(), 16);
            marker.openPopup();
          }
        });

        box.appendChild(item);
      });
    }

    // ë§ˆì»¤ ë Œë”ë§
    function renderMarkers(rows) {
      markersLayer.clearLayers();

      rows.forEach((r) => {
        const lat = Number(r.lat);
        const lng = Number(r.lng);
        if (isNaN(lat) || isNaN(lng)) return;

        const name = r.name || "ë§¤ì¥";
        const cat = getCategory(r);
        const status = getStatus(r);
        const sigungu = getSigungu(r);
        const url = getUrl(r);

        const colorKey = getStatusColor(status);
        const icon = markerIcons[colorKey] || markerIcons.gray;

        const marker = L.marker([lat, lng], { icon });

        let popupHtml = `<div style="font-size:13px;">
          <b>${name}</b><br/>`;
        if (sigungu) popupHtml += `${sigungu}<br/>`;
        if (cat) popupHtml += `ì¹´í…Œê³ ë¦¬: ${cat}<br/>`;
        if (status) popupHtml += `ìƒíƒœ: ${status}<br/>`;
        if (url) {
          const safeUrl = url.startsWith("http") ? url : "https://" + url;
          popupHtml += `<a href="${safeUrl}" target="_blank" style="color:#3366ff;">ìƒì„¸ ë§í¬ ì—´ê¸°</a>`;
        }
        popupHtml += `</div>`;

        marker.bindPopup(popupHtml);
        r._marker = marker;

        markersLayer.addLayer(marker);
      });
    }

    // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    function updateDashboard(rows) {
      const totalAll = allRows.length;
      const totalFiltered = rows.length;

      const statuses = {
        deal: 0,
        meeting: 0,
        done: 0,
        deny: 0,
        other: 0,
      };

      const categoryCount = {};

      rows.forEach((r) => {
        const status = getStatus(r) || "";
        const sLower = status.toString().toLowerCase();
        const cat = getCategory(r) || "ê¸°íƒ€";

        if (sLower.includes("ê±°ë˜")) statuses.deal++;
        else if (sLower.includes("ì™„ë£Œ")) statuses.done++;
        else if (sLower.includes("ë¯¸íŒ…") || sLower.includes("ì˜ˆì •"))
          statuses.meeting++;
        else if (sLower.includes("ê±°ì ˆ") || sLower.includes("ì¤‘ë‹¨"))
          statuses.deny++;
        else statuses.other++;

        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
      });

      // KPI ê°’
      document.getElementById("stat-total").textContent =
        totalFiltered.toLocaleString();
      document.getElementById(
        "stat-total-sub"
      ).textContent = `ì „ì²´ ${totalAll.toLocaleString()}ê°œ ì¤‘ ${totalFiltered.toLocaleString()}ê°œ í‘œì‹œ`;

      const active = statuses.deal + statuses.meeting + statuses.done;
      document.getElementById("stat-active").textContent =
        active.toLocaleString();
      const activeRate =
        totalFiltered > 0 ? Math.round((active / totalFiltered) * 100) : 0;
      document.getElementById(
        "stat-active-sub"
      ).textContent = `ì§„í–‰ë¥  ì•½ ${activeRate}%`;

      const deny = statuses.deny;
      document.getElementById("stat-deny").textContent = deny.toLocaleString();
      const denyRate =
        totalFiltered > 0 ? Math.round((deny / totalFiltered) * 100) : 0;
      document.getElementById(
        "stat-deny-sub"
      ).textContent = `ê±°ì ˆ/ë³´ë¥˜ ë¹„ì¤‘ ì•½ ${denyRate}%`;

      const newOther = statuses.other;
      document.getElementById("stat-new").textContent =
        newOther.toLocaleString();
      const newRate =
        totalFiltered > 0 ? Math.round((newOther / totalFiltered) * 100) : 0;
      document.getElementById(
        "stat-new-sub"
      ).textContent = `ë¯¸ì • ìƒíƒœ ë¹„ì¤‘ ì•½ ${newRate}%`;

      // ì¹´í…Œê³ ë¦¬ ë°”
      const barBox = document.getElementById("category-bars");
      barBox.innerHTML = "";
      const entries = Object.entries(categoryCount).sort(
        (a, b) => b[1] - a[1]
      );
      if (entries.length) {
        const title = document.createElement("div");
        title.style.marginBottom = "4px";
        title.style.fontWeight = "600";
        title.textContent = "ì¹´í…Œê³ ë¦¬ ë¶„í¬";
        barBox.appendChild(title);

        entries.forEach(([cat, count]) => {
          const row = document.createElement("div");
          row.className = "bar-row";

          const labelLine = document.createElement("div");
          labelLine.className = "bar-label-line";
          const left = document.createElement("span");
          left.textContent = cat;
          const right = document.createElement("span");
          right.textContent = `${count.toLocaleString()}ê°œ`;
          labelLine.appendChild(left);
          labelLine.appendChild(right);

          const track = document.createElement("div");
          track.className = "bar-track";
          const fill = document.createElement("div");
          fill.className = "bar-fill";
          const pct =
            totalFiltered > 0 ? (count / totalFiltered) * 100 : 0;
          fill.style.width = `${pct}%`;
          track.appendChild(fill);

          row.appendChild(labelLine);
          row.appendChild(track);
          barBox.appendChild(row);
        });
      }
    }

    // ì‹œì‘
    loadData();
  </script>
</body>
</html>
